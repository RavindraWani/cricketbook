<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7X5LQ6WESD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-7X5LQ6WESD');
</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Browse all cricket matches - view live scores, recent results, and match history. Access ongoing games and completed tournaments from your cricket community.">
  <title>All Cricket Matches - Live Scores & Results | CricketBook</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 18px;
      color: #1f2937;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .matches-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    @media (max-width: 768px) {
      .matches-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .header {
      text-align: center;
      margin-bottom: 16px;
      color: white;
    }
    
    .header h1 {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 4px;
    }
    
    .header p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .section {
      margin-bottom: 16px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: white;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .card {
      background: #ffffff;
      border: 1px solid rgba(148,163,184,.2);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,.12), 0 2px 8px rgba(0,0,0,.08);
      margin-bottom: 10px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 50px rgba(0,0,0,.15), 0 4px 12px rgba(0,0,0,.1);
    }
    
    .ongoing-card {
      background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
      color: white;
      border: none;
    }
    
    .ongoing-card .match-title {
      color: white;
    }
    
    .ongoing-card .match-score {
      color: rgba(255,255,255,0.95);
    }
    
    .ongoing-badge {
      display: inline-block;
      background: rgba(255,255,255,0.3);
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 6px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .match-title {
      font-size: 17px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 8px;
    }
    
    .match-score {
      font-size: 14px;
      color: #4b5563;
      margin-bottom: 10px;
      line-height: 1.6;
    }
    
    .match-meta {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 10px;
    }
    
    .btn {
      display: inline-block;
      padding: 8px 16px;
      background: #8b5cf6;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .btn:hover {
      background: #7c3aed;
      transform: scale(1.05);
    }
    
    .btn-primary {
      background: white;
      color: #10b981;
    }
    
    .btn-primary:hover {
      background: rgba(255,255,255,0.9);
      color: #059669;
    }
    
    .loading {
      text-align: center;
      color: white;
      font-size: 18px;
      padding: 40px;
    }
    
    .empty-state {
      background: white;
      border-radius: 16px;
      padding: 40px 20px;
      text-align: center;
      color: #6b7280;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }
    
    .error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      margin-top: 20px;
    }
    
    /* Navigation */
    .nav {
      text-align: center;
      margin-bottom: 15px;
      padding: 0 5px;
    }
    
    .nav a {
      display: inline-block;
      color: white;
      text-decoration: none;
      padding: 8px 14px;
      margin: 3px 3px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .nav a:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-1px);
    }
    
    .nav a.active {
      background: rgba(255, 255, 255, 0.3);
    }
    
    @media (max-width: 768px) {
      .nav {
        margin-bottom: 12px;
        padding: 0 2px;
      }
      .nav a {
        padding: 6px 8px;
        margin: 2px 1px;
        font-size: 10.5px;
      }
    }
    
    @media (max-width: 400px) {
      .nav a {
        padding: 6px 6px;
        margin: 2px 1px;
        font-size: 10px;
      }
    }
    
    .new-match-btn {
      background: #10b981;
      width: 100%;
      text-align: center;
      margin-top: 12px;
      display: block;
      padding: 10px 16px;
    }
    
    .new-match-btn:hover {
      background: #059669;
    }
    
    .export-btn {
      background: #10b981;
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      margin-top: 12px;
    }
    
    .export-btn:hover {
      background: #059669;
      transform: scale(1.05);
    }
    
    /* Points Table Styling */
    .points-table-container {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,.12), 0 2px 8px rgba(0,0,0,.08);
      overflow-x: auto;
    }
    
    .points-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .points-table thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .points-table th {
      padding: 12px 8px;
      text-align: center;
      font-weight: 700;
      font-size: 13px;
      white-space: nowrap;
    }
    
    .points-table th:first-child {
      text-align: left;
      padding-left: 16px;
    }
    
    .points-table td {
      padding: 14px 8px;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .points-table td:first-child {
      text-align: left;
      font-weight: 600;
      padding-left: 16px;
      color: #1f2937;
    }
    
    .points-table tbody tr:hover {
      background: #f9fafb;
    }
    
    .points-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .rank-cell {
      font-weight: 700;
      color: #8b5cf6;
      font-size: 15px;
    }
    
    .nrr-positive {
      color: #10b981;
      font-weight: 600;
    }
    
    .nrr-negative {
      color: #ef4444;
      font-weight: 600;
    }
    
    .points-cell {
      font-weight: 700;
      color: #667eea;
      font-size: 16px;
    }
    
    .nrr-breakdown {
      display: none;
      background: #f9fafb;
      font-size: 12px;
      line-height: 1.6;
    }
    
    .nrr-breakdown.show {
      display: table-row;
    }
    
    .nrr-breakdown td {
      padding: 16px !important;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .nrr-formula {
      background: white;
      padding: 12px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      margin-top: 8px;
    }
    
    .nrr-formula-title {
      font-weight: 700;
      color: #667eea;
      margin-bottom: 8px;
      font-size: 13px;
    }
    
    .nrr-calc-step {
      margin: 6px 0;
      color: #4b5563;
    }
    
    .nrr-calc-step strong {
      color: #1f2937;
    }
    
    .toggle-nrr {
      cursor: pointer;
      color: #667eea;
      font-size: 11px;
      margin-left: 6px;
      text-decoration: none;
      font-weight: 600;
      user-select: none;
    }
    
    .toggle-nrr:hover {
      color: #764ba2;
      text-decoration: underline;
    }
    
    @media (max-width: 768px) {
      .points-table {
        font-size: 12px;
      }
      
      .points-table th,
      .points-table td {
        padding: 10px 6px;
      }
      
      .points-table th:first-child,
      .points-table td:first-child {
        padding-left: 10px;
      }
      
      .points-table th {
        font-size: 11px;
      }
      
      .nrr-breakdown {
        font-size: 11px;
      }
      
      .nrr-formula {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Navigation -->
    <nav class="nav">
      <a href="index.html">üè† Home</a>
      <a href="livescore.html">üì∫ Live Score</a>
      <a href="matches.html" class="active">üìã Matches</a>
      <a href="about.html">‚ÑπÔ∏è About</a>
    </nav>
    
    <div class="header">
      <h1>üèè CricketBook</h1>
      <p>All Matches</p>
    </div>
    
    <div class="loading" id="loading">Loading matches...</div>
    
    <div id="content" style="display:none">
      <!-- Points Table Section (League Matches Only) -->
      <div id="pointsTableSection" class="section" style="display:none">
        <div class="section-title">
          üèÜ League Standings
        </div>
        <div class="points-table-container">
          <table class="points-table">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Team</th>
                <th title="Matches Played">M</th>
                <th title="Wins">W</th>
                <th title="Losses">L</th>
                <th title="No Result">NR</th>
                <th title="Net Run Rate">NRR</th>
                <th title="Points">Pts</th>
              </tr>
            </thead>
            <tbody id="pointsTableBody">
              <!-- Points table rows will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Ongoing Match Section -->
      <div id="ongoingSection" class="section" style="display:none">
        <div class="section-title">
          ‚ö° Live Match
        </div>
        <div id="ongoingMatch"></div>
      </div>
      
      <!-- Recent Matches Section -->
      <div id="recentSection" class="section">
        <div class="section-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>üìã Recent Matches</span>
          <a id="exportCsvBtn" href="javascript:void(0);" onclick="exportToCSV()" style="display:none;color:white;text-decoration:none;font-size:13px;opacity:0.9;font-weight:400;">
            Export CSV ‚Üí
          </a>
        </div>
        <div id="recentMatches" class="matches-grid"></div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAFfwgHq761oFMg4CVqmZezGR_WK6ZGvAY",
      authDomain: "cricketbook-35725.firebaseapp.com",
      databaseURL: "https://cricketbook-35725-default-rtdb.firebaseio.com",
      projectId: "cricketbook-35725",
      storageBucket: "cricketbook-35725.firebasestorage.app",
      messagingSenderId: "128747950424",
      appId: "1:128747950424:web:dce02e8420c353f1acd52d"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Global variable to store matches for export
    let allMatchesData = [];
    let pollingInterval = null; // For polling instead of continuous listener
    let openNRRBreakdowns = new Set(); // Track which NRR breakdowns are open
    let lastActivityTime = Date.now(); // Track last user activity
    let isPollingPaused = false; // Track if polling is paused

    // Check if org parameter is in URL (from share link)
    const urlParams = new URLSearchParams(window.location.search);
    const urlOrgId = urlParams.get('org');
    
    // Organization ID for multi-user isolation
    let organizationId = localStorage.getItem('cricketbook_org_id');
    
    if (urlOrgId) {
      // Share link with org ID - save it to localStorage
      organizationId = urlOrgId;
      localStorage.setItem('cricketbook_org_id', organizationId);
      console.log('üîó Using Organization ID from URL and saved to localStorage:', organizationId);
    }
    
    if (!organizationId) {
      // No org ID - show helpful message
      console.warn('‚ö†Ô∏è No Organization ID found. Please start a match first.');
      document.getElementById('loading').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üèè</div><div style="font-size:18px;font-weight:600;margin-bottom:12px;color:#1f2937;">Welcome to CricketBook!</div><div style="color:#6b7280;margin-bottom:16px;">Start your first match to see all your matches here.</div><a href="index.html" class="btn new-match-btn" style="max-width:300px;margin:0 auto;">üè† Go to Home & Start Match</a></div>';
      document.getElementById('loading').style.display = 'block';
      document.getElementById('content').style.display = 'none';
    } else {
      console.log('‚úÖ Using Organization ID:', organizationId);
      
      // Load all matches with real-time sync (filtered by organization)
      loadMatches();
    }
    
    function loadMatches() {
      const matchesRef = database.ref('organizations/' + organizationId + '/matches');
    
    // Use polling instead of continuous listener to reduce active connections
    const pollMatches = () => {
      matchesRef.once('value', (snapshot) => {
      const allMatches = snapshot.val();
      
      console.log('üìä Loaded matches from Firebase for org ' + organizationId + ':', allMatches); // Debug log
      
      if (!allMatches) {
        document.getElementById('loading').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üèè</div><div style="font-size:18px;font-weight:600;margin-bottom:12px;color:#1f2937;">No Matches Yet</div><div style="color:#6b7280;margin-bottom:16px;">Start your first match to see it here!</div><a href="index.html" style="background:#8b5cf6;color:white;padding:10px 24px;border-radius:10px;text-decoration:none;display:inline-block;font-weight:600;">üè† Go to Home & Start Scoring</a></div>';
        document.getElementById('loading').style.display = 'block';
        document.getElementById('content').style.display = 'none';
        return;
      }
      
      // Convert to array and sort by lastUpdated timestamp (newest first)
      const matchesArray = Object.keys(allMatches).map(matchId => ({
        matchId: matchId,
        ...allMatches[matchId]
      })).sort((a, b) => {
        // Use lastUpdated (numeric timestamp) for sorting, fallback to 0
        const timeA = a.lastUpdated || 0;
        const timeB = b.lastUpdated || 0;
        return timeB - timeA;
      });
      
      console.log('üìã Sorted matches array:', matchesArray); // Debug log
      
      // Store matches globally for export
      allMatchesData = matchesArray;
      
      // Show export button if there are matches
      if (matchesArray.length > 0) {
        document.getElementById('exportCsvBtn').style.display = 'inline-block';
      }
      
      // Detect ongoing match (most recent match that's not completed)
      const ongoingMatch = matchesArray.find(match => {
        // Check if match has been explicitly marked as completed
        if (match.matchCompleted) {
          return false; // Skip completed matches
        }
        
        // Also check if there's a result text (means match is completed)
        if (match.resultText && match.resultText.trim() !== '') {
          return false; // Skip matches with results
        }
        
        // Check if match is still in progress (not both innings done)
        const firstDone = match.first?.done || false;
        const secondDone = match.second?.done || false;
        const inSecond = match.inSecond || false;
        
        // If in first innings and not done, or in second innings and not done
        return (!inSecond && !firstDone) || (inSecond && !secondDone);
      });
      
      console.log('‚ö° Ongoing match:', ongoingMatch); // Debug log
      
      // Display ongoing match
      if (ongoingMatch) {
        displayOngoingMatch(ongoingMatch);
        document.getElementById('ongoingSection').style.display = 'block';
      } else {
        document.getElementById('ongoingSection').style.display = 'none';
      }
      
      // Calculate and display points table for League matches
      calculatePointsTable(matchesArray);
      
      // Display recent 50 matches
      const recentMatches = matchesArray.slice(0, 50);
      displayRecentMatches(recentMatches);
      
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';
      
    }, (error) => {
      console.error('‚ùå Firebase error:', error); // Debug log
      
      // Check if it's a connection limit error
      if (error.code === 'PERMISSION_DENIED' || error.message.includes('connection') || error.message.includes('limit')) {
        document.getElementById('loading').innerHTML = `
          <div class="error" style="padding:32px;text-align:center;">
            <div style="font-size:48px;margin-bottom:16px;">‚ö†Ô∏è</div>
            <h2 style="color:#ef4444;font-size:22px;margin-bottom:12px;">Connection Limit Reached</h2>
            <p style="margin-bottom:20px;">Too many people are browsing matches right now! üèè</p>
            <p style="margin-bottom:24px;font-size:14px;">Please wait a few minutes and try again.</p>
            <button onclick="location.reload()" style="background:#8b5cf6;color:white;border:none;padding:12px 28px;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;">
              üîÑ Try Again
            </button>
          </div>
        `;
        
        // Stop polling
        if (pollingInterval) {
          clearInterval(pollingInterval);
        }
      } else {
        document.getElementById('loading').innerHTML = '<div class="error">Error loading matches: ' + error.message + '</div>';
      }
    });
    };
    
    // Initial load
    pollMatches();
    
    // Poll every 5 seconds for updates (instead of continuous listener)
    pollingInterval = setInterval(pollMatches, 5000);
    
    console.log('‚úÖ Polling enabled (every 5 seconds) - reduced active connections');
    
    // Inactivity checker - pause polling after 15 minutes of inactivity
    setInterval(() => {
      const inactiveTime = Date.now() - lastActivityTime;
      const fifteenMinutes = 15 * 60 * 1000;
      
      if (inactiveTime > fifteenMinutes && !isPollingPaused) {
        console.log('‚è∏Ô∏è Pausing polling due to 15 min inactivity');
        if (pollingInterval) {
          clearInterval(pollingInterval);
          pollingInterval = null;
          isPollingPaused = true;
        }
      }
    }, 30000); // Check every 30 seconds
    
    // Track user activity to reset inactivity timer
    ['mousedown', 'keydown', 'scroll', 'touchstart', 'click'].forEach(event => {
      document.addEventListener(event, () => {
        lastActivityTime = Date.now();
        
        // Resume polling if it was paused
        if (isPollingPaused) {
          console.log('‚ñ∂Ô∏è Resuming polling - user activity detected');
          isPollingPaused = false;
          pollMatches(); // Immediate refresh
          pollingInterval = setInterval(pollMatches, 5000);
        }
      }, { passive: true });
    });
    
    // Pause polling when page is hidden (user switched tabs)
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        console.log('üëÅÔ∏è Page hidden - pausing polling');
        if (pollingInterval) {
          clearInterval(pollingInterval);
          pollingInterval = null;
        }
      } else {
        console.log('üëÅÔ∏è Page visible - resuming polling');
        lastActivityTime = Date.now(); // Reset activity timer
        isPollingPaused = false;
        pollMatches(); // Immediate refresh
        pollingInterval = setInterval(pollMatches, 5000);
      }
    });
    }
    
    function displayOngoingMatch(match) {
      const section = document.getElementById('ongoingSection');
      const container = document.getElementById('ongoingMatch');
      
      const firstScore = `${match.first?.runs || 0}/${match.first?.wkts || 0}`;
      const firstOvers = calculateOvers(match.first?.legalBalls || 0);
      const secondScore = `${match.second?.runs || 0}/${match.second?.wkts || 0}`;
      const secondOvers = calculateOvers(match.second?.legalBalls || 0);
      
      const isBattingFirst = !match.inSecond;
      
      const matchTypeText = match.matchType ? ` - ${match.matchType}` : '';
      const tournamentBadge = match.tournamentName && match.tournamentName.trim() !== '' 
        ? `<div style="font-size:11px;color:#fef08a;font-weight:800;margin-bottom:4px;letter-spacing:0.3px;">#${match.tournamentName}${matchTypeText}</div>` 
        : '';
      
      container.innerHTML = `
        <div class="card ongoing-card">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
            <div style="flex: 1; min-width: 0;">
              <div class="ongoing-badge">üî¥ LIVE NOW</div>
              ${tournamentBadge}
              <div class="match-title">${match.teamA || 'Team A'} vs ${match.teamB || 'Team B'}</div>
              <div class="match-score">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span><strong>${match.teamA || 'Team A'}:</strong></span>
                  <span style="font-weight: 600;">${firstScore} (${firstOvers})</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span><strong>${match.teamB || 'Team B'}:</strong></span>
                  <span style="font-weight: 600;">${secondScore} (${secondOvers})</span>
                </div>
                <div style="margin-top: 6px;">
                  ${isBattingFirst ? 'üèè Batting: ' + (match.teamA || 'Team A') : 'üèè Batting: ' + (match.teamB || 'Team B')}
                </div>
              </div>
            </div>
            <div style="flex-shrink: 0;">
              <a href="livescore.html?org=${organizationId}&match=${match.matchId}" class="btn btn-primary">
                üëÅÔ∏è Watch
              </a>
            </div>
          </div>
        </div>
      `;
      
      section.style.display = 'block';
    }
    
    function displayRecentMatches(matches) {
      const container = document.getElementById('recentMatches');
      
      if (matches.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üèè</div><div>No matches to display</div></div>';
        return;
      }
      
      container.innerHTML = matches.map(match => {
        const firstScore = `${match.first?.runs || 0}/${match.first?.wkts || 0}`;
        const firstOvers = calculateOvers(match.first?.legalBalls || 0);
        const secondScore = `${match.second?.runs || 0}/${match.second?.wkts || 0}`;
        const secondOvers = calculateOvers(match.second?.legalBalls || 0);
        
        const hasResult = match.resultText && match.resultText.trim() !== '';
        const isComplete = match.first?.done && match.second?.done;
        
        // Check if match is inactive (no update in 15+ minutes)
        const currentTime = Date.now();
        const lastUpdate = match.lastUpdated || match.timestamp || 0;
        const minutesSinceUpdate = (currentTime - lastUpdate) / (1000 * 60);
        const isInactive = minutesSinceUpdate >= 15;
        
        let statusBadge = '';
        if (hasResult) {
          statusBadge = '<span style="display:inline-block;background:#10b981;color:white;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:600;margin-left:8px;">‚úÖ Completed</span>';
        } else if (!match.matchCompleted && !hasResult) {
          // Check if match is paused/inactive
          if (isInactive) {
            statusBadge = '<span style="display:inline-block;background:#9333ea;color:white;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:600;margin-left:8px;">‚ö†Ô∏è Stalled</span>';
          } else {
            // Show LIVE badge for any ongoing match (first or second innings)
            statusBadge = '<span style="display:inline-block;background:#f59e0b;color:white;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:600;margin-left:8px;">üèè LIVE</span>';
          }
        }
        
        const dateStr = match.timestamp ? new Date(match.timestamp).toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) : '';
        
        const matchTypeText = match.matchType ? ` - ${match.matchType}` : '';
        const tournamentBadge = match.tournamentName && match.tournamentName.trim() !== '' 
          ? `<div style="font-size:11px;color:#667eea;font-weight:800;margin-bottom:4px;letter-spacing:0.3px;">#${match.tournamentName}${matchTypeText}</div>` 
          : '';
        
        return `
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
              <div style="flex: 1; min-width: 0;">
                ${tournamentBadge}
                <div class="match-title">
                  ${match.teamA || 'Team A'} vs ${match.teamB || 'Team B'}
                  ${statusBadge}
                </div>
                <div class="match-score">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span><strong>${match.teamA || 'Team A'}:</strong></span>
                    <span style="font-weight: 600;">${firstScore} (${firstOvers})</span>
                  </div>
                  <div style="display: flex; justify-content: space-between;">
                    <span><strong>${match.teamB || 'Team B'}:</strong></span>
                    <span style="font-weight: 600;">${secondScore} (${secondOvers})</span>
                  </div>
                  ${hasResult ? '<div style="color:#10b981;font-weight:600;margin-top:6px;">üèÜ ' + match.resultText + '</div>' : ''}
                </div>
                ${dateStr ? `<div class="match-meta">üìÖ ${dateStr}</div>` : ''}
              </div>
              <div style="flex-shrink: 0;">
                <a href="livescore.html?org=${organizationId}&match=${match.matchId}" class="btn">
                  üëÅÔ∏è View
                </a>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function calculateOvers(legalBalls) {
      if (!legalBalls) return '0.0';
      const overs = Math.floor(legalBalls / 6);
      const balls = legalBalls % 6;
      return `${overs}.${balls}`;
    }
    
    // Calculate Points Table for League Matches
    function calculatePointsTable(matches) {
      // Filter only League matches that are completed
      const leagueMatches = matches.filter(match => {
        const isLeague = match.matchType && match.matchType.toLowerCase().includes('league');
        const isCompleted = match.matchCompleted || (match.resultText && match.resultText.trim() !== '');
        return isLeague && isCompleted;
      });
      
      if (leagueMatches.length === 0) {
        document.getElementById('pointsTableSection').style.display = 'none';
        return;
      }
      
      // Build team statistics
      const teamStats = {};
      
      leagueMatches.forEach(match => {
        const teamA = match.teamA || 'Team A';
        const teamB = match.teamB || 'Team B';
        
        // Initialize team stats if not exists
        if (!teamStats[teamA]) {
          teamStats[teamA] = { matches: 0, wins: 0, losses: 0, noResult: 0, totalRunsScored: 0, totalOversPlayed: 0, totalRunsConceded: 0, totalOversBowled: 0 };
        }
        if (!teamStats[teamB]) {
          teamStats[teamB] = { matches: 0, wins: 0, losses: 0, noResult: 0, totalRunsScored: 0, totalOversPlayed: 0, totalRunsConceded: 0, totalOversBowled: 0 };
        }
        
        const firstRuns = match.first?.runs || 0;
        const firstBalls = match.first?.legalBalls || 0;
        const secondRuns = match.second?.runs || 0;
        const secondBalls = match.second?.legalBalls || 0;
        
        // In the scorer: first innings is ALWAYS Team A, second innings is ALWAYS Team B
        // So Team A batted in first innings, Team B batted in second innings
        
        // Team A scored firstRuns in firstBalls, conceded secondRuns in secondBalls
        teamStats[teamA].totalRunsScored += firstRuns;
        teamStats[teamA].totalOversPlayed += firstBalls;
        teamStats[teamA].totalRunsConceded += secondRuns;
        teamStats[teamA].totalOversBowled += secondBalls;
        
        // Team B scored secondRuns in secondBalls, conceded firstRuns in firstBalls
        teamStats[teamB].totalRunsScored += secondRuns;
        teamStats[teamB].totalOversPlayed += secondBalls;
        teamStats[teamB].totalRunsConceded += firstRuns;
        teamStats[teamB].totalOversBowled += firstBalls;
        
        // Determine winner from result text
        const resultText = match.resultText || '';
        const resultLower = resultText.toLowerCase();
        
        let winner = null;
        if (resultLower.includes(teamA.toLowerCase()) && (resultLower.includes('won') || resultLower.includes('win'))) {
          winner = teamA;
        } else if (resultLower.includes(teamB.toLowerCase()) && (resultLower.includes('won') || resultLower.includes('win'))) {
          winner = teamB;
        } else if (resultLower.includes('tie') || resultLower.includes('draw') || resultLower.includes('no result')) {
          winner = 'noResult';
        }
        
        // Update match counts
        teamStats[teamA].matches++;
        teamStats[teamB].matches++;
        
        if (winner === teamA) {
          teamStats[teamA].wins++;
          teamStats[teamB].losses++;
        } else if (winner === teamB) {
          teamStats[teamB].wins++;
          teamStats[teamA].losses++;
        } else {
          teamStats[teamA].noResult++;
          teamStats[teamB].noResult++;
        }
      });
      
      // Calculate NRR and Points for each team
      const teamArray = Object.keys(teamStats).map(team => {
        const stats = teamStats[team];
        
        // Calculate Run Rate
        const totalOvers = (stats.totalOversPlayed / 6).toFixed(1);
        const totalOversBowled = (stats.totalOversBowled / 6).toFixed(1);
        const runRateFor = stats.totalOversPlayed > 0 ? (stats.totalRunsScored / (stats.totalOversPlayed / 6)) : 0;
        const runRateAgainst = stats.totalOversBowled > 0 ? (stats.totalRunsConceded / (stats.totalOversBowled / 6)) : 0;
        
        // Net Run Rate = Run Rate For - Run Rate Against
        const nrr = runRateFor - runRateAgainst;
        
        // Points: Win = 2, No Result = 1, Loss = 0
        const points = (stats.wins * 2) + (stats.noResult * 1);
        
        return {
          team,
          matches: stats.matches,
          wins: stats.wins,
          losses: stats.losses,
          noResult: stats.noResult,
          nrr: isNaN(nrr) ? 0 : nrr,
          points,
          // Store calculation details
          nrrDetails: {
            runsScored: stats.totalRunsScored,
            oversPlayed: totalOvers,
            runsConceded: stats.totalRunsConceded,
            oversBowled: totalOversBowled,
            runRateFor: runRateFor.toFixed(3),
            runRateAgainst: runRateAgainst.toFixed(3)
          }
        };
      });
      
      // Sort by: Points (desc), NRR (desc), Wins (desc)
      teamArray.sort((a, b) => {
        if (b.points !== a.points) return b.points - a.points;
        if (b.nrr !== a.nrr) return b.nrr - a.nrr;
        return b.wins - a.wins;
      });
      
      // Display points table
      displayPointsTable(teamArray);
    }
    
    function displayPointsTable(teamArray) {
      const tbody = document.getElementById('pointsTableBody');
      
      if (teamArray.length === 0) {
        document.getElementById('pointsTableSection').style.display = 'none';
        return;
      }
      
      tbody.innerHTML = teamArray.map((team, index) => {
        const nrrClass = team.nrr > 0 ? 'nrr-positive' : (team.nrr < 0 ? 'nrr-negative' : '');
        const nrrDisplay = team.nrr >= 0 ? `+${team.nrr.toFixed(3)}` : team.nrr.toFixed(3);
        const rowId = `team-${team.team.replace(/\s+/g, '-')}`;
        const isOpen = openNRRBreakdowns.has(rowId) ? 'show' : '';
        
        return `
          <tr>
            <td class="rank-cell">${index + 1}</td>
            <td>${team.team}</td>
            <td>${team.matches}</td>
            <td>${team.wins}</td>
            <td>${team.losses}</td>
            <td>${team.noResult}</td>
            <td class="${nrrClass}">
              ${nrrDisplay}
              <a href="javascript:void(0)" class="toggle-nrr" onclick="toggleNRRBreakdown('${rowId}')" title="Show NRR calculation">‚ìò</a>
            </td>
            <td class="points-cell">${team.points}</td>
          </tr>
          <tr class="nrr-breakdown ${isOpen}" id="breakdown-${rowId}">
            <td colspan="8">
              <div class="nrr-formula">
                <div class="nrr-formula-title">üìä NRR Calculation for ${team.team}</div>
                <div class="nrr-calc-step"><strong>Runs Scored:</strong> ${team.nrrDetails.runsScored} runs in ${team.nrrDetails.oversPlayed} overs</div>
                <div class="nrr-calc-step"><strong>Run Rate (For):</strong> ${team.nrrDetails.runsScored} √∑ ${team.nrrDetails.oversPlayed} = <strong>${team.nrrDetails.runRateFor}</strong></div>
                <div class="nrr-calc-step" style="margin-top:12px;"><strong>Runs Conceded:</strong> ${team.nrrDetails.runsConceded} runs in ${team.nrrDetails.oversBowled} overs</div>
                <div class="nrr-calc-step"><strong>Run Rate (Against):</strong> ${team.nrrDetails.runsConceded} √∑ ${team.nrrDetails.oversBowled} = <strong>${team.nrrDetails.runRateAgainst}</strong></div>
                <div class="nrr-calc-step" style="margin-top:12px;padding-top:12px;border-top:2px solid #e5e7eb;"><strong>Net Run Rate:</strong> ${team.nrrDetails.runRateFor} - ${team.nrrDetails.runRateAgainst} = <strong class="${nrrClass}">${nrrDisplay}</strong></div>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      document.getElementById('pointsTableSection').style.display = 'block';
    }
    
    function toggleNRRBreakdown(rowId) {
      const breakdownRow = document.getElementById(`breakdown-${rowId}`);
      if (breakdownRow) {
        breakdownRow.classList.toggle('show');
        
        // Track the state
        if (breakdownRow.classList.contains('show')) {
          openNRRBreakdowns.add(rowId);
        } else {
          openNRRBreakdowns.delete(rowId);
        }
      }
    }
    
    function exportToCSV() {
      if (!allMatchesData || allMatchesData.length === 0) {
        alert('No matches to export!');
        return;
      }
      
      // CSV Headers
      const headers = [
        'Match ID',
        'Tournament Name',
        'Match Type',
        'Date & Time',
        'Team A',
        'Team A Runs',
        'Team A Wickets',
        'Team A Overs',
        'Team B',
        'Team B Runs',
        'Team B Wickets',
        'Team B Overs',
        'Result',
        'Status',
        'Overs Limit'
      ];
      
      // Convert matches to CSV rows
      const rows = allMatchesData.map(match => {
        const firstScore = match.first?.runs || 0;
        const firstWkts = match.first?.wkts || 0;
        const firstOvers = calculateOvers(match.first?.legalBalls || 0);
        
        const secondScore = match.second?.runs || 0;
        const secondWkts = match.second?.wkts || 0;
        const secondOvers = calculateOvers(match.second?.legalBalls || 0);
        
        const dateStr = match.timestamp ? new Date(match.timestamp).toLocaleString('en-US', { 
          year: 'numeric',
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) : '';
        
        const hasResult = match.resultText && match.resultText.trim() !== '';
        let status = 'In Progress';
        if (hasResult) {
          status = 'Completed';
        } else if (match.matchCompleted) {
          status = 'Completed';
        }
        
        return [
          match.matchId || '',
          match.tournamentName || '',
          match.matchType || '',
          dateStr,
          match.teamA || 'Team A',
          firstScore,
          firstWkts,
          firstOvers,
          match.teamB || 'Team B',
          secondScore,
          secondWkts,
          secondOvers,
          match.resultText || '',
          status,
          match.oversLimit || 20
        ];
      });
      
      // Combine headers and rows
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => {
          // Escape cells with commas or quotes
          const cellStr = String(cell);
          if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
            return `"${cellStr.replace(/"/g, '""')}"`;
          }
          return cellStr;
        }).join(','))
      ].join('\n');
      
      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      // Generate filename with tournament name and date
      const tournamentName = allMatchesData[0]?.tournamentName || 'CricketBook';
      const date = new Date().toISOString().split('T')[0];
      const filename = `${tournamentName.replace(/[^a-z0-9]/gi, '_')}_matches_${date}.csv`;
      
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      console.log('‚úÖ Exported ' + allMatchesData.length + ' matches to CSV');
    }
    
    // Clean up connections when leaving page
    window.addEventListener('beforeunload', () => {
      console.log('üßπ Cleaning up connections before page unload');
      if (pollingInterval) {
        clearInterval(pollingInterval);
      }
    });
  </script>

  <!-- Footer -->
  <footer style="text-align:center;padding:24px 0;color:#ffffff;font-size:14px;margin-top:24px;">
    <p style="margin:0 0 8px;">Made with ‚ù§Ô∏è for local cricket matches.</p>
    <p style="margin:0;opacity:0.9;">¬© 2025 CricketBook ‚Äî Realtime Cricket Scoring Tool</p>
  </footer>

</body>
</html>
