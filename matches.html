<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QVXGPQXQPF"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-QVXGPQXQPF');
</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="View all cricket matches - Recent and ongoing matches">
  <title>CricketBook - All Matches</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 18px;
      color: #1f2937;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .matches-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    @media (max-width: 768px) {
      .matches-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .header {
      text-align: center;
      margin-bottom: 16px;
      color: white;
    }
    
    .header h1 {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 4px;
    }
    
    .header p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .section {
      margin-bottom: 16px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: white;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .card {
      background: #ffffff;
      border: 1px solid rgba(148,163,184,.2);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,.12), 0 2px 8px rgba(0,0,0,.08);
      margin-bottom: 10px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 50px rgba(0,0,0,.15), 0 4px 12px rgba(0,0,0,.1);
    }
    
    .ongoing-card {
      background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
      color: white;
      border: none;
    }
    
    .ongoing-card .match-title {
      color: white;
    }
    
    .ongoing-card .match-score {
      color: rgba(255,255,255,0.95);
    }
    
    .ongoing-badge {
      display: inline-block;
      background: rgba(255,255,255,0.3);
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 6px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .match-title {
      font-size: 17px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 8px;
    }
    
    .match-score {
      font-size: 14px;
      color: #4b5563;
      margin-bottom: 10px;
      line-height: 1.6;
    }
    
    .match-meta {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 10px;
    }
    
    .btn {
      display: inline-block;
      padding: 8px 16px;
      background: #8b5cf6;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .btn:hover {
      background: #7c3aed;
      transform: scale(1.05);
    }
    
    .btn-primary {
      background: white;
      color: #10b981;
    }
    
    .btn-primary:hover {
      background: rgba(255,255,255,0.9);
      color: #059669;
    }
    
    .loading {
      text-align: center;
      color: white;
      font-size: 18px;
      padding: 40px;
    }
    
    .empty-state {
      background: white;
      border-radius: 16px;
      padding: 40px 20px;
      text-align: center;
      color: #6b7280;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }
    
    .error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      margin-top: 20px;
    }
    
    /* Navigation */
    .nav {
      text-align: center;
      margin-bottom: 15px;
      padding: 0 5px;
    }
    
    .nav a {
      display: inline-block;
      color: white;
      text-decoration: none;
      padding: 8px 14px;
      margin: 3px 3px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .nav a:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-1px);
    }
    
    .nav a.active {
      background: rgba(255, 255, 255, 0.3);
    }
    
    @media (max-width: 768px) {
      .nav {
        margin-bottom: 12px;
        padding: 0 2px;
      }
      .nav a {
        padding: 6px 8px;
        margin: 2px 1px;
        font-size: 10.5px;
      }
    }
    
    @media (max-width: 400px) {
      .nav a {
        padding: 6px 6px;
        margin: 2px 1px;
        font-size: 10px;
      }
    }
    
    .new-match-btn {
      background: #10b981;
      width: 100%;
      text-align: center;
      margin-top: 12px;
      display: block;
      padding: 10px 16px;
    }
    
    .new-match-btn:hover {
      background: #059669;
    }
    
    .export-btn {
      background: #10b981;
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      margin-top: 12px;
    }
    
    .export-btn:hover {
      background: #059669;
      transform: scale(1.05);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Navigation -->
    <nav class="nav">
      <a href="index.html">üè† Home</a>
      <a href="livescore.html">üì∫ Live Score</a>
      <a href="matches.html" class="active">üìã Matches</a>
      <a href="about.html">‚ÑπÔ∏è About</a>
    </nav>
    
    <div class="header">
      <h1>üèè CricketBook</h1>
      <p>All Matches</p>
    </div>
    
    <div class="loading" id="loading">Loading matches...</div>
    
    <div id="content" style="display:none">
      <!-- Ongoing Match Section -->
      <div id="ongoingSection" class="section" style="display:none">
        <div class="section-title">
          ‚ö° Live Match
        </div>
        <div id="ongoingMatch"></div>
      </div>
      
      <!-- Recent Matches Section -->
      <div id="recentSection" class="section">
        <div class="section-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>üìã Recent Matches</span>
          <a id="exportCsvBtn" href="javascript:void(0);" onclick="exportToCSV()" style="display:none;color:white;text-decoration:none;font-size:13px;opacity:0.9;font-weight:400;">
            Export CSV ‚Üí
          </a>
        </div>
        <div id="recentMatches" class="matches-grid"></div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAFfwgHq761oFMg4CVqmZezGR_WK6ZGvAY",
      authDomain: "cricketbook-35725.firebaseapp.com",
      databaseURL: "https://cricketbook-35725-default-rtdb.firebaseio.com",
      projectId: "cricketbook-35725",
      storageBucket: "cricketbook-35725.firebasestorage.app",
      messagingSenderId: "128747950424",
      appId: "1:128747950424:web:dce02e8420c353f1acd52d"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Global variable to store matches for export
    let allMatchesData = [];
    let pollingInterval = null; // For polling instead of continuous listener

    // Check if org parameter is in URL (from share link)
    const urlParams = new URLSearchParams(window.location.search);
    const urlOrgId = urlParams.get('org');
    
    // Organization ID for multi-user isolation
    let organizationId = localStorage.getItem('cricketbook_org_id');
    
    if (urlOrgId) {
      // Share link with org ID - save it to localStorage
      organizationId = urlOrgId;
      localStorage.setItem('cricketbook_org_id', organizationId);
      console.log('üîó Using Organization ID from URL and saved to localStorage:', organizationId);
    }
    
    if (!organizationId) {
      // No org ID - show helpful message
      console.warn('‚ö†Ô∏è No Organization ID found. Please start a match first.');
      document.getElementById('loading').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üèè</div><div style="font-size:18px;font-weight:600;margin-bottom:12px;color:#1f2937;">Welcome to CricketBook!</div><div style="color:#6b7280;margin-bottom:16px;">Start your first match to see all your matches here.</div><a href="index.html" class="btn new-match-btn" style="max-width:300px;margin:0 auto;">üè† Go to Home & Start Match</a></div>';
      document.getElementById('loading').style.display = 'block';
      document.getElementById('content').style.display = 'none';
    } else {
      console.log('‚úÖ Using Organization ID:', organizationId);
      
      // Load all matches with real-time sync (filtered by organization)
      loadMatches();
    }
    
    function loadMatches() {
      const matchesRef = database.ref('organizations/' + organizationId + '/matches');
    
    // Use polling instead of continuous listener to reduce active connections
    const pollMatches = () => {
      matchesRef.once('value', (snapshot) => {
      const allMatches = snapshot.val();
      
      console.log('üìä Loaded matches from Firebase for org ' + organizationId + ':', allMatches); // Debug log
      
      if (!allMatches) {
        document.getElementById('loading').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üèè</div><div style="font-size:18px;font-weight:600;margin-bottom:12px;color:#1f2937;">No Matches Yet</div><div style="color:#6b7280;margin-bottom:16px;">Start your first match to see it here!</div><a href="index.html" style="background:#8b5cf6;color:white;padding:10px 24px;border-radius:10px;text-decoration:none;display:inline-block;font-weight:600;">üè† Go to Home & Start Scoring</a></div>';
        document.getElementById('loading').style.display = 'block';
        document.getElementById('content').style.display = 'none';
        return;
      }
      
      // Convert to array and sort by lastUpdated timestamp (newest first)
      const matchesArray = Object.keys(allMatches).map(matchId => ({
        matchId: matchId,
        ...allMatches[matchId]
      })).sort((a, b) => {
        // Use lastUpdated (numeric timestamp) for sorting, fallback to 0
        const timeA = a.lastUpdated || 0;
        const timeB = b.lastUpdated || 0;
        return timeB - timeA;
      });
      
      console.log('üìã Sorted matches array:', matchesArray); // Debug log
      
      // Store matches globally for export
      allMatchesData = matchesArray;
      
      // Show export button if there are matches
      if (matchesArray.length > 0) {
        document.getElementById('exportCsvBtn').style.display = 'inline-block';
      }
      
      // Detect ongoing match (most recent match that's not completed)
      const ongoingMatch = matchesArray.find(match => {
        // Check if match has been explicitly marked as completed
        if (match.matchCompleted) {
          return false; // Skip completed matches
        }
        
        // Also check if there's a result text (means match is completed)
        if (match.resultText && match.resultText.trim() !== '') {
          return false; // Skip matches with results
        }
        
        // Check if match is still in progress (not both innings done)
        const firstDone = match.first?.done || false;
        const secondDone = match.second?.done || false;
        const inSecond = match.inSecond || false;
        
        // If in first innings and not done, or in second innings and not done
        return (!inSecond && !firstDone) || (inSecond && !secondDone);
      });
      
      console.log('‚ö° Ongoing match:', ongoingMatch); // Debug log
      
      // Display ongoing match
      if (ongoingMatch) {
        displayOngoingMatch(ongoingMatch);
        document.getElementById('ongoingSection').style.display = 'block';
      } else {
        document.getElementById('ongoingSection').style.display = 'none';
      }
      
      // Display recent 20 matches
      const recentMatches = matchesArray.slice(0, 20);
      displayRecentMatches(recentMatches);
      
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';
      
    }, (error) => {
      console.error('‚ùå Firebase error:', error); // Debug log
      
      // Check if it's a connection limit error
      if (error.code === 'PERMISSION_DENIED' || error.message.includes('connection') || error.message.includes('limit')) {
        document.getElementById('loading').innerHTML = `
          <div class="error" style="padding:32px;text-align:center;">
            <div style="font-size:48px;margin-bottom:16px;">‚ö†Ô∏è</div>
            <h2 style="color:#ef4444;font-size:22px;margin-bottom:12px;">Connection Limit Reached</h2>
            <p style="margin-bottom:20px;">Too many people are browsing matches right now! üèè</p>
            <p style="margin-bottom:24px;font-size:14px;">Please wait a few minutes and try again.</p>
            <button onclick="location.reload()" style="background:#8b5cf6;color:white;border:none;padding:12px 28px;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;">
              üîÑ Try Again
            </button>
          </div>
        `;
        
        // Stop polling
        if (pollingInterval) {
          clearInterval(pollingInterval);
        }
      } else {
        document.getElementById('loading').innerHTML = '<div class="error">Error loading matches: ' + error.message + '</div>';
      }
    });
    };
    
    // Initial load
    pollMatches();
    
    // Poll every 5 seconds for updates (instead of continuous listener)
    pollingInterval = setInterval(pollMatches, 5000);
    
    console.log('‚úÖ Polling enabled (every 5 seconds) - reduced active connections');
    }
    
    function displayOngoingMatch(match) {
      const section = document.getElementById('ongoingSection');
      const container = document.getElementById('ongoingMatch');
      
      const firstScore = `${match.first?.runs || 0}/${match.first?.wkts || 0}`;
      const firstOvers = calculateOvers(match.first?.legalBalls || 0);
      const secondScore = `${match.second?.runs || 0}/${match.second?.wkts || 0}`;
      const secondOvers = calculateOvers(match.second?.legalBalls || 0);
      
      const isBattingFirst = !match.inSecond;
      
      const matchTypeText = match.matchType ? ` - ${match.matchType}` : '';
      const tournamentBadge = match.tournamentName && match.tournamentName.trim() !== '' 
        ? `<div style="font-size:11px;color:#fef08a;font-weight:800;margin-bottom:4px;letter-spacing:0.3px;">#${match.tournamentName}${matchTypeText}</div>` 
        : '';
      
      container.innerHTML = `
        <div class="card ongoing-card">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
            <div style="flex: 1; min-width: 0;">
              <div class="ongoing-badge">üî¥ LIVE NOW</div>
              ${tournamentBadge}
              <div class="match-title">${match.teamA || 'Team A'} vs ${match.teamB || 'Team B'}</div>
              <div class="match-score">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span><strong>${match.teamA || 'Team A'}:</strong></span>
                  <span style="font-weight: 600;">${firstScore} (${firstOvers})</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span><strong>${match.teamB || 'Team B'}:</strong></span>
                  <span style="font-weight: 600;">${secondScore} (${secondOvers})</span>
                </div>
                <div style="margin-top: 6px;">
                  ${isBattingFirst ? 'üèè Batting: ' + (match.teamA || 'Team A') : 'üèè Batting: ' + (match.teamB || 'Team B')}
                </div>
              </div>
            </div>
            <div style="flex-shrink: 0;">
              <a href="livescore.html?org=${organizationId}&match=${match.matchId}" class="btn btn-primary">
                üëÅÔ∏è Watch
              </a>
            </div>
          </div>
        </div>
      `;
      
      section.style.display = 'block';
    }
    
    function displayRecentMatches(matches) {
      const container = document.getElementById('recentMatches');
      
      if (matches.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üèè</div><div>No matches to display</div></div>';
        return;
      }
      
      container.innerHTML = matches.map(match => {
        const firstScore = `${match.first?.runs || 0}/${match.first?.wkts || 0}`;
        const firstOvers = calculateOvers(match.first?.legalBalls || 0);
        const secondScore = `${match.second?.runs || 0}/${match.second?.wkts || 0}`;
        const secondOvers = calculateOvers(match.second?.legalBalls || 0);
        
        const hasResult = match.resultText && match.resultText.trim() !== '';
        const isComplete = match.first?.done && match.second?.done;
        
        // Check if match is inactive (no update in 15+ minutes)
        const currentTime = Date.now();
        const lastUpdate = match.lastUpdated || match.timestamp || 0;
        const minutesSinceUpdate = (currentTime - lastUpdate) / (1000 * 60);
        const isInactive = minutesSinceUpdate >= 15;
        
        let statusBadge = '';
        if (hasResult) {
          statusBadge = '<span style="display:inline-block;background:#10b981;color:white;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:600;margin-left:8px;">‚úÖ Completed</span>';
        } else if (!match.matchCompleted && !hasResult) {
          // Check if match is paused/inactive
          if (isInactive) {
            statusBadge = '<span style="display:inline-block;background:#9333ea;color:white;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:600;margin-left:8px;">‚ö†Ô∏è Stalled</span>';
          } else {
            // Show LIVE badge for any ongoing match (first or second innings)
            statusBadge = '<span style="display:inline-block;background:#f59e0b;color:white;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:600;margin-left:8px;">üèè LIVE</span>';
          }
        }
        
        const dateStr = match.timestamp ? new Date(match.timestamp).toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) : '';
        
        const matchTypeText = match.matchType ? ` - ${match.matchType}` : '';
        const tournamentBadge = match.tournamentName && match.tournamentName.trim() !== '' 
          ? `<div style="font-size:11px;color:#667eea;font-weight:800;margin-bottom:4px;letter-spacing:0.3px;">#${match.tournamentName}${matchTypeText}</div>` 
          : '';
        
        return `
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
              <div style="flex: 1; min-width: 0;">
                ${tournamentBadge}
                <div class="match-title">
                  ${match.teamA || 'Team A'} vs ${match.teamB || 'Team B'}
                  ${statusBadge}
                </div>
                <div class="match-score">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span><strong>${match.teamA || 'Team A'}:</strong></span>
                    <span style="font-weight: 600;">${firstScore} (${firstOvers})</span>
                  </div>
                  <div style="display: flex; justify-content: space-between;">
                    <span><strong>${match.teamB || 'Team B'}:</strong></span>
                    <span style="font-weight: 600;">${secondScore} (${secondOvers})</span>
                  </div>
                  ${hasResult ? '<div style="color:#10b981;font-weight:600;margin-top:6px;">üèÜ ' + match.resultText + '</div>' : ''}
                </div>
                ${dateStr ? `<div class="match-meta">üìÖ ${dateStr}</div>` : ''}
              </div>
              <div style="flex-shrink: 0;">
                <a href="livescore.html?org=${organizationId}&match=${match.matchId}" class="btn">
                  üëÅÔ∏è View
                </a>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function calculateOvers(legalBalls) {
      if (!legalBalls) return '0.0';
      const overs = Math.floor(legalBalls / 6);
      const balls = legalBalls % 6;
      return `${overs}.${balls}`;
    }
    
    function exportToCSV() {
      if (!allMatchesData || allMatchesData.length === 0) {
        alert('No matches to export!');
        return;
      }
      
      // CSV Headers
      const headers = [
        'Match ID',
        'Tournament Name',
        'Match Type',
        'Date & Time',
        'Team A',
        'Team A Runs',
        'Team A Wickets',
        'Team A Overs',
        'Team B',
        'Team B Runs',
        'Team B Wickets',
        'Team B Overs',
        'Result',
        'Status',
        'Overs Limit'
      ];
      
      // Convert matches to CSV rows
      const rows = allMatchesData.map(match => {
        const firstScore = match.first?.runs || 0;
        const firstWkts = match.first?.wkts || 0;
        const firstOvers = calculateOvers(match.first?.legalBalls || 0);
        
        const secondScore = match.second?.runs || 0;
        const secondWkts = match.second?.wkts || 0;
        const secondOvers = calculateOvers(match.second?.legalBalls || 0);
        
        const dateStr = match.timestamp ? new Date(match.timestamp).toLocaleString('en-US', { 
          year: 'numeric',
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) : '';
        
        const hasResult = match.resultText && match.resultText.trim() !== '';
        let status = 'In Progress';
        if (hasResult) {
          status = 'Completed';
        } else if (match.matchCompleted) {
          status = 'Completed';
        }
        
        return [
          match.matchId || '',
          match.tournamentName || '',
          match.matchType || '',
          dateStr,
          match.teamA || 'Team A',
          firstScore,
          firstWkts,
          firstOvers,
          match.teamB || 'Team B',
          secondScore,
          secondWkts,
          secondOvers,
          match.resultText || '',
          status,
          match.oversLimit || 20
        ];
      });
      
      // Combine headers and rows
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => {
          // Escape cells with commas or quotes
          const cellStr = String(cell);
          if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
            return `"${cellStr.replace(/"/g, '""')}"`;
          }
          return cellStr;
        }).join(','))
      ].join('\n');
      
      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      // Generate filename with tournament name and date
      const tournamentName = allMatchesData[0]?.tournamentName || 'CricketBook';
      const date = new Date().toISOString().split('T')[0];
      const filename = `${tournamentName.replace(/[^a-z0-9]/gi, '_')}_matches_${date}.csv`;
      
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      console.log('‚úÖ Exported ' + allMatchesData.length + ' matches to CSV');
    }
    
    // Clean up connections when leaving page
    window.addEventListener('beforeunload', () => {
      console.log('üßπ Cleaning up connections before page unload');
      if (pollingInterval) {
        clearInterval(pollingInterval);
      }
    });
  </script>

  <!-- Footer -->
  <footer style="text-align:center;padding:24px 0;color:#ffffff;font-size:14px;margin-top:24px;">
    <p style="margin:0 0 8px;">Made with ‚ù§Ô∏è for local cricket matches.</p>
    <p style="margin:0;opacity:0.9;">¬© 2025 CricketBook ‚Äî Realtime Cricket Scoring Tool</p>
  </footer>

</body>
</html>
