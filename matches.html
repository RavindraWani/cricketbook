<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Resource hints for faster loading -->
  <link rel="preconnect" href="https://www.googletagmanager.com">
  <link rel="preconnect" href="https://www.gstatic.com">
  <link rel="dns-prefetch" href="https://www.googletagmanager.com">
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7X5LQ6WESD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-7X5LQ6WESD');
</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Primary Meta Tags -->
  <meta name="description" content="Browse all cricket matches - view live scores, recent results, and match history. Access ongoing games and completed tournaments from your cricket community.">
  <meta name="keywords" content="my cricket matches, cricket match history, saved cricket matches, cricket match list, cricket tournament matches, cricket match results, previous cricket matches, cricket score history, cricket match archive">
  <meta name="author" content="CricketBook">
  <meta name="robots" content="index, follow">
  <meta name="language" content="English">
  <meta name="revisit-after" content="1 days">
  <meta name="theme-color" content="#667eea">
  <link rel="canonical" href="https://cricketbook.digital/matches.html">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://cricketbook.digital/matches.html">
  <meta property="og:title" content="My Cricket Matches - Live Scores & Results | CricketBook">
  <meta property="og:description" content="View your cricket matches with live scores, results, and match history. Access all your games in one place.">
  <meta property="og:image" content="https://cricketbook.digital/og-image-matches.png">
  <meta property="og:site_name" content="CricketBook">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://cricketbook.digital/matches.html">
  <meta name="twitter:title" content="My Cricket Matches - Live Scores & Results">
  <meta name="twitter:description" content="View your cricket matches with live scores and results.">
  <meta name="twitter:image" content="https://cricketbook.digital/twitter-image-matches.png">
  
  <!-- Additional SEO -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="My Matches">
  
  <link rel="manifest" href="manifest.json">
  <title>All Cricket Matches - Live Scores & Results | CricketBook</title>
  
  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "My Cricket Matches",
    "description": "View your cricket match history with live scores and results",
    "url": "https://cricketbook.digital/matches.html"
  }
  </script>
  <style>
    :root {
      /* Light mode (default) */
      --bg-gradient-start: #667eea;
      --bg-gradient-end: #764ba2;
      --card-bg: #ffffff;
      --card-border: rgba(148,163,184,.2);
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --text-tertiary: #94a3b8;
      --nav-text: #ffffff;
      --badge-bg: rgba(255, 255, 255, 0.15);
      --badge-border: rgba(255, 255, 255, 0.1);
      --badge-hover: rgba(255, 255, 255, 0.25);
    }
    
    [data-theme="dark"] {
      /* Dark mode */
      --bg-gradient-start: #1e293b;
      --bg-gradient-end: #0f172a;
      --card-bg: #1e293b;
      --card-border: rgba(71,85,105,.3);
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-tertiary: #64748b;
      --nav-text: #f1f5f9;
      --badge-bg: rgba(255, 255, 255, 0.1);
      --badge-border: rgba(255, 255, 255, 0.05);
      --badge-hover: rgba(255, 255, 255, 0.2);
    }
    
    /* Dark mode styles for points table */
    [data-theme="dark"] .points-table-container {
      background: var(--card-bg);
      box-shadow: 0 10px 40px rgba(0,0,0,.3), 0 2px 8px rgba(0,0,0,.2);
    }
    
    [data-theme="dark"] .points-table td {
      border-bottom: 1px solid rgba(71,85,105,.4);
      color: var(--text-primary);
    }
    
    [data-theme="dark"] .points-table td:first-child {
      color: var(--text-primary);
    }
    
    [data-theme="dark"] .points-table tbody tr:hover {
      background: rgba(71,85,105,.2);
    }
    
    [data-theme="dark"] .nrr-breakdown {
      background: rgba(71,85,105,.15);
    }
    
    [data-theme="dark"] .nrr-breakdown td {
      border-bottom: 1px solid rgba(71,85,105,.4);
      color: var(--text-secondary);
    }
    
    [data-theme="dark"] .nrr-formula {
      background: rgba(71,85,105,.25);
      border-left-color: #8b5cf6;
    }
    
    [data-theme="dark"] .nrr-formula-title {
      color: var(--text-primary);
    }
    
    [data-theme="dark"] .toggle-nrr {
      color: #a78bfa;
    }
    
    [data-theme="dark"] .toggle-nrr:hover {
      color: #c4b5fd;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      min-height: 100vh;
      padding: 18px;
      color: var(--text-primary);
      transition: background 0.3s ease, color 0.3s ease;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .matches-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    @media (max-width: 768px) {
      .matches-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .header {
      text-align: center;
      margin-bottom: 16px;
      color: white;
    }
    
    .header h1 {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 4px;
    }
    
    .header p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .section {
      margin-bottom: 16px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: white;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,.12), 0 2px 8px rgba(0,0,0,.08);
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 50px rgba(0,0,0,.15), 0 4px 12px rgba(0,0,0,.1);
    }
    
    [data-theme="dark"] .card:hover {
      box-shadow: 0 15px 50px rgba(0,0,0,.3), 0 4px 12px rgba(0,0,0,.2);
    }
    
    .ongoing-card {
      background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
      color: white;
      border: none;
    }
    
    .ongoing-card .match-title {
      color: white;
    }
    
    .ongoing-card .match-score {
      color: rgba(255,255,255,0.95);
    }
    
    .ongoing-badge {
      display: inline-block;
      background: rgba(255,255,255,0.3);
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 6px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .match-title {
      font-size: 17px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    
    .match-score {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      line-height: 1.6;
    }
    
    .match-meta {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .btn {
      display: inline-block;
      padding: 8px 16px;
      background: #8b5cf6;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .btn:hover {
      background: #7c3aed;
      transform: scale(1.05);
    }
    
    .btn-primary {
      background: white;
      color: #10b981;
    }
    
    .btn-primary:hover {
      background: rgba(255,255,255,0.9);
      color: #059669;
    }
    
    .loading {
      text-align: center;
      color: white;
      font-size: 18px;
      padding: 40px;
    }
    
    .empty-state {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 40px 20px;
      text-align: center;
      color: var(--text-secondary);
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }
    
    .error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      margin-top: 20px;
    }
    
    [data-theme="dark"] .error {
      background: rgba(239,68,68,0.15);
      border-color: rgba(239,68,68,0.3);
      color: #fca5a5;
    }
    
    /* Navigation */
    .nav-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding: 0 5px;
      position: relative;
      z-index: 1001;
    }

    .nav-title {
      font-size: 20px;
      font-weight: 800;
      color: var(--nav-text);
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: block;
    }

    .nav-title:hover {
      transform: scale(1.05);
      text-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .nav-toggle {
      background: var(--badge-bg);
      border: 1px solid var(--badge-border);
      color: var(--nav-text);
      font-size: 24px;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      z-index: 1002;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-toggle:hover {
      background: var(--badge-hover);
    }

    .nav-toggle .hamburger {
      display: block;
    }

    .nav-toggle .close {
      display: none;
      font-size: 28px;
    }

    .nav-toggle.active .hamburger {
      display: none;
    }

    .nav-toggle.active .close {
      display: block;
    }

    /* Navigation Overlay Backdrop */
    .nav-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .nav-backdrop.active {
      display: block;
      opacity: 1;
    }

    /* Navigation Links Overlay */
    .nav-links {
      position: fixed;
      top: 0;
      right: -300px;
      width: 280px;
      height: 100vh;
      background: linear-gradient(180deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      border-left: 1px solid var(--badge-border);
      padding: 80px 20px 20px;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      overflow-y: auto;
      transition: right 0.3s ease;
    }
    
    .nav-links.active {
      right: 0;
    }
    
    .nav-links a {
      display: block;
      color: var(--nav-text);
      text-decoration: none;
      padding: 14px 18px;
      margin: 8px 0;
      border-radius: 10px;
      background: var(--badge-bg);
      backdrop-filter: blur(10px);
      font-weight: 600;
      font-size: 15px;
      transition: all 0.2s;
      white-space: nowrap;
      border: 1px solid var(--badge-border);
    }
    
    .nav-links a:hover {
      background: var(--badge-hover);
      transform: translateX(-4px);
      border-color: var(--badge-border);
    }
    
    .nav-links a.active {
      background: var(--badge-hover);
      border-color: var(--badge-border);
      box-shadow: 0 0 0 2px var(--badge-border);
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
      .nav-links {
        width: 100%;
        right: -100%;
      }
    }
    
    .new-match-btn {
      background: #10b981;
      width: 100%;
      text-align: center;
      margin-top: 12px;
      display: block;
      padding: 10px 16px;
    }
    
    .new-match-btn:hover {
      background: #059669;
    }
    
    .export-btn {
      background: #10b981;
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      margin-top: 12px;
    }
    
    .export-btn:hover {
      background: #059669;
      transform: scale(1.05);
    }
    
    /* Points Table Styling */
    .points-table-container {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,.12), 0 2px 8px rgba(0,0,0,.08);
      overflow-x: auto;
      transition: all 0.3s ease;
    }
    
    .points-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .points-table thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .points-table th {
      padding: 12px 8px;
      text-align: center;
      font-weight: 700;
      font-size: 13px;
      white-space: nowrap;
    }
    
    .points-table th:first-child {
      text-align: left;
      padding-left: 16px;
    }
    
    .points-table td {
      padding: 14px 8px;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .points-table td:first-child {
      text-align: left;
      font-weight: 600;
      padding-left: 16px;
      color: #1f2937;
    }
    
    .points-table tbody tr:hover {
      background: #f9fafb;
    }
    
    .points-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .rank-cell {
      font-weight: 700;
      color: #8b5cf6;
      font-size: 15px;
    }
    
    .nrr-positive {
      color: #10b981;
      font-weight: 600;
    }
    
    .nrr-negative {
      color: #ef4444;
      font-weight: 600;
    }
    
    .points-cell {
      font-weight: 700;
      color: #667eea;
      font-size: 16px;
    }
    
    .nrr-breakdown {
      display: none;
      background: #f9fafb;
      font-size: 12px;
      line-height: 1.6;
    }
    
    .nrr-breakdown.show {
      display: table-row;
    }
    
    .nrr-breakdown td {
      padding: 16px !important;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .nrr-formula {
      background: white;
      padding: 12px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      margin-top: 8px;
    }
    
    .nrr-formula-title {
      font-weight: 700;
      color: #667eea;
      margin-bottom: 8px;
      font-size: 13px;
    }
    
    .nrr-calc-step {
      margin: 6px 0;
      color: #4b5563;
    }
    
    .nrr-calc-step strong {
      color: #1f2937;
    }
    
    .toggle-nrr {
      cursor: pointer;
      color: #667eea;
      font-size: 11px;
      margin-left: 6px;
      text-decoration: none;
      font-weight: 600;
      user-select: none;
    }
    
    .toggle-nrr:hover {
      color: #764ba2;
      text-decoration: underline;
    }
    
    @media (max-width: 768px) {
      .points-table {
        font-size: 12px;
      }
      
      .points-table th,
      .points-table td {
        padding: 10px 6px;
      }
      
      .points-table th:first-child,
      .points-table td:first-child {
        padding-left: 10px;
      }
      
      .points-table th {
        font-size: 11px;
      }
      
      .nrr-breakdown {
        font-size: 11px;
      }
      
      .nrr-formula {
        padding: 10px;
      }
    }
    
    /* Dark Mode Toggle */
    .theme-toggle {
      background: var(--badge-bg);
      border: 1px solid var(--badge-border);
      color: var(--nav-text);
      font-size: 20px;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
    }
    
    .theme-toggle:hover {
      background: var(--badge-hover);
      transform: scale(1.05);
    }
    
    .theme-toggle:active {
      transform: scale(0.95);
    }
  </style>
  <script>
    // Dark Mode Management (Global)
    function initTheme() {
      const savedTheme = localStorage.getItem('cricketbook_theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);
    }
    
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('cricketbook_theme', newTheme);
      updateThemeIcon(newTheme);
      console.log('🌓 Theme switched to:', newTheme);
    }
    
    function updateThemeIcon(theme) {
      const themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {
        themeToggle.textContent = theme === 'dark' ? '🌞' : '🌜';
        themeToggle.title = theme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
      }
    }
    
    initTheme();
    
    // Toggle mobile navigation
    function toggleNav() {
      const navLinks = document.getElementById('navLinks');
      const navBackdrop = document.getElementById('navBackdrop');
      const navToggle = document.querySelector('.nav-toggle');
      
      navLinks.classList.toggle('active');
      navBackdrop.classList.toggle('active');
      navToggle.classList.toggle('active');
      
      // Prevent body scroll when nav is open
      if (navLinks.classList.contains('active')) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    }
  </script>
</head>
<body>
  <div class="container">
    <!-- Navigation -->
    <div class="nav-backdrop" id="navBackdrop" onclick="toggleNav()"></div>
    <div class="nav-header">
      <a href="index.html" class="nav-title">🏏 CricketBook</a>
      <div style="display: flex; align-items: center;">
        <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle Dark Mode">
          🌜
        </button>
        <button class="nav-toggle" onclick="toggleNav()">
          <span class="hamburger">☰</span>
          <span class="close">×</span>
        </button>
      </div>
    </div>
    <nav class="nav-links" id="navLinks">
      <a href="index.html">🏠 Home</a>
      <a href="livescore.html">📺 Live Score</a>
      <a href="matches.html" class="active">📋 My Matches</a>
      <a href="allmatches.html">🌍 All Matches</a>
      <a href="about.html">ℹ️ About</a>
    </nav>
    
    <!-- Breadcrumb Navigation -->
    <div id="breadcrumb" style="display:none;max-width:1200px;margin:0 auto;padding:12px 16px;">
      <a href="matches.html" style="color:rgba(255,255,255,0.9);text-decoration:none;font-size:13px;font-weight:600;display:inline-flex;align-items:center;gap:6px;transition:all 0.2s;" onmouseover="this.style.color='#fff';this.style.transform='translateX(-2px)'" onmouseout="this.style.color='rgba(255,255,255,0.9)';this.style.transform='translateX(0)'">
        ← Back to All My Matches
      </a>
    </div>
    
    <div class="header">
      <h1 id="pageHeader">🏏 CricketBook</h1>
      <p id="pageSubheader">All Matches</p>
      <div id="tournamentStats" style="display:none;margin-top:8px;font-size:13px;opacity:0.9;font-weight:500;"></div>
      <div id="shareButtonContainer" style="display:none;margin-top:12px;">
        <button onclick="shareTournamentLink()" style="background:rgba(255,255,255,0.2);border:2px solid rgba(255,255,255,0.3);color:#fff;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px;backdrop-filter:blur(10px);" onmouseover="this.style.background='rgba(255,255,255,0.3)';this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.2)';this.style.transform='translateY(0)';this.style.boxShadow='none'">
          <span style="font-size:16px;">🔗</span>
          <span>Share Tournament</span>
        </button>
      </div>
    </div>
    
    <div class="loading" id="loading">Loading matches...</div>
    
    <div id="content" style="display:none">
      <!-- Points Table Section (League Matches Only) -->
      <div id="pointsTableSection" class="section" style="display:none">
        <div class="section-title" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
          <span>🏆 League Standings</span>
          <div style="display:flex;align-items:center;gap:8px;">
            <span id="lastUpdated" style="font-size:11px;opacity:0.8;font-weight:400;"></span>
            <button onclick="location.reload()" style="background:rgba(255,255,255,0.25);border:none;color:white;padding:6px 14px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;backdrop-filter:blur(10px);">
              🔄 Refresh
            </button>
          </div>
        </div>
        <div class="points-table-container">
          <table class="points-table">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Team</th>
                <th title="Matches Played">M</th>
                <th title="Wins">W</th>
                <th title="Losses">L</th>
                <th title="No Result">NR</th>
                <th title="Net Run Rate">NRR</th>
                <th title="Points">Pts</th>
              </tr>
            </thead>
            <tbody id="pointsTableBody">
              <!-- Points table rows will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Ongoing Match Section -->
      <div id="ongoingSection" class="section" style="display:none">
        <div class="section-title">
          ⚡ Live Match
        </div>
        <div id="ongoingMatch"></div>
      </div>
      
      <!-- Recent Matches Section -->
      <div id="recentSection" class="section">
        <div class="section-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>📋 Recent Matches</span>
          <a id="exportCsvBtn" href="javascript:void(0);" onclick="exportToCSV()" style="display:none;color:white;text-decoration:none;font-size:13px;opacity:0.9;font-weight:400;">
            Export CSV →
          </a>
        </div>
        <div id="recentMatches" class="matches-grid"></div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-database-compat.js"></script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAFfwgHq761oFMg4CVqmZezGR_WK6ZGvAY",
      authDomain: "cricketbook-35725.firebaseapp.com",
      databaseURL: "https://cricketbook-35725-default-rtdb.firebaseio.com",
      projectId: "cricketbook-35725",
      storageBucket: "cricketbook-35725.firebasestorage.app",
      messagingSenderId: "128747950424",
      appId: "1:128747950424:web:dce02e8420c353f1acd52d"
    };

    // Initialize Firebase (check if firebase is loaded)
    let database;
    if (typeof firebase !== 'undefined') {
      firebase.initializeApp(firebaseConfig);
      database = firebase.database();
    } else {
      console.error('❌ Firebase SDK not loaded');
    }

    // Global variable to store matches for export
    let allMatchesData = [];
    let pollingInterval = null; // For polling instead of continuous listener
    let openNRRBreakdowns = new Set(); // Track which NRR breakdowns are open
    let lastActivityTime = Date.now(); // Track last user activity
    let isPollingPaused = false; // Track if polling is paused
    
    // Get all user matches from localStorage
    function getAllUserMatches() {
      try {
        const allMatchesJson = localStorage.getItem('cricketbook_all_user_matches');
        if (allMatchesJson) {
          return JSON.parse(allMatchesJson);
        }
        return [];
      } catch (error) {
        console.error('❌ Error loading user matches:', error);
        return [];
      }
    }

    // Check if org parameter is in URL (from share link)
    const urlParams = new URLSearchParams(window.location.search);
    const urlOrgId = urlParams.get('org');
    
    // Organization ID for multi-user isolation
    let organizationId = localStorage.getItem('cricketbook_org_id');
    
    if (urlOrgId) {
      // Share link with org ID - save it to localStorage
      organizationId = urlOrgId;
      localStorage.setItem('cricketbook_org_id', organizationId);
      console.log('🔗 Using Organization ID from URL and saved to localStorage:', organizationId);
    }
    
    // Check if user has any matches in history
    const userMatches = getAllUserMatches();
    
    if (!organizationId && userMatches.length === 0) {
      // No org ID and no match history - show welcome message
      console.warn('⚠️ No Organization ID found and no match history. Please start a match first.');
      document.getElementById('loading').innerHTML = '<div class="empty-state"><div class="empty-state-icon">🏏</div><div style="font-size:20px;font-weight:800;margin-bottom:8px;color:#1f2937;">Welcome to CricketBook!</div><div style="color:#6b7280;font-size:14px;line-height:1.6;margin-bottom:20px;">Your match history will appear here once you start scoring.<br>Let\'s get started with your first cricket match!</div><a href="index.html" class="btn new-match-btn" style="max-width:320px;margin:0 auto;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;padding:12px 28px;border-radius:12px;text-decoration:none;display:inline-block;font-weight:700;box-shadow:0 4px 12px rgba(102,126,234,0.3);transition:all 0.2s;">🏠 Go to Home & Start Match</a></div>';
      document.getElementById('loading').style.display = 'block';
      document.getElementById('content').style.display = 'none';
    } else {
      // Has org ID or has match history - load matches
      console.log('✅ Loading matches - orgId:', organizationId, '| User match history:', userMatches.length);
      
      // Load all matches with real-time sync
      loadMatches();
    }
    
    // Update page header with tournament name
    function updatePageHeader(matchesArray) {
      if (!matchesArray || matchesArray.length === 0) return;
      
      // Calculate match stats
      const totalMatches = matchesArray.length;
      const completedMatches = matchesArray.filter(m => m.matchCompleted || (m.resultText && m.resultText.trim() !== '')).length;
      const liveMatches = matchesArray.filter(m => !m.matchCompleted && (!m.resultText || m.resultText.trim() === '')).length;
      
      // Get tournament name from first match (all should be same tournament if org ID provided)
      const tournamentName = matchesArray[0]?.tournamentName;
      const urlOrgId = new URLSearchParams(window.location.search).get('org');
      
      if (tournamentName && tournamentName.trim() !== '') {
        // Tournament matches - customize header
        document.getElementById('pageHeader').innerHTML = `🏆 ${tournamentName}`;
        document.getElementById('pageSubheader').textContent = 'Tournament Dashboard';
        
        // Show tournament stats
        document.getElementById('tournamentStats').innerHTML = `${totalMatches} ${totalMatches === 1 ? 'Match' : 'Matches'} • ${completedMatches} Completed • ${liveMatches} Live`;
        document.getElementById('tournamentStats').style.display = 'block';
        
        // Show share button
        document.getElementById('shareButtonContainer').style.display = 'block';
        
        // Show breadcrumb only if viewing via org parameter (shared link)
        if (urlOrgId) {
          document.getElementById('breadcrumb').style.display = 'block';
        }
        
        // Update page title
        document.title = `${tournamentName} - Tournament Dashboard | CricketBook`;
      } else {
        // Quick matches - check if multiple tournaments
        const tournamentNames = new Set();
        matchesArray.forEach(match => {
          if (match.tournamentName && match.tournamentName.trim() !== '') {
            tournamentNames.add(match.tournamentName);
          }
        });
        
        if (tournamentNames.size === 1) {
          // Single tournament in history
          const name = Array.from(tournamentNames)[0];
          document.getElementById('pageHeader').innerHTML = `🏆 ${name}`;
          document.getElementById('pageSubheader').textContent = 'Tournament Dashboard';
          
          // Show tournament stats
          document.getElementById('tournamentStats').innerHTML = `${totalMatches} ${totalMatches === 1 ? 'Match' : 'Matches'} • ${completedMatches} Completed • ${liveMatches} Live`;
          document.getElementById('tournamentStats').style.display = 'block';
          
          // Show share button
          document.getElementById('shareButtonContainer').style.display = 'block';
          
          document.title = `${name} - Tournament Dashboard | CricketBook`;
        } else if (tournamentNames.size > 1) {
          // Multiple tournaments
          document.getElementById('pageHeader').textContent = '🏏 My Tournaments';
          document.getElementById('pageSubheader').textContent = `${tournamentNames.size} Active Tournaments`;
          
          // Show overall stats
          document.getElementById('tournamentStats').innerHTML = `${totalMatches} Total Matches • ${completedMatches} Completed • ${liveMatches} Live`;
          document.getElementById('tournamentStats').style.display = 'block';
        } else {
          // Only quick matches (no tournament names)
          document.getElementById('tournamentStats').innerHTML = `${totalMatches} ${totalMatches === 1 ? 'Match' : 'Matches'} • ${completedMatches} Completed • ${liveMatches} Live`;
          document.getElementById('tournamentStats').style.display = 'block';
        }
        // Hide breadcrumb for personal view
        document.getElementById('breadcrumb').style.display = 'none';
      }
    }
    
    function loadMatches() {
    // Use polling instead of continuous listener to reduce active connections
    const pollMatches = () => {
      // Get all user matches from localStorage (refresh each poll)
      const userMatches = getAllUserMatches();
      console.log('💾 User has', userMatches.length, 'matches in localStorage history');
      
      // Load from Firebase for all orgIds user has created matches in
      const orgIds = new Set();
      if (organizationId) {
        orgIds.add(organizationId);
      }
      userMatches.forEach(match => {
        if (match.organizationId) {
          orgIds.add(match.organizationId);
        }
      });
      
      console.log('🎯 Loading matches from', orgIds.size, 'organizations:', Array.from(orgIds));
      
      // If no orgIds found, show empty state
      if (orgIds.size === 0) {
        console.log('⚠️ No organization IDs found in history');
        document.getElementById('loading').innerHTML = '<div class="empty-state"><div class="empty-state-icon">🏏</div><div style="font-size:18px;font-weight:700;margin-bottom:8px;color:#1f2937;">No Matches Found</div><div style="color:#6b7280;font-size:14px;line-height:1.6;margin-bottom:20px;">Your match history is empty right now.<br>Start scoring your first match and build your cricket record!</div><a href="index.html" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;padding:12px 28px;border-radius:12px;text-decoration:none;display:inline-block;font-weight:700;box-shadow:0 4px 12px rgba(102,126,234,0.3);transition:all 0.2s;">🏠 Go to Home & Start Scoring</a></div>';
        document.getElementById('loading').style.display = 'block';
        document.getElementById('content').style.display = 'none';
        return;
      }
      
      // Build promises for all orgIds
      const promises = [];
      orgIds.forEach(orgId => {
        promises.push(database.ref('tournaments/' + orgId + '/matches').once('value'));
        promises.push(database.ref('quickMatches/' + orgId + '/matches').once('value'));
      });
      
      // Load all matches from all user's organizations
      Promise.all(promises).then((snapshots) => {
        let allMatches = {};
        
        snapshots.forEach(snapshot => {
          const matches = snapshot.val() || {};
          allMatches = { ...allMatches, ...matches };
        });
        
        console.log('📊 Loaded total matches from Firebase:', Object.keys(allMatches).length);
        
        if (Object.keys(allMatches).length === 0) {
          document.getElementById('loading').innerHTML = '<div class="empty-state"><div class="empty-state-icon">🏏</div><div style="font-size:18px;font-weight:700;margin-bottom:8px;color:#1f2937;">No Matches Found</div><div style="color:#6b7280;font-size:14px;line-height:1.6;margin-bottom:20px;">Your match history is empty right now.<br>Start scoring your first match and build your cricket record!</div><a href="index.html" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;padding:12px 28px;border-radius:12px;text-decoration:none;display:inline-block;font-weight:700;box-shadow:0 4px 12px rgba(102,126,234,0.3);transition:all 0.2s;">🏠 Go to Home & Start Scoring</a></div>';
          document.getElementById('loading').style.display = 'block';
          document.getElementById('content').style.display = 'none';
          return;
        }
      
      // Convert to array and sort by lastUpdated timestamp (newest first)
      const matchesArray = Object.keys(allMatches).map(matchId => ({
        matchId: matchId,
        ...allMatches[matchId]
      })).sort((a, b) => {
        // Use lastUpdated (numeric timestamp) for sorting, fallback to 0
        const timeA = a.lastUpdated || 0;
        const timeB = b.lastUpdated || 0;
        return timeB - timeA;
      });
      
      console.log('📋 Sorted matches array:', matchesArray); // Debug log
      
      // Store matches globally for export
      allMatchesData = matchesArray;
      
      // Update header with tournament name if available
      updatePageHeader(matchesArray);
      
      // Show export button if there are matches
      if (matchesArray.length > 0) {
        document.getElementById('exportCsvBtn').style.display = 'inline-block';
      }
      
      // Detect ongoing match (most recent match that's not completed)
      const ongoingMatch = matchesArray.find(match => {
        // Check if match has been explicitly marked as completed
        if (match.matchCompleted) {
          return false; // Skip completed matches
        }
        
        // Also check if there's a result text (means match is completed)
        if (match.resultText && match.resultText.trim() !== '') {
          return false; // Skip matches with results
        }
        
        // Check if match is still in progress (not both innings done)
        const firstDone = match.first?.done || false;
        const secondDone = match.second?.done || false;
        const inSecond = match.inSecond || false;
        
        // If in first innings and not done, or in second innings and not done
        return (!inSecond && !firstDone) || (inSecond && !secondDone);
      });
      
      console.log('⚡ Ongoing match:', ongoingMatch); // Debug log
      
      // Display ongoing match
      if (ongoingMatch) {
        displayOngoingMatch(ongoingMatch);
        document.getElementById('ongoingSection').style.display = 'block';
      } else {
        document.getElementById('ongoingSection').style.display = 'none';
      }
      
      // Calculate and display points table for League matches
      calculatePointsTable(matchesArray);
      
      // Update last updated timestamp
      const now = new Date();
      const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      const lastUpdatedEl = document.getElementById('lastUpdated');
      if (lastUpdatedEl) {
        lastUpdatedEl.textContent = `Updated: ${timeStr}`;
      }
      
      // Display recent 50 matches
      const recentMatches = matchesArray.slice(0, 50);
      displayRecentMatches(recentMatches);
      
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';
      
    }).catch((error) => {
      console.error('❌ Firebase error:', error); // Debug log
      
      // Check if it's a connection limit error
      if (error.code === 'PERMISSION_DENIED' || error.message.includes('connection') || error.message.includes('limit')) {
        document.getElementById('loading').innerHTML = `
          <div class="error" style="padding:32px;text-align:center;">
            <div style="font-size:48px;margin-bottom:16px;">⚠️</div>
            <h2 style="color:#ef4444;font-size:22px;margin-bottom:12px;">Connection Limit Reached</h2>
            <p style="margin-bottom:20px;">Too many people are browsing matches right now! 🏏</p>
            <p style="margin-bottom:24px;font-size:14px;">Please wait a few minutes and try again.</p>
            <button onclick="location.reload()" style="background:#8b5cf6;color:white;border:none;padding:12px 28px;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;">
              🔄 Try Again
            </button>
          </div>
        `;
        
        // Stop polling
        if (pollingInterval) {
          clearInterval(pollingInterval);
        }
      } else {
        document.getElementById('loading').innerHTML = '<div class="error">Error loading matches: ' + error.message + '</div>';
      }
    });
    };
    
    // Initial load
    pollMatches();
    
    // Poll every 5 minutes for updates (instead of continuous listener)
    pollingInterval = setInterval(pollMatches, 300000);
    
    console.log('✅ Polling enabled (every 5 minutes) - reduced active connections');
    
    // Inactivity checker - pause polling after 15 minutes of inactivity
    setInterval(() => {
      const inactiveTime = Date.now() - lastActivityTime;
      const fifteenMinutes = 15 * 60 * 1000;
      
      if (inactiveTime > fifteenMinutes && !isPollingPaused) {
        console.log('⏸️ Pausing polling due to 15 min inactivity');
        if (pollingInterval) {
          clearInterval(pollingInterval);
          pollingInterval = null;
          isPollingPaused = true;
        }
      }
    }, 30000); // Check every 30 seconds
    
    // Track user activity to reset inactivity timer
    ['mousedown', 'keydown', 'scroll', 'touchstart', 'click'].forEach(event => {
      document.addEventListener(event, () => {
        lastActivityTime = Date.now();
        
        // Resume polling if it was paused
        if (isPollingPaused) {
          console.log('▶️ Resuming polling - user activity detected');
          isPollingPaused = false;
          pollMatches(); // Immediate refresh
          pollingInterval = setInterval(pollMatches, 300000);
        }
      }, { passive: true });
    });
    
    // Pause polling when page is hidden (user switched tabs)
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        console.log('👁️ Page hidden - pausing polling');
        if (pollingInterval) {
          clearInterval(pollingInterval);
          pollingInterval = null;
        }
      } else {
        console.log('👁️ Page visible - resuming polling');
        lastActivityTime = Date.now(); // Reset activity timer
        isPollingPaused = false;
        pollMatches(); // Immediate refresh
        pollingInterval = setInterval(pollMatches, 300000);
      }
    });
    }
    
    function displayOngoingMatch(match) {
      const section = document.getElementById('ongoingSection');
      const container = document.getElementById('ongoingMatch');
      
      const firstScore = `${match.first?.runs || 0}/${match.first?.wkts || 0}`;
      const firstOvers = calculateOvers(match.first?.legalBalls || 0);
      const secondScore = `${match.second?.runs || 0}/${match.second?.wkts || 0}`;
      const secondOvers = calculateOvers(match.second?.legalBalls || 0);
      
      const isBattingFirst = !match.inSecond;
      
      const matchTypeText = match.matchType ? ` - ${match.matchType}` : '';
      
      // Check if it's a quick match or tournament match
      const isQuickMatch = !match.tournamentName || match.tournamentName.trim() === '';
      const tournamentBadge = isQuickMatch
        ? `<div style="font-size:11px;color:#fef08a;font-weight:800;margin-bottom:4px;letter-spacing:0.3px;background:rgba(254,240,138,0.2);padding:4px 10px;border-radius:12px;border:1px solid rgba(254,240,138,0.5);">⚡ Quick Match</div>`
        : `<div style="font-size:11px;color:#fef08a;font-weight:800;margin-bottom:4px;letter-spacing:0.3px;">#${match.tournamentName}${matchTypeText}</div>`;
      
      container.innerHTML = `
        <div class="card ongoing-card" onclick="window.location.href='livescore.html?org=${match.organizationId}&match=${match.matchId}'" style="cursor:pointer;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
            <div style="flex: 1; min-width: 0;">
              <div class="ongoing-badge">🔴 LIVE NOW</div>
              ${tournamentBadge}
              <div class="match-title">${match.teamA || 'Team A'} vs ${match.teamB || 'Team B'}</div>
              <div class="match-score">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span><strong>${match.teamA || 'Team A'}:</strong></span>
                  <span style="font-weight: 600;">${firstScore} (${firstOvers})</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span><strong>${match.teamB || 'Team B'}:</strong></span>
                  <span style="font-weight: 600;">${secondScore} (${secondOvers})</span>
                </div>
                <div style="margin-top: 6px;">
                  ${isBattingFirst ? '🏏 Batting: ' + (match.teamA || 'Team A') : '🏏 Batting: ' + (match.teamB || 'Team B')}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      section.style.display = 'block';
    }
    
    function displayRecentMatches(matches) {
      const container = document.getElementById('recentMatches');
      
      if (matches.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🏏</div><div style="font-size:16px;font-weight:600;color:#6b7280;">No matches to display</div></div>';
        return;
      }
      
      container.innerHTML = matches.map(match => {
        const firstScore = `${match.first?.runs || 0}/${match.first?.wkts || 0}`;
        const firstOvers = calculateOvers(match.first?.legalBalls || 0);
        const secondScore = `${match.second?.runs || 0}/${match.second?.wkts || 0}`;
        const secondOvers = calculateOvers(match.second?.legalBalls || 0);
        
        const hasResult = match.resultText && match.resultText.trim() !== '';
        const isComplete = match.first?.done && match.second?.done;
        
        // Check if match is inactive (no update in 15+ minutes)
        const currentTime = Date.now();
        const lastUpdate = match.lastUpdated || match.timestamp || 0;
        const minutesSinceUpdate = (currentTime - lastUpdate) / (1000 * 60);
        const isInactive = minutesSinceUpdate >= 15;
        
        let statusBadge = '';
        if (hasResult) {
          statusBadge = '<span style="display:inline-block;background:#10b981;color:white;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:600;margin-left:8px;">✅ Completed</span>';
        } else if (!match.matchCompleted && !hasResult) {
          // Check if match is paused/inactive
          if (isInactive) {
            statusBadge = '<span style="display:inline-block;background:#9333ea;color:white;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:600;margin-left:8px;">⚠️ Stalled</span>';
          } else {
            // Show LIVE badge for any ongoing match (first or second innings)
            statusBadge = '<span style="display:inline-block;background:#f59e0b;color:white;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:600;margin-left:8px;">🏏 LIVE</span>';
          }
        }
        
        const dateStr = match.timestamp ? new Date(match.timestamp).toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) : '';
        
        // Format start date
        const startDate = match.timestamp ? new Date(match.timestamp) : null;
        const startDateStr = startDate ? startDate.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) : 'N/A';
        
        // Format end date and calculate duration
        const endDate = match.lastUpdated ? new Date(match.lastUpdated) : null;
        const endDateStr = endDate ? endDate.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) : 'N/A';
        
        // Calculate duration
        let durationStr = '';
        const completed = hasResult || isComplete;
        if (startDate && endDate && completed) {
          const durationMs = endDate - startDate;
          const durationMinutes = Math.floor(durationMs / (1000 * 60));
          const durationHours = Math.floor(durationMinutes / 60);
          const remainingMinutes = durationMinutes % 60;
          
          if (durationHours > 0) {
            durationStr = `⏱️ ${durationHours}h ${remainingMinutes}m`;
          } else {
            durationStr = `⏱️ ${durationMinutes}m`;
          }
        } else if (!completed && startDate) {
          // For live matches, show ongoing duration
          const durationMs = Date.now() - startDate.getTime();
          const durationMinutes = Math.floor(durationMs / (1000 * 60));
          const durationHours = Math.floor(durationMinutes / 60);
          const remainingMinutes = durationMinutes % 60;
          
          if (durationHours > 0) {
            durationStr = `⏱️ ${durationHours}h ${remainingMinutes}m (ongoing)`;
          } else {
            durationStr = `⏱️ ${durationMinutes}m (ongoing)`;
          }
        }
        
        const matchTypeText = match.matchType ? ` - ${match.matchType}` : '';
        
        // Check if it's a quick match or tournament match
        const isQuickMatch = !match.tournamentName || match.tournamentName.trim() === '';
        const tournamentBadge = isQuickMatch
          ? `<div style="font-size:11px;color:#f59e0b;font-weight:800;margin-bottom:4px;letter-spacing:0.3px;display:inline-block;background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);padding:3px 10px;border-radius:12px;border:1px solid #fbbf24;">⚡ Quick Match</div>`
          : `<div style="font-size:11px;color:#667eea;font-weight:800;margin-bottom:4px;letter-spacing:0.3px;">#${match.tournamentName}${matchTypeText}</div>`;
        
        return `
          <div class="card" onclick="window.location.href='livescore.html?org=${match.organizationId}&match=${match.matchId}'" style="cursor:pointer;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
              <div style="flex: 1; min-width: 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 4px;">
                  ${tournamentBadge}
                  ${statusBadge ? `<div style="flex-shrink: 0;">${statusBadge}</div>` : ''}
                </div>
                <div class="match-title">
                  ${match.teamA || 'Team A'} vs ${match.teamB || 'Team B'}
                </div>
                <div class="match-score">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span><strong>${match.teamA || 'Team A'}:</strong></span>
                    <span style="font-weight: 600;">${firstScore} (${firstOvers})</span>
                  </div>
                  <div style="display: flex; justify-content: space-between;">
                    <span><strong>${match.teamB || 'Team B'}:</strong></span>
                    <span style="font-weight: 600;">${secondScore} (${secondOvers})</span>
                  </div>
                  ${hasResult ? '<div style="color:#10b981;font-weight:600;margin-top:6px;padding:4px 8px;background:rgba(16,185,129,0.1);border-radius:6px;display:inline-block;">🏆 ' + match.resultText + '</div>' : ''}
                </div>
                <div class="match-meta" style="margin-top: 8px;">
                  <span>📅 Start: ${startDateStr}</span>
                  ${completed ? `<span>🏁 End: ${endDateStr}</span>` : ''}
                  ${durationStr ? `<span>${durationStr}</span>` : ''}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function calculateOvers(legalBalls) {
      if (!legalBalls) return '0.0';
      const overs = Math.floor(legalBalls / 6);
      const balls = legalBalls % 6;
      return `${overs}.${balls}`;
    }
    
    // Calculate Points Table for League Matches
    function calculatePointsTable(matches) {
      // Filter only League matches that are completed
      const leagueMatches = matches.filter(match => {
        const isLeague = match.matchType && match.matchType.toLowerCase().includes('league');
        
        // Multiple ways to check if match is completed:
        // 1. Explicit matchCompleted flag
        // 2. Has a resultText
        // 3. Both innings are done
        const hasCompletedFlag = match.matchCompleted === true;
        const hasResultText = match.resultText && match.resultText.trim() !== '';
        const bothInningsDone = (match.first?.done === true) && (match.second?.done === true);
        
        const isCompleted = hasCompletedFlag || hasResultText || bothInningsDone;
        
        // Debug logging for League matches
        if (isLeague) {
          console.log(`🏆 League Match: ${match.teamA} vs ${match.teamB}`, {
            matchCompleted: match.matchCompleted,
            resultText: match.resultText,
            firstDone: match.first?.done,
            secondDone: match.second?.done,
            isCompleted: isCompleted
          });
        }
        
        return isLeague && isCompleted;
      });
      
      console.log(`📊 Found ${leagueMatches.length} completed League matches for points table`);
      
      if (leagueMatches.length === 0) {
        document.getElementById('pointsTableSection').style.display = 'none';
        return;
      }
      
      // Build team statistics
      const teamStats = {};
      
      leagueMatches.forEach(match => {
        const teamA = match.teamA || 'Team A';
        const teamB = match.teamB || 'Team B';
        
        // Initialize team stats if not exists
        if (!teamStats[teamA]) {
          teamStats[teamA] = { matches: 0, wins: 0, losses: 0, noResult: 0, totalRunsScored: 0, totalOversPlayed: 0, totalRunsConceded: 0, totalOversBowled: 0 };
        }
        if (!teamStats[teamB]) {
          teamStats[teamB] = { matches: 0, wins: 0, losses: 0, noResult: 0, totalRunsScored: 0, totalOversPlayed: 0, totalRunsConceded: 0, totalOversBowled: 0 };
        }
        
        const firstRuns = match.first?.runs || 0;
        const firstBalls = match.first?.legalBalls || 0;
        const secondRuns = match.second?.runs || 0;
        const secondBalls = match.second?.legalBalls || 0;
        
        console.log(`  📝 Processing: ${teamA} vs ${teamB}`, {
          teamAScore: `${firstRuns}/${match.first?.wkts || 0} (${(firstBalls/6).toFixed(1)} ov)`,
          teamBScore: `${secondRuns}/${match.second?.wkts || 0} (${(secondBalls/6).toFixed(1)} ov)`,
          result: match.resultText || 'No result text'
        });
        
        // In the scorer: first innings is ALWAYS Team A, second innings is ALWAYS Team B
        // So Team A batted in first innings, Team B batted in second innings
        
        // Team A scored firstRuns in firstBalls, conceded secondRuns in secondBalls
        teamStats[teamA].totalRunsScored += firstRuns;
        teamStats[teamA].totalOversPlayed += firstBalls;
        teamStats[teamA].totalRunsConceded += secondRuns;
        teamStats[teamA].totalOversBowled += secondBalls;
        
        // Team B scored secondRuns in secondBalls, conceded firstRuns in firstBalls
        teamStats[teamB].totalRunsScored += secondRuns;
        teamStats[teamB].totalOversPlayed += secondBalls;
        teamStats[teamB].totalRunsConceded += firstRuns;
        teamStats[teamB].totalOversBowled += firstBalls;
        
        // Determine winner from result text
        const resultText = match.resultText || '';
        const resultLower = resultText.toLowerCase();
        
        let winner = null;
        if (resultLower.includes(teamA.toLowerCase()) && (resultLower.includes('won') || resultLower.includes('win'))) {
          winner = teamA;
        } else if (resultLower.includes(teamB.toLowerCase()) && (resultLower.includes('won') || resultLower.includes('win'))) {
          winner = teamB;
        } else if (resultLower.includes('tie') || resultLower.includes('draw') || resultLower.includes('no result')) {
          winner = 'noResult';
        }
        
        // Update match counts
        teamStats[teamA].matches++;
        teamStats[teamB].matches++;
        
        if (winner === teamA) {
          teamStats[teamA].wins++;
          teamStats[teamB].losses++;
        } else if (winner === teamB) {
          teamStats[teamB].wins++;
          teamStats[teamA].losses++;
        } else {
          teamStats[teamA].noResult++;
          teamStats[teamB].noResult++;
        }
      });
      
      // Calculate NRR and Points for each team
      const teamArray = Object.keys(teamStats).map(team => {
        const stats = teamStats[team];
        
        // Calculate Run Rate
        const totalOvers = (stats.totalOversPlayed / 6).toFixed(1);
        const totalOversBowled = (stats.totalOversBowled / 6).toFixed(1);
        const runRateFor = stats.totalOversPlayed > 0 ? (stats.totalRunsScored / (stats.totalOversPlayed / 6)) : 0;
        const runRateAgainst = stats.totalOversBowled > 0 ? (stats.totalRunsConceded / (stats.totalOversBowled / 6)) : 0;
        
        // Net Run Rate = Run Rate For - Run Rate Against
        const nrr = runRateFor - runRateAgainst;
        
        // Points: Win = 2, No Result = 1, Loss = 0
        const points = (stats.wins * 2) + (stats.noResult * 1);
        
        return {
          team,
          matches: stats.matches,
          wins: stats.wins,
          losses: stats.losses,
          noResult: stats.noResult,
          nrr: isNaN(nrr) ? 0 : nrr,
          points,
          // Store calculation details
          nrrDetails: {
            runsScored: stats.totalRunsScored,
            oversPlayed: totalOvers,
            runsConceded: stats.totalRunsConceded,
            oversBowled: totalOversBowled,
            runRateFor: runRateFor.toFixed(3),
            runRateAgainst: runRateAgainst.toFixed(3)
          }
        };
      });
      
      // Sort by: Points (desc), NRR (desc), Wins (desc)
      teamArray.sort((a, b) => {
        if (b.points !== a.points) return b.points - a.points;
        if (b.nrr !== a.nrr) return b.nrr - a.nrr;
        return b.wins - a.wins;
      });
      
      // Display points table
      displayPointsTable(teamArray);
    }
    
    function displayPointsTable(teamArray) {
      const tbody = document.getElementById('pointsTableBody');
      
      if (teamArray.length === 0) {
        document.getElementById('pointsTableSection').style.display = 'none';
        return;
      }
      
      tbody.innerHTML = teamArray.map((team, index) => {
        const nrrClass = team.nrr > 0 ? 'nrr-positive' : (team.nrr < 0 ? 'nrr-negative' : '');
        const nrrDisplay = team.nrr >= 0 ? `+${team.nrr.toFixed(3)}` : team.nrr.toFixed(3);
        const rowId = `team-${team.team.replace(/\s+/g, '-')}`;
        const isOpen = openNRRBreakdowns.has(rowId) ? 'show' : '';
        
        return `
          <tr>
            <td class="rank-cell">${index + 1}</td>
            <td>${team.team}</td>
            <td>${team.matches}</td>
            <td>${team.wins}</td>
            <td>${team.losses}</td>
            <td>${team.noResult}</td>
            <td class="${nrrClass}">
              ${nrrDisplay}
              <a href="javascript:void(0)" class="toggle-nrr" onclick="toggleNRRBreakdown('${rowId}')" title="Show NRR calculation">ⓘ</a>
            </td>
            <td class="points-cell">${team.points}</td>
          </tr>
          <tr class="nrr-breakdown ${isOpen}" id="breakdown-${rowId}">
            <td colspan="8">
              <div class="nrr-formula">
                <div class="nrr-formula-title">📊 NRR Calculation for ${team.team}</div>
                <div class="nrr-calc-step"><strong>Runs Scored:</strong> ${team.nrrDetails.runsScored} runs in ${team.nrrDetails.oversPlayed} overs</div>
                <div class="nrr-calc-step"><strong>Run Rate (For):</strong> ${team.nrrDetails.runsScored} ÷ ${team.nrrDetails.oversPlayed} = <strong>${team.nrrDetails.runRateFor}</strong></div>
                <div class="nrr-calc-step" style="margin-top:12px;"><strong>Runs Conceded:</strong> ${team.nrrDetails.runsConceded} runs in ${team.nrrDetails.oversBowled} overs</div>
                <div class="nrr-calc-step"><strong>Run Rate (Against):</strong> ${team.nrrDetails.runsConceded} ÷ ${team.nrrDetails.oversBowled} = <strong>${team.nrrDetails.runRateAgainst}</strong></div>
                <div class="nrr-calc-step" style="margin-top:12px;padding-top:12px;border-top:2px solid #e5e7eb;"><strong>Net Run Rate:</strong> ${team.nrrDetails.runRateFor} - ${team.nrrDetails.runRateAgainst} = <strong class="${nrrClass}">${nrrDisplay}</strong></div>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      document.getElementById('pointsTableSection').style.display = 'block';
    }
    
    function toggleNRRBreakdown(rowId) {
      const breakdownRow = document.getElementById(`breakdown-${rowId}`);
      if (breakdownRow) {
        breakdownRow.classList.toggle('show');
        
        // Track the state
        if (breakdownRow.classList.contains('show')) {
          openNRRBreakdowns.add(rowId);
        } else {
          openNRRBreakdowns.delete(rowId);
        }
      }
    }
    
    function exportToCSV() {
      if (!allMatchesData || allMatchesData.length === 0) {
        alert('No matches to export!');
        return;
      }
      
      // CSV Headers
      const headers = [
        'Match ID',
        'Tournament Name',
        'Match Type',
        'Date & Time',
        'Team A',
        'Team A Runs',
        'Team A Wickets',
        'Team A Overs',
        'Team B',
        'Team B Runs',
        'Team B Wickets',
        'Team B Overs',
        'Result',
        'Status',
        'Overs Limit'
      ];
      
      // Convert matches to CSV rows
      const rows = allMatchesData.map(match => {
        const firstScore = match.first?.runs || 0;
        const firstWkts = match.first?.wkts || 0;
        const firstOvers = calculateOvers(match.first?.legalBalls || 0);
        
        const secondScore = match.second?.runs || 0;
        const secondWkts = match.second?.wkts || 0;
        const secondOvers = calculateOvers(match.second?.legalBalls || 0);
        
        const dateStr = match.timestamp ? new Date(match.timestamp).toLocaleString('en-US', { 
          year: 'numeric',
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) : '';
        
        const hasResult = match.resultText && match.resultText.trim() !== '';
        let status = 'In Progress';
        if (hasResult) {
          status = 'Completed';
        } else if (match.matchCompleted) {
          status = 'Completed';
        }
        
        return [
          match.matchId || '',
          match.tournamentName || '',
          match.matchType || '',
          dateStr,
          match.teamA || 'Team A',
          firstScore,
          firstWkts,
          firstOvers,
          match.teamB || 'Team B',
          secondScore,
          secondWkts,
          secondOvers,
          match.resultText || '',
          status,
          match.oversLimit || 20
        ];
      });
      
      // Combine headers and rows
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => {
          // Escape cells with commas or quotes
          const cellStr = String(cell);
          if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
            return `"${cellStr.replace(/"/g, '""')}"`;
          }
          return cellStr;
        }).join(','))
      ].join('\n');
      
      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      // Generate filename with tournament name and date
      const tournamentName = allMatchesData[0]?.tournamentName || 'CricketBook';
      const date = new Date().toISOString().split('T')[0];
      const filename = `${tournamentName.replace(/[^a-z0-9]/gi, '_')}_matches_${date}.csv`;
      
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      console.log('✅ Exported ' + allMatchesData.length + ' matches to CSV');
    }
    
    // Share tournament link function
    function shareTournamentLink() {
      // Get current org ID from URL or localStorage
      const urlParams = new URLSearchParams(window.location.search);
      const orgId = urlParams.get('org') || localStorage.getItem('cricketbook_org_id');
      
      if (!orgId) {
        alert('⚠️ No tournament to share. Please start a tournament match first.');
        return;
      }
      
      // Get tournament name from page header
      const pageHeader = document.getElementById('pageHeader').textContent;
      const tournamentName = pageHeader.replace('🏆 ', '').replace('🏏 ', '').trim();
      
      // Construct share link
      const baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);
      const shareLink = `${baseUrl}matches.html?org=${orgId}`;
      
      // Prepare share content
      const shareTitle = `${tournamentName} - Tournament Dashboard`;
      const shareMessage = `🏆 *${tournamentName}* - Live Tournament\n\n📋 View all matches, schedules & live scores\n\n👉 Tournament Dashboard:\n${shareLink}\n\n⚡ Powered by CricketBook`;
      
      // Try native share API first (mobile)
      if (navigator.share) {
        navigator.share({
          title: shareTitle,
          text: shareMessage,
          url: shareLink
        }).then(() => {
          console.log('✅ Tournament link shared successfully');
        }).catch(err => {
          if (err.name !== 'AbortError') {
            console.log('Share cancelled or failed, falling back to copy');
            copyToClipboard(shareLink, shareMessage);
          }
        });
      } else {
        // Fallback to copy to clipboard
        copyToClipboard(shareLink, shareMessage);
      }
    }
    
    // Copy to clipboard helper
    function copyToClipboard(link, message) {
      // Try to copy the full message
      const textToCopy = message;
      
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textToCopy)
          .then(() => {
            alert('✅ Tournament link copied to clipboard!\n\nShare it with your team members and viewers.');
          })
          .catch(() => {
            // Fallback for older browsers
            fallbackCopy(textToCopy);
          });
      } else {
        fallbackCopy(textToCopy);
      }
    }
    
    // Fallback copy method
    function fallbackCopy(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-9999px';
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        alert('✅ Tournament link copied to clipboard!\n\nShare it with your team members and viewers.');
      } catch (err) {
        alert('⚠️ Could not copy automatically. Please copy this link manually:\n\n' + text);
      }
      document.body.removeChild(textArea);
    }
    
    // Clean up connections when leaving page
    window.addEventListener('beforeunload', () => {
      console.log('🧹 Cleaning up connections before page unload');
      if (pollingInterval) {
        clearInterval(pollingInterval);
      }
    });
  </script>

  <!-- Footer -->
  <footer style="text-align:center;padding:24px 0;color:#ffffff;font-size:14px;margin-top:24px;">
    <p style="margin:0 0 8px;">Made with ❤️ for local cricket matches.</p>
    <p style="margin:0 0 8px;opacity:0.9;">© 2026 CricketBook — Realtime Cricket Scoring Tool</p>
    <p style="margin:0;"><a href="https://www.instagram.com/cricketbook.digital/" target="_blank" rel="noopener noreferrer" style="color:white;text-decoration:none;font-weight:600;opacity:0.95;transition:opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.95'">📷 Follow us on Instagram</a></p>
  </footer>
  <script>
    // Register Service Worker for PWA (only works on HTTP/HTTPS)
    if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(reg => console.log('✅ Service Worker registered:', reg.scope))
          .catch(err => console.log('❌ Service Worker registration failed:', err));
      });
    }
  </script>

</body>
</html>
