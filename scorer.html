<!DOCTYPE html>
<html lang="en">
<head>
<!-- Resource hints for faster loading -->
<link rel="preconnect" href="https://www.googletagmanager.com">
<link rel="preconnect" href="https://www.gstatic.com">
<link rel="dns-prefetch" href="https://www.googletagmanager.com">
<link rel="dns-prefetch" href="https://www.gstatic.com">

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7X5LQ6WESD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-7X5LQ6WESD');
</script>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<!-- Primary Meta Tags -->
<meta name="description" content="Professional cricket scorer tool - record runs, wickets, extras, and overs in real-time. Easy-to-use interface with undo, ball-by-ball tracking, and instant sharing capabilities." />
<meta name="keywords" content="cricket scorer, cricket scoring tool, record cricket match, cricket ball by ball scorer, cricket wicket tracker, cricket runs tracker, cricket overs scorer, cricket match recorder, digital cricket scoring, professional cricket scorer, cricket scorekeeper app" />
<meta name="author" content="CricketBook" />
<meta name="robots" content="index, follow" />
<meta name="language" content="English" />
<meta name="revisit-after" content="1 days" />
<meta name="theme-color" content="#667eea" />
<link rel="canonical" href="https://cricketbook.digital/scorer.html" />

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website" />
<meta property="og:url" content="https://cricketbook.digital/scorer.html" />
<meta property="og:title" content="Cricket Scorer - Record Matches Ball-by-Ball | CricketBook" />
<meta property="og:description" content="Professional cricket scoring tool. Record runs, wickets, extras with easy-to-use interface and instant sharing." />
<meta property="og:image" content="https://cricketbook.digital/og-image-scorer.png" />
<meta property="og:site_name" content="CricketBook" />

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:url" content="https://cricketbook.digital/scorer.html" />
<meta name="twitter:title" content="Cricket Scorer - Record Matches Ball-by-Ball" />
<meta name="twitter:description" content="Professional cricket scoring tool with ball-by-ball tracking and instant sharing." />
<meta name="twitter:image" content="https://cricketbook.digital/twitter-image-scorer.png" />

<!-- Additional SEO -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="CricketBook Scorer" />

<link rel="manifest" href="manifest.json" />
<title id="pageTitle">Cricket Scorer - Record Matches Ball-by-Ball | CricketBook</title>

<!-- Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "CricketBook Scorer",
  "applicationCategory": "SportsApplication",
  "operatingSystem": "Web",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD"
  }
}
</script>
<style>
  :root {
    /* Light mode (default) */
    --bg-gradient-start: #667eea;
    --bg-gradient-end: #764ba2;
    --card-bg: #ffffff;
    --card-border: rgba(148,163,184,.2);
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --text-tertiary: #94a3b8;
    --nav-text: #ffffff;
    --badge-bg: rgba(255, 255, 255, 0.15);
    --badge-border: rgba(255, 255, 255, 0.1);
    --badge-hover: rgba(255, 255, 255, 0.25);
    --bg:#0b1220;
    --card2:#121a2b;
    --accent:#3b82f6;
    --accent2:#27ce02;
    --accent3:#10b981;
    --danger:#e31d1d;
    --muted:#94a3b8;
    --text:#e5e7eb;
    --chip:#1f2937;
    --chip2:#0ea5e9;
  }
  
  [data-theme="dark"] {
    /* Dark mode */
    --bg-gradient-start: #1e293b;
    --bg-gradient-end: #0f172a;
    --card-bg: #1e293b;
    --card-border: rgba(71,85,105,.3);
    --text-primary: #f1f5f9;
    --text-secondary: #cbd5e1;
    --text-tertiary: #64748b;
    --nav-text: #f1f5f9;
    --badge-bg: rgba(255, 255, 255, 0.1);
    --badge-border: rgba(255, 255, 255, 0.05);
    --badge-hover: rgba(255, 255, 255, 0.2);
  }
  
  :root{
    --bg:#0b1220;
    --card2:#121a2b;
    --accent:#3b82f6;
    --accent2:#27ce02;
    --accent3:#10b981;
    --danger:#e31d1d;
    --muted:#94a3b8;
    --text:#e5e7eb;
    --chip:#1f2937;
    --chip2:#0ea5e9;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
    color:var(--text-primary); padding:12px;
    min-height:100vh;
    transition: background 0.3s ease, color 0.3s ease;
  }
  #game.card {
    color:var(--text-primary);
  }
  h1{margin:4px 0 10px; font-size:20px; text-align:center}
  .container{max-width:760px; margin:0 auto}
  .card{
    background:var(--card-bg);
    border:1px solid var(--card-border);
    border-radius:20px; 
    padding:18px; 
    box-shadow:0 10px 40px rgba(0,0,0,.12), 0 2px 8px rgba(0,0,0,.08);
    position:relative;
    transition: background 0.3s ease, border-color 0.3s ease;
  }
  #game.card {
    max-width:480px;
    margin:0 auto;
  }
  .row{display:flex; gap:0px; flex-wrap:wrap}
  input{
    background:#0b1220; color:var(--text); border:1px solid rgba(148,163,184,.25);
    padding:8px 10px; border-radius:10px; width:100%;
  }
  .btn{
    border:0; border-radius:0px; color:white; font-weight:700; padding:8px 0; min-width:48px; width:100%;
    box-shadow:none;
    font-size:15px;
  }
  /* Responsive table buttons for mobile */
  @media (max-width: 600px) {
    .btn { font-size:15px; padding:10px 0; min-width:40px; }
    table { font-size:15px; }
    td { padding:0 !important; }
  }
  .btn:disabled{opacity:.5}
  .btn-run{background:var(--accent)}
  .btn-extra{background:var(--accent2)}
  .btn-action{background:var(--accent3)}
  .btn-wkt{background:var(--danger)}
  .btn-muted{background:#334155}
  .btn-undo{background:#f43f5e !important; color:white !important;}
  .btn-extra-nb{background:#035fd7 !important; color:#fff !important;} /* Orange for No Ball */
  .btn-extra-wd{background:#68ce02 !important; color:#222 !important;} /* Yellow for Wide */
  .btn-extra-lb{background:#6366f1 !important; color:#fff !important;} /* Indigo for Leg Bye */
  .btn-extra-b{background:#8b5cf6 !important; color:#fff !important;} /* Purple for Bye */
  .scoreboard{
    display:grid; gap:6px; margin-bottom:8px;
  }
  .score-big{font-size:40px; font-weight:900; color:#1f2937;}
  .chip{
    display:inline-block; padding:6px 12px; border-radius:999px; font-size:12px;
    background:#f1f5f9; color:#475569; border:1px solid #e2e8f0; font-weight:600;
  }
  .panel{
    margin-top:8px; padding:10px; border-radius:16px;
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border:2px solid #3b82f6;
    box-shadow:0 6px 20px rgba(59,130,246,0.2), 0 2px 8px rgba(59,130,246,0.1);
    transition: all 0.3s ease;
  }
  #extraPanel .btn-action{
    border-radius: 10px !important;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
    font-weight: 800 !important;
    font-size: 18px !important;
    box-shadow: 0 3px 10px rgba(16, 185, 129, 0.3), 0 1px 3px rgba(0, 0, 0, 0.1) !important;
    transition: all 0.2s ease !important;
    letter-spacing: 0.5px !important;
  }
  #extraPanel .btn-action:active{
    transform: scale(0.95) !important;
    box-shadow: 0 1px 4px rgba(16, 185, 129, 0.4) !important;
  }
  #wicketPanel {
    background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
    border:2px solid #f43f5e;
    box-shadow:0 8px 32px rgba(244,63,94,0.2);
    animation: wicketPanelPop 0.4s cubic-bezier(.68,-0.55,.27,1.55);
    padding: 14px;
  }
  @keyframes wicketPanelPop {
    0% { transform: scale(0.95) translateY(20px); opacity:0; }
    80% { transform: scale(1.03) translateY(-4px); opacity:1; }
    100% { transform: scale(1) translateY(0); opacity:1; }
  }
  #wicketPanel .muted {
    color: #e31d1d;
    font-weight: 700;
    letter-spacing: 0.5px;
    font-size: 14px;
    text-align: center;
  }
  #wicketPanel label {
    font-size: 12px;
    color: #475569;
    font-weight: 600;
    margin-bottom: 4px;
    display: block;
  }
  #wicketPanel select, #wicketPanel input[type="number"] {
    border-radius: 8px;
    border: 2px solid #e2e8f0;
    background: #ffffff;
    color: #1f2937;
    width: 100%;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    transition: border 0.2s, box-shadow 0.2s;
  }
  #wicketPanel select:focus, #wicketPanel input[type="number"]:focus {
    border: 2px solid #f43f5e;
    outline: none;
    box-shadow: 0 0 0 3px rgba(244,63,94,0.1);
  }
  #wicketPanel input[type="checkbox"] {
    accent-color: #f43f5e;
    transform: scale(1.2);
    margin-right: 6px;
    vertical-align: middle;
  }
  #wicketPanel .checkbox-label {
    display: flex;
    align-items: center;
    font-weight: 500;
    color: #1f2937;
  }
  #wicketPanel .row button {
    border-radius: 10px;
    font-weight: 700;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  #wicketPanel .row button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 14px rgba(0,0,0,0.15);
  }
  #wicketPanel .btn-action {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: #fff;
    border: none;
  }
  #wicketPanel .btn-muted {
    background: #64748b;
    color: #fff;
    border: none;
  }
  #extraPanel .muted {
    color: #64748b;
    font-size: 12px;
  }
  .overs{
    margin-top:10px; background:#f8fafc;
    border:1px solid #e2e8f0; padding:10px; border-radius:14px;
  }
  .over-line{padding:5px 0; border-bottom:1px dashed #cbd5e1; color:#1f2937;}
  .over-line:last-child{border-bottom:0}
  .muted{color:var(--muted)}
  .flex-between{display:flex; justify-content:space-between; align-items:center}

  /* Extra panel with better button layout */
  #extraPanel .row {
    display: flex;
    gap: 8px;
    justify-content: stretch;
  }
  #extraPanel .btn {
    font-size: 16px;
    padding: 12px 0;
  }

  /* Navigation */
  .nav-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 0 5px;
    position: relative;
    z-index: 1001;
  }

  .nav-title {
    font-size: 20px;
    font-weight: 800;
    color: white;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: block;
  }

  .nav-title:hover {
    transform: scale(1.05);
    text-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  .nav-toggle {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 24px;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    z-index: 1002;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .nav-toggle:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  .nav-toggle .hamburger {
    display: block;
  }

  .nav-toggle .close {
    display: none;
    font-size: 28px;
  }

  .nav-toggle.active .hamburger {
    display: none;
  }

  .nav-toggle.active .close {
    display: block;
  }

  /* Navigation Overlay Backdrop */
  .nav-backdrop {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    z-index: 999;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .nav-backdrop.active {
    display: block;
    opacity: 1;
  }

  /* Navigation Links Overlay */
  .nav-links {
    position: fixed;
    top: 0;
    right: -300px;
    width: 280px;
    height: 100vh;
    background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
    border-left: 1px solid rgba(255, 255, 255, 0.1);
    padding: 80px 20px 20px;
    box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    overflow-y: auto;
    transition: right 0.3s ease;
  }
  
  .nav-links.active {
    right: 0;
  }
  
  .nav-links a {
    display: block;
    color: white;
    text-decoration: none;
    padding: 14px 18px;
    margin: 8px 0;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    font-weight: 600;
    font-size: 15px;
    transition: all 0.2s;
    white-space: nowrap;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .nav-links a:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: translateX(-4px);
    border-color: rgba(255, 255, 255, 0.3);
  }
  
  .nav-links a.active {
    background: rgba(255, 255, 255, 0.35);
    border-color: rgba(255, 255, 255, 0.4);
  }

  /* Responsive adjustments */
  @media (max-width: 480px) {
    .nav-links {
      width: 100%;
      right: -100%;
    }
  }
  
  /* Saved Matches Section */
  #savedMatchesSection code {
    background: #f1f5f9;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
    font-family: 'Courier New', monospace;
    color: #334155;
  }
  
  #savedMatchesList {
    min-height: 50px;
  }
</style>

<!-- Firebase SDK -->
<script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script>
  // Firebase Configuration
  // SETUP INSTRUCTIONS:
  // 1. Go to https://console.firebase.google.com/
  // 2. Click "Add project" or "Create a project"
  // 3. Enter project name (e.g., "cricket-scorer"), accept terms, click Continue
  // 4. Disable Google Analytics (optional), click Create project
  // 5. After project is ready, click "Continue"
  // 6. In project overview, click the Web icon (</>)
  // 7. Register app nickname (e.g., "cricket-scorer-web"), don't check Firebase Hosting
  // 8. Click "Register app"
  // 9. Copy the firebaseConfig object and paste it below
  // 10. Click "Continue to console"
  // 11. In left menu, click "Build" > "Realtime Database"
  // 12. Click "Create Database"
  // 13. Choose location (closest to you), click Next
  // 14. Select "Start in test mode", click Enable
  // 15. After database is created, click "Rules" tab
  // 16. Replace rules with the following and click "Publish":
  //     {
  //       "rules": {
  //         "organizations": {
  //           ".read": true,
  //           ".write": true
  //         }
  //       }
  //     }
  //     NOTE: Write access is open because edit protection is handled
  //     by the application using edit tokens, not Firebase rules.
  //     Users without valid edit tokens see read-only UI in the app.
  // 17. Your databaseURL will be shown in the Data tab (e.g., https://YOUR-PROJECT.firebaseio.com)
  // 18. Replace the config below with your actual values
  
  const firebaseConfig = {
    apiKey: "AIzaSyAFfwgHq761oFMg4CVqmZezGR_WK6ZGvAY",
    authDomain: "cricketbook-35725.firebaseapp.com",
    databaseURL: "https://cricketbook-35725-default-rtdb.firebaseio.com",
    projectId: "cricketbook-35725",
    storageBucket: "cricketbook-35725.firebasestorage.app",
    messagingSenderId: "128747950424",
    appId: "1:128747950424:web:dce02e8420c353f1acd52d"
  };
  
  // Initialize Firebase
  let db = null;
  let matchId = null;
  let isViewerMode = false;
  let firebaseEnabled = false;
  let editToken = null;  // Secret token for editing
  let canEditMatch = false;  // Whether current user can edit
  let isLoadingFromFirebase = false;  // Flag to prevent save loop when loading
  
  // ========== Password Hashing Utility ==========
  // Simple SHA-256 hashing for password security
  async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex;
  }
  
  // Verify password against stored hash
  async function verifyPassword(password, storedHash) {
    const hash = await hashPassword(password);
    return hash === storedHash;
  }
  
  try {
    // Check if config is filled in
    if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      firebaseEnabled = true;
      console.log("✅ Firebase initialized successfully");
    } else {
      console.warn("⚠️ Firebase not configured. Add your config to enable live sync.");
    }
  } catch (error) {
    console.error("❌ Firebase initialization error:", error);
  }
  
  // Check if tournament name already exists in Firebase
  async function checkTournamentExists() {
    const tournamentNameInput = document.getElementById('tournamentName');
    const tournamentStatus = document.getElementById('tournamentStatus');
    const passwordHelpText = document.getElementById('passwordHelpText');
    const tournamentName = tournamentNameInput?.value.trim();
    
    if (!tournamentName || tournamentName === '') {
      tournamentStatus.style.display = 'none';
      passwordHelpText.textContent = 'Required for tournaments. Protects your tournament and allows team collaboration.';
      passwordHelpText.style.color = '#64748b';
      return;
    }
    
    if (!firebaseEnabled || !db) {
      return;
    }
    
    try {
      const orgId = generateOrganizationId(tournamentName);
      const snapshot = await db.ref('tournaments/' + orgId).once('value');
      const orgData = snapshot.val();
      
      if (orgData && orgData.passwordHash) {
        // Tournament exists
        tournamentStatus.style.display = 'block';
        tournamentStatus.innerHTML = '<div style="padding:8px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;color:#991b1b;font-size:11px;font-weight:600;">⚠️ Tournament exists! Enter correct password to add matches.</div>';
        passwordHelpText.textContent = 'This tournament already exists. Enter the correct password to join and add matches.';
        passwordHelpText.style.color = '#991b1b';
      } else {
        // Tournament doesn't exist - new
        tournamentStatus.style.display = 'block';
        tournamentStatus.innerHTML = '<div style="padding:8px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;color:#166534;font-size:11px;font-weight:600;">✅ Available! Set a password to create this tournament.</div>';
        passwordHelpText.textContent = 'Create a new tournament with this name. Set a password to protect it.';
        passwordHelpText.style.color = '#166534';
      }
    } catch (error) {
      console.error('❌ Error checking tournament:', error);
      tournamentStatus.style.display = 'none';
    }
  }
  
  // Load existing tournaments from localStorage (user's own tournaments only)
  function loadExistingTournaments() {
    console.log("🔄 Loading existing tournaments from localStorage...");
    
    try {
      const datalist = document.getElementById('tournamentsList');
      if (!datalist) {
        console.error("❌ Datalist element not found!");
        return;
      }
      
      datalist.innerHTML = ''; // Clear existing options
      
      // Get tournament history from localStorage
      const tournamentHistory = localStorage.getItem('cricketbook_tournament_history');
      
      if (tournamentHistory) {
        const tournaments = JSON.parse(tournamentHistory);
        console.log("📦 Tournament history:", tournaments);
        
        // Sort and add to datalist (most recent first, then alphabetical)
        tournaments
          .sort((a, b) => {
            // Sort by lastUsed timestamp descending, then by name
            if (b.lastUsed !== a.lastUsed) {
              return b.lastUsed - a.lastUsed;
            }
            return a.name.localeCompare(b.name);
          })
          .forEach(tournament => {
            const option = document.createElement('option');
            option.value = tournament.name;
            datalist.appendChild(option);
          });
        
        console.log(`✅ Loaded ${tournaments.length} tournaments from history`);
      } else {
        console.log("ℹ️ No tournament history found in localStorage");
      }
    } catch (error) {
      console.error("❌ Error loading tournaments:", error);
    }
  }
  
  // Track ALL user matches in localStorage (for quick match access)
  function addMatchToUserHistory(matchInfo) {
    try {
      let allMatches = [];
      const allMatchesJson = localStorage.getItem('cricketbook_all_user_matches');
      if (allMatchesJson) {
        allMatches = JSON.parse(allMatchesJson);
      }
      
      // Remove existing entry if match already exists
      allMatches = allMatches.filter(m => m.matchId !== matchInfo.matchId);
      
      // Add new/updated match info
      allMatches.unshift(matchInfo);
      
      // Keep only last 50 matches
      if (allMatches.length > 50) {
        allMatches = allMatches.slice(0, 50);
      }
      
      localStorage.setItem('cricketbook_all_user_matches', JSON.stringify(allMatches));
      console.log('💾 Added match to user history:', matchInfo.matchId);
    } catch (error) {
      console.error('❌ Error adding match to user history:', error);
    }
  }
  
  // Get all user matches from localStorage
  function getAllUserMatches() {
    try {
      const allMatchesJson = localStorage.getItem('cricketbook_all_user_matches');
      if (allMatchesJson) {
        return JSON.parse(allMatchesJson);
      }
      return [];
    } catch (error) {
      console.error('❌ Error loading user matches:', error);
      return [];
    }
  }
  
  // Save current match session to localStorage for recovery
  function saveCurrentMatchSession() {
    try {
      // Ensure we have all critical data before saving
      if (!organizationId || !matchId || !editToken) {
        console.warn('⚠️ Cannot save match session - missing critical data:', {
          organizationId: organizationId,
          matchId: matchId,
          editToken: editToken
        });
        return;
      }
      
      if (!teamA || !teamB) {
        console.warn('⚠️ Cannot save match session - missing team names:', {
          teamA: teamA,
          teamB: teamB
        });
        return;
      }
      
      const session = {
        organizationId: organizationId,
        matchId: matchId,
        editToken: editToken,
        teamA: teamA,
        teamB: teamB,
        tournamentName: document.getElementById('tournamentName')?.value || '',
        timestamp: Date.now(),
        matchCompleted: matchCompleted,
        resultText: resultText
      };
      
      // Get existing match history
      let matchHistory = [];
      const historyJson = localStorage.getItem('cricketbook_match_history');
      if (historyJson) {
        matchHistory = JSON.parse(historyJson);
      }
      
      // Remove any existing entry for this match
      matchHistory = matchHistory.filter(m => m.matchId !== matchId);
      
      // Only add to history if match is NOT completed
      if (!matchCompleted) {
        // Add current session to the beginning
        matchHistory.unshift(session);
        
        // Keep only last 10 matches
        if (matchHistory.length > 10) {
          matchHistory = matchHistory.slice(0, 10);
        }
      }
      
      // Save to localStorage
      localStorage.setItem('cricketbook_match_history', JSON.stringify(matchHistory));
      
      // Also keep the old single session for backward compatibility (only if not completed)
      if (!matchCompleted) {
        localStorage.setItem('cricketbook_current_session', JSON.stringify(session));
      } else {
        localStorage.removeItem('cricketbook_current_session');
      }
      console.log('💾 Saved match session to localStorage:', matchId);
    } catch (error) {
      console.error('❌ Failed to save session:', error);
    }
  }
  
  // Load current match session from localStorage
  function loadCurrentMatchSession() {
    try {
      const sessionJson = localStorage.getItem('cricketbook_current_session');
      if (!sessionJson) return null;
      
      const session = JSON.parse(sessionJson);
      
      // Check if session is less than 24 hours old
      const hoursSinceSession = (Date.now() - session.timestamp) / (1000 * 60 * 60);
      if (hoursSinceSession > 24) {
        console.log('⏰ Session expired (older than 24 hours)');
        localStorage.removeItem('cricketbook_current_session');
        return null;
      }
      
      console.log('✅ Found saved session from', Math.round(hoursSinceSession * 60), 'minutes ago');
      return session;
    } catch (error) {
      console.error('❌ Failed to load session:', error);
      return null;
    }
  }
  
  // Load all match sessions from localStorage history
  function loadAllMatchSessions() {
    try {
      const historyJson = localStorage.getItem('cricketbook_match_history');
      if (!historyJson) return [];
      
      const matchHistory = JSON.parse(historyJson);
      
      // Filter out expired sessions (older than 7 days) and completed matches
      const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
      const validMatches = matchHistory.filter(session => {
        const notExpired = session.timestamp > sevenDaysAgo;
        const notCompleted = !session.matchCompleted;
        return notExpired && notCompleted;
      });
      
      // Update localStorage if we filtered any
      if (validMatches.length !== matchHistory.length) {
        localStorage.setItem('cricketbook_match_history', JSON.stringify(validMatches));
      }
      
      return validMatches;
    } catch (error) {
      console.error('❌ Failed to load match history:', error);
      return [];
    }
  }
  
  // Clear current match session
  function clearCurrentMatchSession() {
    localStorage.removeItem('cricketbook_current_session');
    console.log('🗑️ Cleared current match session');
  }
  
  // Save tournament to localStorage history
  function saveTournamentToHistory(tournamentName) {
    if (!tournamentName || tournamentName.trim() === '') return;
    
    try {
      let tournaments = [];
      const historyJson = localStorage.getItem('cricketbook_tournament_history');
      
      if (historyJson) {
        tournaments = JSON.parse(historyJson);
      }
      
      // Check if tournament already exists
      const existingIndex = tournaments.findIndex(t => t.name === tournamentName);
      
      if (existingIndex >= 0) {
        // Update lastUsed timestamp
        tournaments[existingIndex].lastUsed = Date.now();
      } else {
        // Add new tournament
        tournaments.push({
          name: tournamentName,
          lastUsed: Date.now()
        });
      }
      
      // Keep only last 20 tournaments
      if (tournaments.length > 20) {
        tournaments = tournaments
          .sort((a, b) => b.lastUsed - a.lastUsed)
          .slice(0, 20);
      }
      
      localStorage.setItem('cricketbook_tournament_history', JSON.stringify(tournaments));
      console.log(`💾 Saved tournament to history: ${tournamentName}`);
      
      // Reload the datalist to show the newly saved tournament
      loadExistingTournaments();
    } catch (error) {
      console.error("❌ Error saving tournament to history:", error);
    }
  }
  
  // Check for viewer mode
  const urlParams = new URLSearchParams(window.location.search);
  isViewerMode = urlParams.get('view') === 'true';
  matchId = urlParams.get('match') || urlParams.get('matchId'); // Support both 'match' and 'matchId' parameters
  
  // Check for edit token in URL
  const urlEditToken = urlParams.get('edit');
  
  // Generate a secure random edit token
  function generateEditToken() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let token = 'edit_';
    for (let i = 0; i < 16; i++) {
      token += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return token;
  }
  
  // Check if current user can edit this match
  async function checkEditPermission() {
    console.log("🔍 checkEditPermission called");
    console.log("  - organizationId:", organizationId);
    console.log("  - matchId:", matchId);
    console.log("  - urlEditToken:", urlEditToken);
    
    if (!db || !organizationId || !matchId) {
      console.log("⚠️ Cannot check edit permission - missing data");
      canEditMatch = true; // Allow editing for new matches
      return;
    }
    
    try {
      // Check both tournament and quick match paths
      let snapshot = await db.ref('tournaments/' + organizationId + '/matches/' + matchId).once('value');
      let matchData = snapshot.val();
      
      if (!matchData) {
        // Try quick matches path
        snapshot = await db.ref('quickMatches/' + organizationId + '/matches/' + matchId).once('value');
        matchData = snapshot.val();
      }
      
      console.log("📦 Match data retrieved:", matchData ? "exists" : "null");
      
      if (!matchData) {
        console.log("✅ New match - edit allowed");
        canEditMatch = true;
        return;
      }
      
      console.log("  - Match editToken:", matchData.editToken);
      
      // Check if match has an edit token
      if (matchData.editToken) {
        // Match is protected - check if URL has correct token
        if (urlEditToken === matchData.editToken) {
          console.log("✅ Edit token valid - edit allowed");
          canEditMatch = true;
          editToken = urlEditToken; // Store for later use
        } else {
          console.log("🔒 No valid edit token - read-only mode");
          console.log("  - URL token:", urlEditToken);
          console.log("  - Match token:", matchData.editToken);
          
          // Check if this match is in localStorage with outdated token
          const allMatches = loadAllMatchSessions();
          const savedMatch = allMatches.find(m => m.matchId === matchId);
          if (savedMatch && savedMatch.editToken !== matchData.editToken) {
            console.log("🔄 Updating localStorage with correct editToken");
            // Update the token in localStorage
            savedMatch.editToken = matchData.editToken;
            updateMatchInHistory(savedMatch);
            
            // Redirect with correct token
            const correctUrl = `scorer.html?org=${organizationId}&match=${matchId}&edit=${matchData.editToken}`;
            console.log("↪️ Redirecting with correct token:", correctUrl);
            window.location.href = correctUrl;
            return;
          }
          
          canEditMatch = false;
        }
      } else {
        // Old match without token - allow editing (backward compatibility)
        console.log("✅ Legacy match (no token) - edit allowed");
        canEditMatch = true;
        // Generate token for this match for future protection
        editToken = generateEditToken();
      }
      
      console.log("🎯 Final canEditMatch:", canEditMatch);
      
      // Don't update UI here - will be done after match data loads
    } catch (error) {
      console.error("❌ Error checking edit permission:", error);
      canEditMatch = false;
    }
  }
  
  // Helper function to update a match in history
  function updateMatchInHistory(updatedMatch) {
    try {
      let matchHistory = loadAllMatchSessions();
      const index = matchHistory.findIndex(m => m.matchId === updatedMatch.matchId);
      if (index >= 0) {
        matchHistory[index] = updatedMatch;
        localStorage.setItem('cricketbook_match_history', JSON.stringify(matchHistory));
        console.log('✅ Updated match in history');
      }
    } catch (error) {
      console.error('❌ Failed to update match in history:', error);
    }
  }
  
  // Update UI based on edit mode
  function updateEditModeUI() {
    console.log("🔧 updateEditModeUI called - canEditMatch:", canEditMatch);
    
    if (!canEditMatch) {
      // Show read-only banner
      const gameDiv = document.getElementById('game');
      if (gameDiv && !document.getElementById('readOnlyBanner')) {
        const banner = document.createElement('div');
        banner.id = 'readOnlyBanner';
        banner.style.cssText = 'background:#ff6b6b20;border:2px solid #ff6b6b;padding:12px;border-radius:10px;margin-bottom:15px;text-align:center;';
        banner.innerHTML = '🔒 <strong>View Only Mode</strong><br><span style="font-size:13px;">You are watching this match but cannot make changes. To edit, ask the scorer for the editor link.</span>';
        gameDiv.insertBefore(banner, gameDiv.firstChild);
      }
      
      // Disable all control buttons
      disableAllButtons();
    } else {
      // Edit mode - ensure buttons are enabled
      console.log("✅ Edit mode - enabling all buttons");
      enableAllButtons();
    }
  }
  
  // Disable all interactive buttons in read-only mode
  function disableAllButtons() {
    const buttons = document.querySelectorAll('#game button, #game input[type="button"]');
    buttons.forEach(button => {
      button.disabled = true;
      button.style.opacity = '0.5';
      button.style.cursor = 'not-allowed';
    });
  }
  
  // Enable all interactive buttons in edit mode
  function enableAllButtons() {
    const buttons = document.querySelectorAll('#game button, #game input[type="button"]');
    console.log(`🔓 Enabling ${buttons.length} buttons`);
    buttons.forEach(button => {
      button.disabled = false;
      button.style.opacity = '1';
      button.style.cursor = 'pointer';
    });
  }
  
  // Load existing tournaments from localStorage when DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    loadExistingTournaments();
  });
  
  // Organization ID generation function (tournament based, no date)
  function generateOrganizationId(tournamentName) {
    // Sanitize tournament name
    const sanitize = (str) => str.toLowerCase().replace(/[^a-z0-9]/g, '').substring(0, 30);
    let tourName = sanitize(tournamentName);
    
    // If no tournament name provided, generate unique ID with date + time + random
    if (!tourName || tourName === '') {
      const now = new Date();
      const dd = String(now.getDate()).padStart(2, '0');
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const yyyy = String(now.getFullYear());
      const hh = String(now.getHours()).padStart(2, '0');
      const min = String(now.getMinutes()).padStart(2, '0');
      const ss = String(now.getSeconds()).padStart(2, '0');
      const random = Math.random().toString(36).substr(2, 6);
      tourName = `match_${dd}${mm}${yyyy}_${hh}${min}${ss}_${random}`;
    }
    
    return tourName;
  }
  
  // Organization ID for multi-user isolation - will be set when match starts
  let organizationId = localStorage.getItem('cricketbook_org_id');
  
  function generateMatchId(teamA, teamB) {
    // Create readable match ID from team names
    const sanitize = (str) => str.toLowerCase().replace(/[^a-z0-9]/g, '').substring(0, 10);
    const team1 = sanitize(teamA || 'teamA');
    const team2 = sanitize(teamB || 'teamB');
    
    // Format: ddmmyy_hhmm
    const now = new Date();
    const dd = String(now.getDate()).padStart(2, '0');
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const yy = String(now.getFullYear()).slice(-2);
    const hh = String(now.getHours()).padStart(2, '0');
    const min = String(now.getMinutes()).padStart(2, '0');
    const dateTime = `${dd}${mm}${yy}_${hh}${min}`;
    
    const random = Math.random().toString(36).substr(2, 4);
    return `${team1}_vs_${team2}_${dateTime}_${random}`;
  }
</script>

<script>
  // Dark Mode Management (Global)
  function initTheme() {
    const savedTheme = localStorage.getItem('cricketbook_theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
  }
  
  function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('cricketbook_theme', newTheme);
    updateThemeIcon(newTheme);
    console.log('🌓 Theme switched to:', newTheme);
  }
  
  function updateThemeIcon(theme) {
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
      themeToggle.textContent = theme === 'dark' ? '🌞' : '🌜';
      themeToggle.title = theme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
    }
  }
  
  initTheme();
  
  // Toggle navigation
  function toggleNav() {
    const navLinks = document.getElementById('navLinks');
    const navBackdrop = document.getElementById('navBackdrop');
    const navToggle = document.querySelector('.nav-toggle');
    
    navLinks.classList.toggle('active');
    navBackdrop.classList.toggle('active');
    navToggle.classList.toggle('active');
    
    // Prevent body scroll when nav is open
    if (navLinks.classList.contains('active')) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }
  }
</script>

</head>
<body>
<div class="container">

  <!-- Navigation -->
  <div class="nav-backdrop" id="navBackdrop" onclick="toggleNav()"></div>
  <div class="nav-header">
    <a href="index.html" class="nav-title">🏏 CricketBook</a>
    <div style="display: flex; align-items: center;">
      <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle Dark Mode" style="background: var(--badge-bg); border: 1px solid var(--badge-border); color: var(--nav-text); font-size: 20px; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; margin-right: 8px;">
        🌜
      </button>
      <button class="nav-toggle" onclick="toggleNav()">
        <span class="hamburger">☰</span>
        <span class="close">×</span>
      </button>
    </div>
  </div>
  <nav class="nav-links" id="navLinks">
    <a href="index.html">🏠 Home</a>
    <a href="livescore.html">📺 Live Score</a>
    <a href="matches.html">📋 My Matches</a>
    <a href="allmatches.html">🌍 All Matches</a>
    <a href="about.html">ℹ️ About</a>
  </nav>

  <!-- Saved Matches Section -->
  <div id="savedMatchesSection" style="margin-bottom:14px;display:none;">
    <div class="card" style="background:#ffffff;color:#1f2937;max-width:520px;margin:0 auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h2 style="margin:0;font-size:20px;font-weight:700;color:#1f2937;">💾 Saved Matches</h2>
        <button class="btn" onclick="refreshSavedMatches()" style="padding:8px 16px;background:#10b981;font-size:13px;width:auto;min-width:80px;">🔄 Refresh</button>
      </div>
      <div id="savedMatchesList"></div>
    </div>
  </div>

  <!-- Setup -->
  <div id="setup" class="card" style="margin-bottom:14px;background:#ffffff;color:#1f2937;max-width:520px;margin:0 auto 14px;">
  <div style="text-align:center;margin-bottom:16px;">
    <div style="font-size:40px;margin-bottom:6px;"></div>
    <h1 style="color:#1f2937;margin:0 0 6px;font-size:24px;font-weight:800;">🏏CricketBook</h1>
    <p class="muted" style="margin:0;color:#64748b;font-size:13px;">Simple • Fast • Realtime Scoring</p>
  </div>

  <!-- Team Names Section (Priority) -->
  <div style="background:#ffffff;padding:14px;border-radius:14px;margin-bottom:14px;border:2px solid #e2e8f0;">
    <label style="display:block;color:#1f2937;font-weight:700;font-size:14px;margin-bottom:3px;">⚔️ Team Names <span style="color:#ef4444;">*</span></label>
    <p style="color:#64748b;font-size:11px;margin:0 0 8px 0;line-height:1.4;">Enter team names (first team bats first)</p>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
      <input id="teamA" placeholder="🏏 Team A (Batting First)" style="background:#ffffff;color:#1f2937;border:2px solid #e2e8f0;padding:10px 12px;border-radius:12px;width:100%;font-size:14px;transition:border 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'" />
      <button id="switchTeamsBtn" onclick="switchTeamNames()" title="Switch teams" style="background:#8b5cf6;color:white;border:none;border-radius:10px;padding:8px;font-size:16px;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 8px rgba(139,92,246,0.25);min-width:38px;height:42px;flex-shrink:0;" onmouseover="this.style.background='#7c3aed';this.style.transform='scale(1.05)';this.style.boxShadow='0 4px 12px rgba(139,92,246,0.35)'" onmouseout="this.style.background='#8b5cf6';this.style.transform='scale(1)';this.style.boxShadow='0 2px 8px rgba(139,92,246,0.25)'">⇅</button>
    </div>
    <input id="teamB" placeholder="🎯 Team B (Bowling First)" style="background:#ffffff;color:#1f2937;border:2px solid #e2e8f0;padding:10px 12px;border-radius:12px;width:100%;font-size:14px;transition:border 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'" />
  </div>

  <!-- Match Settings Section -->
  <div style="background:#ffffff;padding:14px;border-radius:14px;margin-bottom:14px;border:2px solid #e2e8f0;">
    <label style="display:block;color:#1f2937;font-weight:700;font-size:14px;margin-bottom:3px;">⚙️ Match Settings</label>
    <div class="row" style="gap:10px;margin-bottom:10px;">
      <div style="flex:1;">
        <label style="display:block;color:#64748b;font-size:11px;margin-bottom:4px;">Total Overs</label>
        <input id="overs" type="number" min="1" placeholder="Default: 4" style="background:#ffffff;color:#1f2937;border:2px solid #e2e8f0;padding:10px 12px;border-radius:12px;width:100%;font-size:14px;transition:border 0.2s;" onfocus="this.style.borderColor='#10b981'" onblur="this.style.borderColor='#e2e8f0'" />
      </div>
      <div style="flex:1;">
        <label style="display:block;color:#64748b;font-size:11px;margin-bottom:4px;">Max Wickets</label>
        <input id="wicketsLimit" type="number" min="1" max="20" placeholder="Default: 10" style="background:#ffffff;color:#1f2937;border:2px solid #e2e8f0;padding:10px 12px;border-radius:12px;width:100%;font-size:14px;transition:border 0.2s;" onfocus="this.style.borderColor='#10b981'" onblur="this.style.borderColor='#e2e8f0'" />
      </div>
    </div>
    <div>
      <label style="display:block;color:#64748b;font-size:11px;margin-bottom:4px;">Match Type</label>
      <select id="matchType" style="background:#ffffff;color:#1f2937;border:2px solid #e2e8f0;padding:10px 12px;border-radius:12px;width:100%;font-size:14px;transition:border 0.2s;cursor:pointer;" onfocus="this.style.borderColor='#8b5cf6'" onblur="this.style.borderColor='#e2e8f0'" onchange="handleMatchTypeChange()">
        <option value="Friendly Match">Friendly Match – Practice or non-ranking</option>
        <option value="League Match">League Match – Round-robin stage</option>
        <option value="Qualifier 1">Qualifier 1 – Winner to Final</option>
        <option value="Eliminator">Eliminator – Loser eliminated</option>
        <option value="Semi-Final">Semi-Final – Top 4 knockout</option>
        <option value="Final">Final – Championship</option>
        <option value="3rd Place Playoff">3rd Place Playoff</option>
        <option value="Super Over">Super Over – Tie-breaker</option>
        <option value="Custom">Custom – Enter your own</option>
      </select>
      <input id="customMatchType" type="text" placeholder="Enter custom match type" style="display:none;margin-top:8px;background:#ffffff;color:#1f2937;border:2px solid #e2e8f0;padding:10px 12px;border-radius:12px;width:100%;font-size:14px;transition:border 0.2s;" onfocus="this.style.borderColor='#8b5cf6'" onblur="this.style.borderColor='#e2e8f0'" />
    </div>
  </div>

  <!-- Tournament Section (Collapsible) -->
  <div style="margin-bottom:14px;">
    <button id="tournamentToggleBtn" onclick="toggleTournamentSection()" style="width:100%;background:#f8fafc;color:#475569;border:2px solid #e2e8f0;border-radius:12px;padding:12px;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:all 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#f8fafc'">
      <span>📁 Optional: Organize as Tournament</span>
      <span id="tournamentToggleIcon" style="font-size:16px;">▼</span>
    </button>
    
    <div id="tournamentSection" style="display:none;margin-top:10px;padding:14px;background:linear-gradient(135deg, #667eea08 0%, #764ba208 100%);border:2px solid #e2e8f0;border-radius:12px;">
      <div style="margin-bottom:12px;">
        <label style="display:block;color:#1f2937;font-weight:600;font-size:13px;margin-bottom:3px;">🏆 Tournament Name</label>
        <p style="color:#64748b;font-size:10px;margin:0 0 6px 0;line-height:1.4;">Name your tournament to organize multiple matches (e.g., Summer League 2025)</p>
        <input id="tournamentName" list="tournamentsList" placeholder="e.g., Indian Premier League" style="background:#ffffff;color:#1f2937;border:2px solid #e2e8f0;padding:10px 12px;border-radius:12px;width:100%;font-size:14px;transition:border 0.2s;" onfocus="this.style.borderColor='#f59e0b'" onblur="this.style.borderColor='#e2e8f0'" oninput="checkTournamentExists()" />
        <datalist id="tournamentsList"></datalist>
        <div id="tournamentStatus" style="margin-top:6px;display:none;"></div>
      </div>
      
      <div id="passwordSection" style="padding:12px;background:#ffffff;border:2px solid #e2e8f0;border-radius:10px;">
        <label style="display:block;color:#1f2937;font-weight:600;font-size:13px;margin-bottom:3px;">🔐 Tournament Password <span style="color:#ef4444;">*</span></label>
        <p id="passwordHelpText" style="color:#64748b;font-size:10px;margin:0 0 6px 0;line-height:1.4;">Required for tournaments. Protects your tournament and allows team collaboration.</p>
        <div style="position:relative;">
          <input id="tournamentPassword" type="password" placeholder="Enter password" style="background:#ffffff;color:#1f2937;border:2px solid #e2e8f0;padding:10px 12px;padding-right:45px;border-radius:12px;width:100%;font-size:14px;transition:border 0.2s;" onfocus="this.style.borderColor='#f59e0b'" onblur="this.style.borderColor='#e2e8f0'" oninput="checkPasswordStrength()" />
          <button type="button" onclick="togglePasswordVisibility()" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:16px;padding:0;line-height:1;">👁️</button>
        </div>
        <div id="passwordStrength" style="margin-top:6px;font-size:10px;display:none;"></div>
      </div>
    </div>
  </div>
  
  <button class="btn btn-action" onclick="startMatch()" style="width:100%;font-size:16px;padding:14px 0;background:linear-gradient(135deg, #10b981 0%, #059669 100%);border:none;border-radius:14px;box-shadow:0 6px 20px rgba(16,185,129,0.35);transition:all 0.2s ease;font-weight:800;color:#fff;letter-spacing:0.5px;" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 8px 24px rgba(16,185,129,0.45)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 6px 20px rgba(16,185,129,0.35)'" ontouchstart="this.style.transform='scale(0.98)'" ontouchend="this.style.transform='scale(1)'">
    🚀 Start Match
  </button>
  </div>

  <!-- Game -->
  <div id="game" class="card" style="display:none">
    <!-- Tournament Header -->
    <div id="tournamentHeaderScorer" style="display:none;text-align:center;margin-bottom:12px;padding:10px 16px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:12px;color:#ffffff;font-size:14px;font-weight:700;letter-spacing:1px;box-shadow:0 2px 8px rgba(102,126,234,0.3);">
      <span id="tournamentTitleScorer"></span>
    </div>
    
    <!-- 📊 Scoreboard Header -->
    <div class="scoreboard">
      <!-- Team Name & Score Display (Two Column Layout) -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:16px;">
        <!-- Team Name (Left) -->
        <div style="flex:1;min-width:0;">
          <div id="status" style="font-size:22px;font-weight:800;background:linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-0.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></div>
          <div id="bowlingTeamDisplay" style="font-size:12px;color:#64748b;font-weight:600;margin-top:4px;letter-spacing:0.3px;"></div>
          <div id="firstInningsScore" style="font-size:13px;color:#3b82f6;font-weight:700;margin-top:6px;display:none;letter-spacing:0.3px;"></div>
        </div>
        <!-- Primary Score Display (Right) -->
        <div style="flex:0 0 auto;">
          <div id="score" class="score-big" style="font-size:48px;font-weight:900;color:var(--text-primary);line-height:1;"></div>
        </div>
      </div>

      <!-- Result Display (moved here) -->
      <div id="result" style="display:none;text-align:center;margin-bottom:12px;padding:12px;border-radius:12px;background:linear-gradient(135deg, #10b981 0%, #3b82f6 100%);color:#ffffff;font-size:16px;font-weight:700;box-shadow:0 4px 12px rgba(16,185,129,0.3);"></div>
      
      <!-- New Match Button (shown when match completed) -->
      <div id="newMatchContainer" style="display:none;text-align:center;margin-bottom:12px;">
        <button onclick="startNewMatch()" style="background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);color:white;border:none;border-radius:10px;padding:8px 20px;font-size:13px;font-weight:600;cursor:pointer;box-shadow:0 2px 8px rgba(59,130,246,0.25);transition:all 0.2s;" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 12px rgba(59,130,246,0.35)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(59,130,246,0.25)'">
          🆕 Start New Match
        </button>
      </div>

      <!-- Overs Info -->
      <div class="flex-between" style="margin-bottom:12px;">
        <div id="oversExtrasInfo" class="chip" style="text-align:center;flex:1;background:linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);border:2px solid #60a5fa;padding:12px 18px;border-radius:12px;font-size:14px;font-weight:800;color:#1e40af;letter-spacing:0.5px;box-shadow:0 4px 12px rgba(96,165,250,0.25);"></div>
        <button style="background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:0;margin:0;margin-left:8px;" onclick="showHelpModal()" title="Help">❓</button>
      </div>

      <!-- Live Over Display (replaces Ball Tracker) -->
      <div id="liveOverDisplay" style="margin-bottom:10px;padding:8px 10px;background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);border:2px solid #e2e8f0;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.04);min-height:38px;display:flex;align-items:center;"></div>

      <!-- First Innings Info Banner -->
      <div id="firstInningsInfo" style="display:none;text-align:center;margin-bottom:12px;padding:12px 16px;border-radius:12px;background:linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);color:#ffffff;font-size:14px;font-weight:700;box-shadow:0 4px 12px rgba(59,130,246,0.3);letter-spacing:0.3px;"></div>
    </div>

    <!-- 🔢 Scoring and Action Buttons (Keypad) -->
    <div style="max-width:400px;margin:0 auto;">
      <!-- Top Row: Run Types/Extras + Wicket -->
      <div class="row" style="margin-bottom:10px;gap:4px;">
        <button class="btn btn-extra btn-extra-lb" onclick="startExtra('LB')" style="flex:1;font-size:14px;padding:10px 0;border-radius:10px;font-weight:700;border:2px solid #4f46e5;transition:all 0.15s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 10px rgba(99,102,241,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'" ontouchstart="this.style.transform='scale(0.95)'" ontouchend="this.style.transform='scale(1)'">LB</button>
        <button class="btn btn-extra btn-extra-b" onclick="startExtra('B')" style="flex:1;font-size:14px;padding:10px 0;border-radius:10px;font-weight:700;border:2px solid #7c3aed;transition:all 0.15s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 10px rgba(139,92,246,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'" ontouchstart="this.style.transform='scale(0.95)'" ontouchend="this.style.transform='scale(1)'">BYE</button>
        <button class="btn btn-extra btn-extra-wd" onclick="startExtra('WD')" style="flex:1;font-size:14px;padding:10px 0;border-radius:10px;font-weight:700;border:2px solid #4d7c0f;transition:all 0.15s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 10px rgba(104,206,2,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'" ontouchstart="this.style.transform='scale(0.95)'" ontouchend="this.style.transform='scale(1)'">WD</button>
        <button class="btn btn-extra btn-extra-nb" onclick="startExtra('NB')" style="flex:1;font-size:14px;padding:10px 0;border-radius:10px;font-weight:700;border:2px solid #0369a1;transition:all 0.15s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 10px rgba(3,95,215,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'" ontouchstart="this.style.transform='scale(0.95)'" ontouchend="this.style.transform='scale(1)'">NB</button>
        <button class="btn btn-wkt" onclick="quickWicket()" style="flex:1.5;font-size:18px;padding:12px 0;font-weight:900;background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);border:none;border-radius:10px;box-shadow:0 4px 12px rgba(239,68,68,0.35);transition:all 0.15s ease;" onmouseover="this.style.transform='scale(1.05)';this.style.boxShadow='0 6px 16px rgba(239,68,68,0.45)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(239,68,68,0.35)'" ontouchstart="this.style.transform='scale(0.95)'" ontouchend="this.style.transform='scale(1)'">OUT</button>
      </div>

      <!-- Extra Runs Picker (appears above 4/6 buttons) -->
      <div id="extraPanel" class="panel" style="display:none;margin-bottom:8px;">
        <div id="extraLabel" class="muted" style="margin-bottom:10px;font-size:15px;font-weight:800;color:#1e40af;text-align:center;text-transform:uppercase;letter-spacing:0.5px;"></div>
        <!-- First Row -->
        <div class="row" style="margin-bottom:6px;gap:6px;">
          <button class="btn btn-action" onclick="applyExtra(0)" style="flex:1;padding:12px 0;font-size:16px;font-weight:700;border-radius:10px;transition:all 0.15s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">+0</button>
          <button class="btn btn-action" onclick="applyExtra(1)" style="flex:1;padding:12px 0;font-size:16px;font-weight:700;border-radius:10px;transition:all 0.15s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">+1</button>
          <button class="btn btn-action" onclick="applyExtra(2)" style="flex:1;padding:12px 0;font-size:16px;font-weight:700;border-radius:10px;transition:all 0.15s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">+2</button>
        </div>
        <!-- Second Row -->
        <div class="row" style="gap:6px;">
          <button class="btn btn-action" onclick="applyExtra(3)" style="flex:1;padding:12px 0;font-size:16px;font-weight:700;border-radius:10px;transition:all 0.15s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">+3</button>
          <button class="btn btn-action" onclick="applyExtra(4)" style="flex:1;padding:12px 0;font-size:16px;font-weight:700;border-radius:10px;transition:all 0.15s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">+4</button>
          <button class="btn btn-action" onclick="applyExtra(6)" style="flex:1;padding:12px 0;font-size:16px;font-weight:700;border-radius:10px;transition:all 0.15s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">+6</button>
        </div>
      </div>

      <!-- First Row: 0 1 4 6 -->
      <div class="row" style="margin-bottom:8px;gap:6px;">
        <button class="btn" onclick="addLegalRun(0)" style="flex:1;font-size:28px;padding:18px 0;background:#f1f5f9;color:#1e293b;font-weight:900;border:2px solid #cbd5e1;border-radius:14px;box-shadow:0 2px 4px rgba(0,0,0,0.06);transition:all 0.15s ease;" onmouseover="this.style.background='#e2e8f0';this.style.transform='scale(1.05)';this.style.boxShadow='0 4px 8px rgba(0,0,0,0.12)'" onmouseout="this.style.background='#f1f5f9';this.style.transform='scale(1)';this.style.boxShadow='0 2px 4px rgba(0,0,0,0.06)'" ontouchstart="this.style.transform='scale(0.95)'" ontouchend="this.style.transform='scale(1)'">0</button>
        <button class="btn" onclick="addLegalRun(1)" style="flex:1;font-size:28px;padding:18px 0;background:#f1f5f9;color:#1e293b;font-weight:900;border:2px solid #cbd5e1;border-radius:14px;box-shadow:0 2px 4px rgba(0,0,0,0.06);transition:all 0.15s ease;" onmouseover="this.style.background='#e2e8f0';this.style.transform='scale(1.05)';this.style.boxShadow='0 4px 8px rgba(0,0,0,0.12)'" onmouseout="this.style.background='#f1f5f9';this.style.transform='scale(1)';this.style.boxShadow='0 2px 4px rgba(0,0,0,0.06)'" ontouchstart="this.style.transform='scale(0.95)'" ontouchend="this.style.transform='scale(1)'">1</button>
        <button class="btn" onclick="addLegalRun(4)" style="flex:1;font-size:28px;padding:18px 0;background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:#fff;font-weight:900;border:none;border-radius:14px;box-shadow:0 4px 12px rgba(16,185,129,0.35);transition:all 0.15s ease;" onmouseover="this.style.transform='scale(1.05)';this.style.boxShadow='0 6px 16px rgba(16,185,129,0.45)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(16,185,129,0.35)'" ontouchstart="this.style.transform='scale(0.95)'" ontouchend="this.style.transform='scale(1)'">4</button>
        <button class="btn" onclick="addLegalRun(6)" style="flex:1;font-size:28px;padding:18px 0;background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);color:#fff;font-weight:900;border:none;border-radius:14px;box-shadow:0 4px 12px rgba(245,158,11,0.35);transition:all 0.15s ease;" onmouseover="this.style.transform='scale(1.05)';this.style.boxShadow='0 6px 16px rgba(245,158,11,0.45)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(245,158,11,0.35)'" ontouchstart="this.style.transform='scale(0.95)'" ontouchend="this.style.transform='scale(1)'">6</button>
      </div>

      <!-- Second Row: 2 3 5 ☰ -->
      <div class="row" style="margin-bottom:8px;gap:6px;">
        <button class="btn" onclick="addLegalRun(2)" style="flex:1;font-size:28px;padding:18px 0;background:#f1f5f9;color:#1e293b;font-weight:900;border:2px solid #cbd5e1;border-radius:14px;box-shadow:0 2px 4px rgba(0,0,0,0.06);transition:all 0.15s ease;" onmouseover="this.style.background='#e2e8f0';this.style.transform='scale(1.05)';this.style.boxShadow='0 4px 8px rgba(0,0,0,0.12)'" onmouseout="this.style.background='#f1f5f9';this.style.transform='scale(1)';this.style.boxShadow='0 2px 4px rgba(0,0,0,0.06)'" ontouchstart="this.style.transform='scale(0.95)'" ontouchend="this.style.transform='scale(1)'">2</button>
        <button class="btn" onclick="addLegalRun(3)" style="flex:1;font-size:28px;padding:18px 0;background:#f1f5f9;color:#1e293b;font-weight:900;border:2px solid #cbd5e1;border-radius:14px;box-shadow:0 2px 4px rgba(0,0,0,0.06);transition:all 0.15s ease;" onmouseover="this.style.background='#e2e8f0';this.style.transform='scale(1.05)';this.style.boxShadow='0 4px 8px rgba(0,0,0,0.12)'" onmouseout="this.style.background='#f1f5f9';this.style.transform='scale(1)';this.style.boxShadow='0 2px 4px rgba(0,0,0,0.06)'" ontouchstart="this.style.transform='scale(0.95)'" ontouchend="this.style.transform='scale(1)'">3</button>
        <button class="btn" onclick="addLegalRun(5)" style="flex:1;font-size:28px;padding:18px 0;background:#f1f5f9;color:#1e293b;font-weight:900;border:2px solid #cbd5e1;border-radius:14px;box-shadow:0 2px 4px rgba(0,0,0,0.06);transition:all 0.15s ease;" onmouseover="this.style.background='#e2e8f0';this.style.transform='scale(1.05)';this.style.boxShadow='0 4px 8px rgba(0,0,0,0.12)'" onmouseout="this.style.background='#f1f5f9';this.style.transform='scale(1)';this.style.boxShadow='0 2px 4px rgba(0,0,0,0.06)'" ontouchstart="this.style.transform='scale(0.95)'" ontouchend="this.style.transform='scale(1)'">5</button>
        <button class="btn btn-muted" onclick="showMoreOptions()" style="flex:1;font-size:20px;padding:18px 0;background:#475569;color:#fff;font-weight:900;border:none;border-radius:14px;box-shadow:0 4px 12px rgba(71,85,105,0.25);transition:all 0.15s ease;" onmouseover="this.style.background='#334155';this.style.transform='scale(1.05)';this.style.boxShadow='0 6px 16px rgba(71,85,105,0.35)'" onmouseout="this.style.background='#475569';this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(71,85,105,0.25)'" ontouchstart="this.style.transform='scale(0.95)'" ontouchend="this.style.transform='scale(1)'">☰</button>
      </div>

      <!-- Additional Options Row (Visible by Default) -->
      <div id="moreRunsRow" style="display:block;margin-top:0px;">
        <!-- Extras with Wicket Row -->
        <div class="row" style="gap:6px;">
          <button class="btn btn-extra" onclick="showWicketExtraModal('WD')" style="flex:1;font-size:13px;padding:10px 0;background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);font-weight:800;color:white;border:none;border-radius:10px;box-shadow:0 3px 10px rgba(245,158,11,0.3);transition:all 0.15s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 5px 14px rgba(245,158,11,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 3px 10px rgba(245,158,11,0.3)'">WD+W</button>
          <button class="btn btn-extra" onclick="showWicketExtraModal('NB')" style="flex:1;font-size:13px;padding:10px 0;background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);font-weight:800;color:white;border:none;border-radius:10px;box-shadow:0 3px 10px rgba(239,68,68,0.3);transition:all 0.15s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 5px 14px rgba(239,68,68,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 3px 10px rgba(239,68,68,0.3)'">NB+W</button>
          <button class="btn btn-wkt" onclick="showRunOutModal()" style="flex:1;font-size:13px;padding:10px 0;background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);font-weight:800;color:white;border:none;border-radius:10px;box-shadow:0 3px 10px rgba(139,92,246,0.3);transition:all 0.15s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 5px 14px rgba(139,92,246,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 3px 10px rgba(139,92,246,0.3)'">RUN OUT</button>
        </div>
      </div>
    </div>

    <!-- Result Display -->

    <!-- Wicket Extra Picker -->
    <div id="wicketPanel" class="panel" style="display:none">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;line-height:1;">
        <span style="color:#64748b;font-size:14px;font-weight:500;">⚡ Wicket Details</span>
        <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:13px;color:#64748b;font-weight:500;line-height:1;">
          <input type="checkbox" id="wicketNoBallCount" style="margin:0;vertical-align:middle;" />
          <span style="white-space:nowrap;">Don't Count Ball</span>
        </label>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px;">
        <!-- Delivery Column -->
        <div>
          <label style="font-size:13px;display:block;margin-bottom:4px;">🎯 Delivery</label>
          <select id="wicketDelivery" style="font-size:14px;padding:6px 8px;width:100%;">
            <option value="legal">Run Out</option>
            <option value="WD">WD - Wide</option>
            <option value="NB">NB - NoBall</option>
            <option value="BYE">B - BYE</option>
          </select>
        </div>
        
        <!-- Runs Column -->
        <div>
          <label style="font-size:13px;display:block;margin-bottom:4px;">🏃 Runs</label>
          <input id="wicketRuns" type="number" min="0" max="99" value="0" placeholder="0-99" style="font-size:14px;padding:6px 8px;width:100%;" />
        </div>
        
        <!-- Buttons Column -->
        <div style="display:flex;flex-direction:column;gap:6px;">
          <button class="btn btn-action" onclick="confirmWicketExtra()" style="font-size:14px;padding:6px 0;">✓</button>
          <button class="btn btn-muted" onclick="cancelWicketExtra()" style="font-size:14px;padding:6px 0;">✕</button>
        </div>
      </div>
      
      <div style="padding:6px;background:#f8fafc;border-radius:8px;font-size:12px;color:#64748b;text-align:center;line-height:1.3;">
        💡 For wickets on extras or when ball shouldn't count
      </div>
    </div>

    <!-- Controls -->
    <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:auto auto;gap:8px;">
      <!-- End Innings Button -->
      <button class="btn btn-action" style="width:100%;font-size:14px;padding:10px 0;background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);border:none;border-radius:10px;font-weight:700;box-shadow:0 2px 8px rgba(59,130,246,0.3);transition:all 0.2s ease;" onclick="endInnings()" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(59,130,246,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(59,130,246,0.3)'">🏁 End Innings</button>
      
      <!-- Undo Button (spans 2 rows) -->
      <button class="btn btn-undo" style="width:100%;font-size:18px;padding:10px 0;background:linear-gradient(135deg, #f43f5e 0%, #e11d48 100%);border:none;border-radius:10px;font-weight:800;box-shadow:0 2px 8px rgba(244,63,94,0.3);transition:all 0.2s ease;grid-row:span 2;letter-spacing:0.5px;" onclick="undoLastAction()" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(244,63,94,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(244,63,94,0.3)'"><span style="font-size:24px;">↶</span> Undo</button>
      
      <!-- Delete Match Button -->
      <a href="javascript:void(0)" onclick="deleteCurrentMatch()" style="color:#fff;text-decoration:none;font-size:14px;font-weight:700;padding:10px 0;border-radius:10px;background:linear-gradient(135deg, #dc2626 0%, #991b1b 100%);border:none;display:flex;align-items:center;justify-content:center;transition:all 0.2s ease;text-align:center;box-shadow:0 2px 8px rgba(220,38,38,0.4);" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(220,38,38,0.5)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(220,38,38,0.4)'">🗑️ Delete Match</a>
    </div>

    <!-- Match Summary -->
    <div id="matchSummary" style="margin-top:20px;">
      <div style="font-size:16px;font-weight:700;color:var(--text-primary);margin-bottom:16px;text-align:center;">
        📊 MATCH SUMMARY
      </div>
      
      <!-- 3-Column Table for Match Summary -->
      <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
        <table id="matchSummaryTable" style="width:100%;border-collapse:collapse;background:#f8fafc;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
          <thead>
            <tr style="background:linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);color:#fff;">
              <th rowspan="2" style="padding:8px 4px;font-size:12px;font-weight:700;text-align:center;border-right:1px solid rgba(255,255,255,0.2);width:40px;vertical-align:middle;">Ovs</th>
              <th id="team1Header" style="padding:6px 6px 2px 6px;font-size:13px;font-weight:700;text-align:center;border-right:1px solid rgba(255,255,255,0.2);width:50%;">Team 1</th>
              <th id="team2Header" style="padding:6px 6px 2px 6px;font-size:13px;font-weight:700;text-align:center;width:50%;">Team 2</th>
            </tr>
            <tr style="background:linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);color:#fff;">
              <th id="team1Stats" style="padding:2px 6px 6px 6px;font-size:10px;font-weight:600;text-align:center;border-right:1px solid rgba(255,255,255,0.2);opacity:0.9;">—</th>
              <th id="team2Stats" style="padding:2px 6px 6px 6px;font-size:10px;font-weight:600;text-align:center;opacity:0.9;">—</th>
            </tr>
          </thead>
          <tbody id="matchSummaryBody">
            <tr>
              <td colspan="3" style="text-align:center;color:#94a3b8;padding:20px;font-size:13px;">No overs bowled yet</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Action Buttons -->
    <div style="margin-top:12px;padding:12px 0;border-top:1px solid #e5e7eb;display:grid;grid-template-columns:1fr 1fr;gap:8px 12px;">
      <!-- WhatsApp Viewer Link Button -->
      <a id="shareBtn" href="javascript:void(0)" onclick="shareViewerLink()" style="color:#fff;text-decoration:none;font-size:13px;font-weight:700;padding:12px 16px;border-radius:12px;background:linear-gradient(135deg, #25D366 0%, #128C7E 100%);border:none;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;text-align:center;box-shadow:0 4px 12px rgba(37,211,102,0.3);position:relative;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(37,211,102,0.5)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(37,211,102,0.3)'">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right:6px;">
          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
        </svg>
        <span>Share on WhatsApp</span>
      </a>
      
      <!-- Scorer Link (Private) Button -->
      <a href="javascript:void(0)" onclick="shareScorerLink()" style="color:#fff;text-decoration:none;font-size:13px;font-weight:700;padding:12px 16px;border-radius:12px;background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);border:none;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;text-align:center;box-shadow:0 4px 12px rgba(245,158,11,0.3);" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(245,158,11,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(245,158,11,0.3)'">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </svg>
        <span>Scorer (Private)</span>
      </a>
      
      <!-- Tournament Link Button -->
      <a href="javascript:void(0)" onclick="shareTournamentLink()" style="color:#fff;text-decoration:none;font-size:13px;font-weight:700;padding:12px 16px;border-radius:12px;background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);border:none;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;text-align:center;box-shadow:0 4px 12px rgba(139,92,246,0.3);" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(139,92,246,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(139,92,246,0.3)'">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;">
          <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
          <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
          <path d="M4 22h16"></path>
          <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
          <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
          <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
        </svg>
        <span>Tournament Link</span>
      </a>
      
      <!-- Export/Share Button -->
      <a href="javascript:void(0)" onclick="exportScoreboard()" style="color:#fff;text-decoration:none;font-size:13px;font-weight:700;padding:12px 16px;border-radius:12px;background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);border:none;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;text-align:center;box-shadow:0 4px 12px rgba(59,130,246,0.3);" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(59,130,246,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(59,130,246,0.3)'">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;">
          <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
          <polyline points="16 6 12 2 8 6"></polyline>
          <line x1="12" y1="2" x2="12" y2="15"></line>
        </svg>
        <span>Export/Share</span>
      </a>
    </div>

  </div>

</div>

<script>
// Prevent accidental refresh/close after match starts
let matchStarted = false;
/* ---------------- State ---------------- */
function makeInnings(){
  return {
    runs:0, wkts:0,
    legalBalls:0,                 // total legal balls in innings
    overs:[],                     // array of completed overs (each = array of symbols)
    curOver:[],                   // symbols in current (in-progress) over
    curOverLegal:0,               // legal balls in current over
    done:false,
    extras: { wd: 0, nb: 0, b: 0, lb: 0 }  // track extras separately
  };
}
let teamA, teamB, oversLimit=2, wicketsLimit=10;
let first = makeInnings();
let second = makeInnings();
let inSecond=false, resultText="", target=0, matchCompleted=false;
let pendingExtra=null; // {type:'NB'|'WD'|'B'|'LB'}

// Undo stack: stores deep copies of state before each action
let undoStack = [];

function currentInnings(){ return inSecond ? second : first; }

function currentMatchOver() {
  // Returns true if match is over (second innings done and result declared)
  return inSecond && (second.done || resultText && (second.runs >= first.runs + 1 || second.legalBalls >= oversLimit*6));
}

/* ---------------- UI Helpers ---------------- */
function showExtraPanel(show, label=""){
  const panel = document.getElementById("extraPanel");
  const lab = document.getElementById("extraLabel");
  panel.style.display = show ? "block" : "none";
  lab.textContent = label;
}
function updateUI(){
  const inn = currentInnings();
  const batting = inSecond ? teamB : teamA;
  const bowling = inSecond ? teamA : teamB;

  // Primary Score Display
  document.getElementById("score").textContent = `${inn.runs}/${inn.wkts}`;

  // Team Name
  document.getElementById("status").textContent = batting;
  
  // First Innings Score (show when in second innings)
  const firstInningsScoreElem = document.getElementById("firstInningsScore");
  const bowlingTeamDisplay = document.getElementById("bowlingTeamDisplay");
  
  if (inSecond && firstInningsScoreElem) {
    const firstOvers = Math.floor(first.legalBalls/6);
    const firstBalls = first.legalBalls % 6;
    firstInningsScoreElem.textContent = `${teamA}: ${first.runs}/${first.wkts} (${firstOvers}.${firstBalls})`;
    firstInningsScoreElem.style.display = 'block';
    // Hide bowling team display in second innings as first innings score already shows it
    bowlingTeamDisplay.style.display = 'none';
  } else {
    if (firstInningsScoreElem) {
      firstInningsScoreElem.style.display = 'none';
    }
    // Show bowling team display in first innings
    bowlingTeamDisplay.textContent = `vs ${bowling}`;
    bowlingTeamDisplay.style.display = 'block';
  }

  // Overs and Run Rate
  const overs = Math.floor(inn.legalBalls/6);
  const ballsInOver = inn.legalBalls % 6;
  
  let balls = inn.legalBalls;
  let rr = balls > 0 ? (inn.runs * 6 / balls).toFixed(2) : '0.00';

  // Live Over Display (replaces Ball Tracker) - Compact View
  const liveOverDiv = document.getElementById("liveOverDisplay");
  
  // Helper to calculate runs/wickets for an over
  function overRunsAndWkts(arr) {
    let runs = 0, wkts = 0;
    arr.forEach(sym => {
      if (typeof sym === 'string') {
        // New format with + signs
        if (/^([0-9]+)\+W$/.test(sym)) { runs += parseInt(sym); wkts += 1; }
        else if (/^W$/.test(sym)) { wkts += 1; }
        else if (/^WD\+([0-9]+)\+W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^WD\+([0-9]+)\+W$/)[1]); wkts += 1; }
        else if (/^WD\+W$/.test(sym)) { runs += 1; wkts += 1; }
        else if (/^NB\+([0-9]+)\+W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^NB\+([0-9]+)\+W$/)[1]); wkts += 1; }
        else if (/^NB\+W$/.test(sym)) { runs += 1; wkts += 1; }
        else if (/^B\+([0-9]+)\+W$/.test(sym)) { runs += parseInt(sym.match(/^B\+([0-9]+)\+W$/)[1]); wkts += 1; }
        else if (/^B\+W$/.test(sym)) { runs += 0; wkts += 1; }
        // Old format (backward compatibility)
        else if (/^([0-9]+)W$/.test(sym)) { runs += parseInt(sym); wkts += 1; }
        else if (/^WD\+([0-9]+)W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^WD\+([0-9]+)W$/)[1]); wkts += 1; }
        else if (/^WDW$/.test(sym)) { runs += 1; wkts += 1; }
        else if (/^NB\+([0-9]+)W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^NB\+([0-9]+)W$/)[1]); wkts += 1; }
        else if (/^NBW$/.test(sym)) { runs += 1; wkts += 1; }
        else if (/^B\+([0-9]+)W$/.test(sym)) { runs += parseInt(sym.match(/^B\+([0-9]+)W$/)[1]); wkts += 1; }
        else if (/^BW$/.test(sym)) { runs += 0; wkts += 1; }
        // Normal balls
        else if (/^[0-9]$/.test(sym)) runs += parseInt(sym);
        else if (/^NB$/.test(sym) || /^WD$/.test(sym)) runs += 1;
        else if (/^NB\+([0-9]+)$/.test(sym)) runs += 1 + parseInt(sym.match(/^NB\+([0-9]+)$/)[1]);
        else if (/^WD\+([0-9]+)$/.test(sym)) runs += 1 + parseInt(sym.match(/^WD\+([0-9]+)$/)[1]);
        else if (/^B\+([0-9]+)$/.test(sym)) runs += parseInt(sym.match(/^B\+([0-9]+)$/)[1]);
        else if (/^LB\+([0-9]+)$/.test(sym)) runs += parseInt(sym.match(/^LB\+([0-9]+)$/)[1]);
      }
    });
    return {runs, wkts};
  }
  
  // Show current over if it has balls, or last completed over if current is empty
  if (inn.curOver.length > 0) {
    // Current over in progress
    const ballsChips = inn.curOver.map(sym => {
      // Check if it's a wicket - must end with W or have +W pattern (not just contain W like WD)
      const isWicket = /W$/.test(sym) || /\+W$/.test(sym);
      const bgColor = isWicket ? '#ef4444' : '#3b82f6';
      const borderColor = isWicket ? '#dc2626' : '#2563eb';
      return `<span style="display:inline-flex;align-items:center;margin:1px 2px;padding:4px 7px;border-radius:6px;background:${bgColor};color:#fff;font-weight:700;border:none;font-size:11px;box-shadow:0 1px 3px rgba(0,0,0,0.1);white-space:nowrap;">${sym}</span>`;
    }).join('');
    const overStats = overRunsAndWkts(inn.curOver);
    liveOverDiv.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;width:100%;gap:8px;">
      <div style="display:flex;flex-wrap:wrap;align-items:center;flex:1;min-width:0;">${ballsChips}</div>
      <div style="flex-shrink:0;padding:5px 10px;background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);color:#fff;font-weight:800;font-size:13px;border-radius:8px;box-shadow:0 2px 6px rgba(59,130,246,0.3);white-space:nowrap;">${overStats.runs}/${overStats.wkts}</div>
    </div>`;
    liveOverDiv.style.display = 'flex';
  } else if (inn.overs.length > 0) {
    // Show last completed over until next over starts
    const lastOver = inn.overs[inn.overs.length - 1];
    const ballsChips = lastOver.map(sym => {
      // Check if it's a wicket - must end with W or have +W pattern (not just contain W like WD)
      const isWicket = /W$/.test(sym) || /\+W$/.test(sym);
      const bgColor = isWicket ? '#ef4444' : '#10b981';
      const borderColor = isWicket ? '#dc2626' : '#059669';
      return `<span style="display:inline-flex;align-items:center;margin:1px 2px;padding:4px 7px;border-radius:6px;background:${bgColor};color:#fff;font-weight:700;border:none;font-size:11px;box-shadow:0 1px 3px rgba(0,0,0,0.1);white-space:nowrap;">${sym}</span>`;
    }).join('');
    const overStats = overRunsAndWkts(lastOver);
    liveOverDiv.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;width:100%;gap:8px;">
      <div style="display:flex;flex-wrap:wrap;align-items:center;flex:1;min-width:0;opacity:0.85;">${ballsChips}</div>
      <div style="flex-shrink:0;padding:5px 10px;background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:#fff;font-weight:800;font-size:13px;border-radius:8px;box-shadow:0 2px 6px rgba(16,185,129,0.3);white-space:nowrap;">${overStats.runs}/${overStats.wkts}</div>
    </div>`;
    liveOverDiv.style.display = 'flex';
  } else {
    liveOverDiv.innerHTML = `<div style="color:#94a3b8;font-size:12px;font-weight:600;text-align:center;width:100%;padding:2px 0;">No balls bowled yet</div>`;
    liveOverDiv.style.display = 'flex';
  }

  // --- First Innings Info (for second innings only) ---
  const firstInfoDiv = document.getElementById("firstInningsInfo");
  if (inSecond && !resultText) {
    const need = Math.max(first.runs + 1 - second.runs, 0);
    const ballsLeft = (oversLimit * 6) - second.legalBalls;
    const reqRR = ballsLeft > 0 ? (need * 6 / ballsLeft).toFixed(2) : '0.00';
    
    firstInfoDiv.style.display = 'block';
    firstInfoDiv.innerHTML = `Need <b>${need}</b> runs in <b>${ballsLeft}</b> balls | RRR: <b>${reqRR}</b>`;
  } else {
    firstInfoDiv.style.display = 'none';
    firstInfoDiv.innerHTML = '';
  }

  // --- Calculate Extras and This Over ---
  let extras = 0;
  let thisOverRuns = 0;
  let thisOverWkts = 0;

  // Count extras from all overs and current over
  function countOverSymbols(arr) {
    arr.forEach(sym => {
      if (typeof sym === 'string') {
        // Handle wicket extras (WD+W, NB+W, WD+2+W, etc.)
        if (/^WD\+([0-9]+)\+W$/.test(sym)) {
          const runs = parseInt(sym.match(/^WD\+([0-9]+)\+W$/)[1]);
          extras += 1 + runs;
        } else if (/^WD\+W$/.test(sym)) {
          extras += 1;
        } else if (/^NB\+([0-9]+)\+W$/.test(sym)) {
          const runs = parseInt(sym.match(/^NB\+([0-9]+)\+W$/)[1]);
          extras += 1 + runs;
        } else if (/^NB\+W$/.test(sym)) {
          extras += 1;
        } else if (/^B\+([0-9]+)\+W$/.test(sym)) {
          const runs = parseInt(sym.match(/^B\+([0-9]+)\+W$/)[1]);
          extras += runs;
        } else if (/^B\+W$/.test(sym)) {
          extras += 0;
        }
        // Handle non-wicket extras
        else if (/^NB\+([0-9]+)$/.test(sym)) {
          extras += 1 + parseInt(sym.match(/^NB\+([0-9]+)$/)[1]);
        } else if (/^WD\+([0-9]+)$/.test(sym)) {
          extras += 1 + parseInt(sym.match(/^WD\+([0-9]+)$/)[1]);
        } else if (sym === 'NB' || sym === 'WD') {
          extras += 1;
        } else if (/^B\+([0-9]+)$/.test(sym)) {
          extras += parseInt(sym.match(/^B\+([0-9]+)$/)[1]);
        } else if (/^LB\+([0-9]+)$/.test(sym)) {
          extras += parseInt(sym.match(/^LB\+([0-9]+)$/)[1]);
        }
      }
    });
  }
  inn.overs.forEach(countOverSymbols);
  countOverSymbols(inn.curOver);

  const thisOver = overRunsAndWkts(inn.curOver);
  thisOverRuns = thisOver.runs;
  thisOverWkts = thisOver.wkts;
  
  // Display consolidated Overs/RR/Extras in chip banner
  document.getElementById("oversExtrasInfo").innerHTML = `O's: <b>(${overs}.${ballsInOver}/${oversLimit})</b> | RR: <b>${rr}</b> | Ext's: <b>${extras}</b>`;

  // Update page title with team names
  if (teamA && teamB) {
    document.getElementById('pageTitle').textContent = `${teamA} vs ${teamB} - Cricket Scorer`;
  }

  // Update tournament header display
  const tournamentHeaderScorer = document.getElementById('tournamentHeaderScorer');
  const tournamentTitleScorer = document.getElementById('tournamentTitleScorer');
  const tournamentNameValue = document.getElementById('tournamentName')?.value || '';
  const matchTypeValue = document.getElementById('matchType')?.value || '';
  
  if (tournamentNameValue && tournamentNameValue.trim() !== '') {
    const matchTypeText = matchTypeValue ? ` - ${matchTypeValue}` : '';
    tournamentTitleScorer.textContent = `#${tournamentNameValue}${matchTypeText}`;
    tournamentHeaderScorer.style.display = 'block';
  } else {
    tournamentHeaderScorer.style.display = 'none';
  }

  // Result
  const resultDiv = document.getElementById("result");
  const newMatchContainer = document.getElementById("newMatchContainer");
  if (resultText) {
    resultDiv.textContent = resultText;
    resultDiv.style.display = 'block';
    newMatchContainer.style.display = 'block';
  } else {
    resultDiv.style.display = 'none';
    newMatchContainer.style.display = 'none';
  }

  // Disable main buttons while choosing extra runs or wicket details
  const disable = !!pendingExtra || document.getElementById('wicketPanel').style.display === 'block';
  [...document.querySelectorAll(".btn-run, .btn-wkt, .btn-extra, .btn-muted")].forEach(b=> {
    // Only modify buttons if user has edit permission
    if (canEditMatch) {
      if (b.onclick && (b.onclick.toString().includes('addLegalRun') || 
          b.onclick.toString().includes('quickWicket') || 
          b.onclick.toString().includes('showMoreOptions'))) {
        b.disabled = disable;
      }
      // Keep extra buttons (WD, NB, Byes, LB) enabled to allow switching/canceling
      if (b.onclick && b.onclick.toString().includes('startExtra')) {
        b.disabled = false;
      }
    }
    // If no edit permission, buttons stay disabled (handled by updateEditModeUI)
  });
  
  // Save to Firebase after each update (if not in viewer mode and has edit permission)
  // Don't save if we're currently loading data from Firebase (prevents loop)
  if (!isViewerMode && firebaseEnabled && canEditMatch && !isLoadingFromFirebase) {
    saveMatchState();
  }
  
  // Update match summary display
  updateMatchSummary();
}

// Update Match Summary Table
function updateMatchSummary() {
  // Calculate team 1 stats
  const team1Runs = first.runs || 0;
  const team1Wkts = first.wkts || 0;
  const team1Overs = calculateOvers(first.legalBalls || 0);
  const team1Extras = calculateExtrasForInnings(first);
  const team1RR = first.legalBalls > 0 ? ((team1Runs * 6) / first.legalBalls).toFixed(2) : '0.00';
  
  // Calculate team 2 stats
  const team2Runs = second.runs || 0;
  const team2Wkts = second.wkts || 0;
  const team2Overs = calculateOvers(second.legalBalls || 0);
  const team2Extras = calculateExtrasForInnings(second);
  const team2RR = second.legalBalls > 0 ? ((team2Runs * 6) / second.legalBalls).toFixed(2) : '0.00';
  
  // Update team headers with scores
  document.getElementById('team1Header').textContent = `${teamA || 'Team 1'} - ${team1Runs}/${team1Wkts}`;
  document.getElementById('team2Header').textContent = `${teamB || 'Team 2'} - ${team2Runs}/${team2Wkts}`;
  
  // Update team stats row
  document.getElementById('team1Stats').textContent = `(${team1Overs} ovs) | RR: ${team1RR} | Exts: ${team1Extras}`;
  document.getElementById('team2Stats').textContent = inSecond ? `(${team2Overs} ovs) | RR: ${team2RR} | Exts: ${team2Extras}` : '—';
  
  // Get all overs for both innings
  const firstOvers = [...(first.overs || [])];
  const secondOvers = [...(second.overs || [])];
  
  // Add current over if innings is done or has incomplete over
  const firstInningsDone = first.done || inSecond;
  if (firstInningsDone && first.curOver && first.curOver.length > 0) {
    firstOvers.push(first.curOver);
  }
  
  const secondInningsDone = second.done || matchCompleted;
  if (secondInningsDone && second.curOver && second.curOver.length > 0) {
    secondOvers.push(second.curOver);
  }
  
  // Determine maximum number of overs to display
  const maxOvers = Math.max(firstOvers.length, secondOvers.length);
  
  if (maxOvers === 0) {
    document.getElementById('matchSummaryBody').innerHTML = '<tr><td colspan="3" style="text-align:center;color:#94a3b8;padding:20px;font-size:13px;">No overs bowled yet</td></tr>';
    return;
  }
  
  // Build table rows
  let tableHtml = '';
  let firstCumulativeRuns = 0;
  let firstCumulativeWkts = 0;
  let secondCumulativeRuns = 0;
  let secondCumulativeWkts = 0;
  
  for (let i = 0; i < maxOvers; i++) {
    const overNum = i + 1;
    const firstOver = firstOvers[i];
    const secondOver = secondOvers[i];
    
    // Calculate runs/wickets for this over
    const firstStats = firstOver ? overRunsAndWktsHelper(firstOver) : null;
    const secondStats = secondOver ? overRunsAndWktsHelper(secondOver) : null;
    
    // Update cumulative scores
    if (firstStats) {
      firstCumulativeRuns += firstStats.runs;
      firstCumulativeWkts += firstStats.wkts;
    }
    if (secondStats) {
      secondCumulativeRuns += secondStats.runs;
      secondCumulativeWkts += secondStats.wkts;
    }
    
    // Build balls HTML for first innings
    const firstBallsHtml = firstOver ? firstOver.map(sym => {
      const isWicket = /W$/.test(sym) || /\+W$/.test(sym);
      let bgColor = '#3b82f6';
      if (isWicket) bgColor = '#e31d1d';
      else if (sym === 6 || sym === '6') bgColor = '#f59e0b';
      else if (sym === 4 || sym === '4') bgColor = '#10b981';
      else if (sym === 0 || sym === '0') bgColor = '#94a3b8';
      else if (typeof sym === 'string' && (sym.includes('WD') || sym.includes('NB') || sym.includes('B+') || sym.includes('LB+'))) bgColor = '#f59e0b';
      return `<span style="display:inline-block;margin:2px;padding:3px 6px;border-radius:6px;background:${bgColor};color:#fff;font-weight:700;font-size:11px;">${sym}</span>`;
    }).join('') : '<span style="color:#cbd5e1;font-size:12px;">—</span>';
    
    // Build balls HTML for second innings
    const secondBallsHtml = secondOver ? secondOver.map(sym => {
      const isWicket = /W$/.test(sym) || /\+W$/.test(sym);
      let bgColor = '#3b82f6';
      if (isWicket) bgColor = '#e31d1d';
      else if (sym === 6 || sym === '6') bgColor = '#f59e0b';
      else if (sym === 4 || sym === '4') bgColor = '#10b981';
      else if (sym === 0 || sym === '0') bgColor = '#94a3b8';
      else if (typeof sym === 'string' && (sym.includes('WD') || sym.includes('NB') || sym.includes('B+') || sym.includes('LB+'))) bgColor = '#f59e0b';
      return `<span style="display:inline-block;margin:2px;padding:3px 6px;border-radius:6px;background:${bgColor};color:#fff;font-weight:700;font-size:11px;">${sym}</span>`;
    }).join('') : '<span style="color:#cbd5e1;font-size:12px;">—</span>';
    
    tableHtml += `
      <tr style="border-bottom:1px solid #e2e8f0;">
        <td style="padding:8px 4px;text-align:center;font-weight:700;color:#1f2937;font-size:12px;border-right:1px solid #e2e8f0;background:#f1f5f9;vertical-align:top;">${overNum}</td>
        <td style="padding:8px 6px;border-right:1px solid #e2e8f0;background:#fff;vertical-align:top;width:50%;">
          ${firstStats ? `<div style="font-size:10px;color:#64748b;font-weight:600;margin-bottom:4px;">(${firstCumulativeRuns}/${firstCumulativeWkts}) R:${firstStats.runs} | W:${firstStats.wkts}</div>` : ''}
          <div>${firstBallsHtml}</div>
        </td>
        <td style="padding:8px 6px;background:#fff;vertical-align:top;width:50%;">
          ${secondStats ? `<div style="font-size:10px;color:#64748b;font-weight:600;margin-bottom:4px;">(${secondCumulativeRuns}/${secondCumulativeWkts}) R:${secondStats.runs} | W:${secondStats.wkts}</div>` : ''}
          <div>${secondBallsHtml}</div>
        </td>
      </tr>
    `;
  }
  
  document.getElementById('matchSummaryBody').innerHTML = tableHtml;
}

// Helper to calculate overs from legal balls
function calculateOvers(legalBalls) {
  if (!legalBalls || legalBalls === 0) return '0.0';
  const overs = Math.floor(legalBalls / 6);
  const balls = legalBalls % 6;
  return `${overs}.${balls}`;
}

// Helper to calculate extras for an innings
function calculateExtrasForInnings(inn) {
  let extras = 0;
  
  // Check completed overs
  if (inn.overs && inn.overs.length > 0) {
    inn.overs.forEach(over => {
      if (over && over.length > 0) {
        over.forEach(ball => {
          if (typeof ball === 'string') {
            if (/^WD/.test(ball)) {
              const match = ball.match(/^WD\+?(\d+)?/);
              extras += 1;
              if (match && match[1]) extras += parseInt(match[1]);
            }
            else if (/^NB/.test(ball)) {
              const match = ball.match(/^NB\+?(\d+)?/);
              extras += 1;
              if (match && match[1]) extras += parseInt(match[1]);
            }
            else if (/^B\+/.test(ball)) {
              const match = ball.match(/^B\+(\d+)/);
              if (match && match[1]) extras += parseInt(match[1]);
            }
            else if (/^LB\+/.test(ball)) {
              const match = ball.match(/^LB\+(\d+)/);
              if (match && match[1]) extras += parseInt(match[1]);
            }
          }
        });
      }
    });
  }
  
  // Check current over
  if (inn.curOver && inn.curOver.length > 0) {
    inn.curOver.forEach(ball => {
      if (typeof ball === 'string') {
        if (/^WD/.test(ball)) {
          const match = ball.match(/^WD\+?(\d+)?/);
          extras += 1;
          if (match && match[1]) extras += parseInt(match[1]);
        }
        else if (/^NB/.test(ball)) {
          const match = ball.match(/^NB\+?(\d+)?/);
          extras += 1;
          if (match && match[1]) extras += parseInt(match[1]);
        }
        else if (/^B\+/.test(ball)) {
          const match = ball.match(/^B\+(\d+)/);
          if (match && match[1]) extras += parseInt(match[1]);
        }
        else if (/^LB\+/.test(ball)) {
          const match = ball.match(/^LB\+(\d+)/);
          if (match && match[1]) extras += parseInt(match[1]);
        }
      }
    });
  }
  
  return extras;
}

// Helper to calculate runs/wickets for an over
function overRunsAndWktsHelper(arr) {
  let runs = 0, wkts = 0;
  arr.forEach(sym => {
    if (typeof sym === 'string') {
      // New format with + signs
      if (/^([0-9]+)\+W$/.test(sym)) { runs += parseInt(sym); wkts += 1; }
      else if (/^W$/.test(sym)) { wkts += 1; }
      else if (/^WD\+([0-9]+)\+W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^WD\+([0-9]+)\+W$/)[1]); wkts += 1; }
      else if (/^WD\+W$/.test(sym)) { runs += 1; wkts += 1; }
      else if (/^NB\+([0-9]+)\+W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^NB\+([0-9]+)\+W$/)[1]); wkts += 1; }
      else if (/^NB\+W$/.test(sym)) { runs += 1; wkts += 1; }
      else if (/^B\+([0-9]+)\+W$/.test(sym)) { runs += parseInt(sym.match(/^B\+([0-9]+)\+W$/)[1]); wkts += 1; }
      else if (/^B\+W$/.test(sym)) { runs += 0; wkts += 1; }
      // Old format (backward compatibility)
      else if (/^([0-9]+)W$/.test(sym)) { runs += parseInt(sym); wkts += 1; }
      else if (/^WD\+([0-9]+)W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^WD\+([0-9]+)W$/)[1]); wkts += 1; }
      else if (/^WDW$/.test(sym)) { runs += 1; wkts += 1; }
      else if (/^NB\+([0-9]+)W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^NB\+([0-9]+)W$/)[1]); wkts += 1; }
      else if (/^NBW$/.test(sym)) { runs += 1; wkts += 1; }
      else if (/^B\+([0-9]+)W$/.test(sym)) { runs += parseInt(sym.match(/^B\+([0-9]+)W$/)[1]); wkts += 1; }
      else if (/^BW$/.test(sym)) { runs += 0; wkts += 1; }
      // Normal balls
      else if (/^[0-9]$/.test(sym)) runs += parseInt(sym);
      else if (/^NB$/.test(sym) || /^WD$/.test(sym)) runs += 1;
      else if (/^NB\+([0-9]+)$/.test(sym)) runs += 1 + parseInt(sym.match(/^NB\+([0-9]+)$/)[1]);
      else if (/^WD\+([0-9]+)$/.test(sym)) runs += 1 + parseInt(sym.match(/^WD\+([0-9]+)$/)[1]);
      else if (/^B\+([0-9]+)$/.test(sym)) runs += parseInt(sym.match(/^B\+([0-9]+)$/)[1]);
      else if (/^LB\+([0-9]+)$/.test(sym)) runs += parseInt(sym.match(/^LB\+([0-9]+)$/)[1]);
    } else if (typeof sym === 'number') {
      runs += sym;
    }
  });
  return {runs, wkts};
}

// ========== Firebase Sync Functions ==========

function saveMatchState() {
  if (!db || !matchId) return;
  
  const matchData = {
    teamA: teamA,
    teamB: teamB,
    tournamentName: document.getElementById('tournamentName')?.value || '',
    matchType: document.getElementById('matchType')?.value || 'League Match',
    target: target,
    oversLimit: oversLimit,
    wicketsLimit: wicketsLimit,
    first: first,
    second: second,
    inSecond: inSecond,  // Save the boolean instead of the function
    resultText: resultText,
    matchCompleted: matchCompleted,
    lastUpdated: Date.now(),
    timestamp: new Date().toISOString(),
    organizationId: organizationId,  // Store org ID with match data
    editToken: editToken  // Store edit token for protection
  };
  
  // Determine the Firebase path based on whether it's a tournament or quick match
  const tournamentName = matchData.tournamentName;
  const matchPath = (tournamentName && tournamentName.trim() !== '') 
    ? 'tournaments/' + organizationId + '/matches/' + matchId
    : 'quickMatches/' + organizationId + '/matches/' + matchId;
  
  db.ref(matchPath).set(matchData)
    .then(() => {
      console.log("💾 Match state saved to Firebase at:", matchPath);
      
      // Track this match in user's all-matches history
      addMatchToUserHistory({
        matchId: matchId,
        organizationId: organizationId,
        teamA: teamA,
        teamB: teamB,
        tournamentName: matchData.tournamentName,
        matchType: matchData.matchType,
        timestamp: matchData.lastUpdated,
        isQuickMatch: !matchData.tournamentName || matchData.tournamentName.trim() === ''
      });
      
      // Also update localStorage session
      if (canEditMatch) {
        saveCurrentMatchSession();
      }
    })
    .catch(err => console.error("❌ Firebase save error:", err));
}

function listenForUpdates() {
  if (!db || !matchId) {
    console.warn("⚠️ Cannot listen for updates - Firebase not initialized or no matchId");
    return;
  }
  
  console.log("👂 Listening for match updates:", matchId);
  
  // Try to get tournamentName from saved session first, then from input field
  const savedSession = loadCurrentMatchSession();
  let tournamentName = '';
  
  if (savedSession && savedSession.tournamentName) {
    tournamentName = savedSession.tournamentName;
    console.log("📋 Using tournament name from saved session:", tournamentName);
  } else {
    tournamentName = document.getElementById('tournamentName')?.value || '';
  }
  
  // Determine the Firebase path based on whether it's a tournament or quick match
  const primaryPath = (tournamentName && tournamentName.trim() !== '') 
    ? 'tournaments/' + organizationId + '/matches/' + matchId
    : 'quickMatches/' + organizationId + '/matches/' + matchId;
  
  // Fallback path (opposite of primary)
  const fallbackPath = (tournamentName && tournamentName.trim() !== '') 
    ? 'quickMatches/' + organizationId + '/matches/' + matchId
    : 'tournaments/' + organizationId + '/matches/' + matchId;
  
  console.log("📍 Primary path:", primaryPath);
  console.log("📍 Fallback path:", fallbackPath);
  
  // Function to set up listener on a given path
  const setupListener = (matchPath) => {
    db.ref(matchPath).on('value', (snapshot) => {
      const data = snapshot.val();
      if (!data) {
        console.warn("⚠️ No match data found at path:", matchPath);
        
        // If this was the primary path and no data found, try fallback
        if (matchPath === primaryPath) {
          console.log("🔄 Trying fallback path...");
          // Remove listener from primary path first
          db.ref(primaryPath).off('value');
          // Try fallback path
          setupListener(fallbackPath);
        }
        return;
      }
      
      console.log("📡 Received update from Firebase at:", matchPath);
    
      // Set flag to prevent save loop
      isLoadingFromFirebase = true;
      
      // Update local state with proper initialization
      teamA = data.teamA;
      teamB = data.teamB;
      target = data.target;
      oversLimit = data.oversLimit;
      wicketsLimit = data.wicketsLimit;
      
      // Ensure innings data has proper structure
      first = {
        runs: data.first.runs || 0,
        wkts: data.first.wkts || 0,
        legalBalls: data.first.legalBalls || 0,
        overs: data.first.overs || [],
        curOver: data.first.curOver || [],
        curOverLegal: data.first.curOverLegal || 0,
        done: data.first.done || false,
        extras: data.first.extras || { wd: 0, nb: 0, b: 0, lb: 0 }
      };
      
      second = {
        runs: data.second.runs || 0,
        wkts: data.second.wkts || 0,
        legalBalls: data.second.legalBalls || 0,
        overs: data.second.overs || [],
        curOver: data.second.curOver || [],
        curOverLegal: data.second.curOverLegal || 0,
        done: data.second.done || false,
        extras: data.second.extras || { wd: 0, nb: 0, b: 0, lb: 0 }
      };
      
      inSecond = data.inSecond;  // Use boolean instead of function
      resultText = data.resultText;
      matchCompleted = data.matchCompleted || false;
      matchStarted = true;
      
      // Restore tournament name and match type to input fields (for display purposes)
      if (data.tournamentName && document.getElementById('tournamentName')) {
        document.getElementById('tournamentName').value = data.tournamentName;
      }
      if (data.matchType && document.getElementById('matchType')) {
        document.getElementById('matchType').value = data.matchType;
      }
      
      // If loading from URL, show game screen
      if (document.getElementById('setup').style.display !== 'none') {
        document.getElementById('setup').style.display = 'none';
        document.getElementById('game').style.display = 'block';
      }
      
      // Update edit mode UI (enable/disable buttons based on permission)
      updateEditModeUI();
      
      // Use the regular updateUI function - it has all the proper display logic
      updateUI();
      
      // Clear the flag after UI update
      isLoadingFromFirebase = false;
    }, (error) => {
      // Handle connection errors (e.g., connection limit reached)
      console.error("❌ Firebase connection error:", error);
      
      if (error.code === 'PERMISSION_DENIED' || error.message.includes('connection') || error.message.includes('limit')) {
        // Show user-friendly error message
        const gameDiv = document.getElementById('game');
        const setupDiv = document.getElementById('setup');
        
        const errorHTML = `
          <div style="max-width:520px;margin:40px auto;padding:32px;background:#ffffff;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.15);text-align:center;">
            <div style="font-size:64px;margin-bottom:16px;">⚠️</div>
            <h2 style="color:#ef4444;font-size:24px;margin:0 0 12px;font-weight:800;">Connection Limit Reached</h2>
            <p style="color:#6b7280;font-size:15px;line-height:1.6;margin:0 0 20px;">
              Too many people are watching this match right now! 🏏<br>
              Firebase free tier allows 100 simultaneous connections.
            </p>
            <p style="color:#6b7280;font-size:14px;line-height:1.6;margin:0 0 24px;">
              Please wait a few minutes and try again.<br>
              Some viewers may disconnect soon.
            </p>
            <button onclick="location.reload()" style="background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);color:#ffffff;border:none;padding:14px 32px;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(59,130,246,0.3);">
              🔄 Try Again
            </button>
            <div style="margin-top:20px;padding:12px;background:#f3f4f6;border-radius:8px;">
              <p style="font-size:12px;color:#6b7280;margin:0;">
                <strong>Note:</strong> Match data is still being recorded.<br>
                Only viewing is temporarily limited.
              </p>
            </div>
          </div>
        `;
        
        if (gameDiv) gameDiv.innerHTML = errorHTML;
        if (setupDiv) setupDiv.innerHTML = errorHTML;
        
        alert('⚠️ Connection Limit Reached!\n\nToo many viewers watching right now.\n\nPlease try again in a few minutes.');
      } else {
        // Other errors
        console.error("Error details:", error);
        alert('⚠️ Connection Error\n\n' + error.message + '\n\nPlease check your internet connection and try again.');
      }
    });
  };
  
  // Start listening at the primary path
  setupListener(primaryPath);
}

function updateUIFromFirebase() {
  // Similar to updateUI but without saving back to Firebase
  const inn = inSecond ? second : first;
  
  // Update score (runs/wickets format)
  document.getElementById("score").textContent = `${inn.runs}/${inn.wkts}`;
  
  // Update status (team name)
  const batting = inSecond ? teamB : teamA;
  const bowling = inSecond ? teamA : teamB;
  document.getElementById("status").textContent = batting;
  
  // Handle bowling team display and first innings score visibility
  const bowlingTeamDisplay = document.getElementById("bowlingTeamDisplay");
  const firstInningsScoreElem = document.getElementById("firstInningsScore");
  
  if (inSecond) {
    // In second innings, hide bowling team display as first innings score shows the context
    bowlingTeamDisplay.style.display = 'none';
    if (firstInningsScoreElem) {
      const firstOvers = Math.floor(first.legalBalls/6);
      const firstBalls = first.legalBalls % 6;
      firstInningsScoreElem.textContent = `${teamA}: ${first.runs}/${first.wkts} (${firstOvers}.${firstBalls})`;
      firstInningsScoreElem.style.display = 'block';
    }
  } else {
    // In first innings, show bowling team display
    bowlingTeamDisplay.textContent = `vs ${bowling}`;
    bowlingTeamDisplay.style.display = 'block';
    if (firstInningsScoreElem) {
      firstInningsScoreElem.style.display = 'none';
    }
  }
  
  // Overs and Run Rate
  const overs = Math.floor(inn.legalBalls/6);
  const ballsInOver = inn.legalBalls % 6;
  
  let balls = inn.legalBalls;
  let rr = balls > 0 ? (inn.runs * 6 / balls).toFixed(2) : '0.00';
  
  // Calculate extras
  let extras = 0;
  function countOverSymbols(arr) {
    let sum = 0;
    if (!arr || !Array.isArray(arr)) return sum;
    arr.forEach(sym => {
      if (typeof sym === 'string') {
        if (/^WD\+([0-9]+)\+W$/.test(sym)) { sum += 1 + parseInt(sym.match(/^WD\+([0-9]+)\+W$/)[1]); }
        else if (/^NB\+([0-9]+)\+W$/.test(sym)) { sum += 1 + parseInt(sym.match(/^NB\+([0-9]+)\+W$/)[1]); }
        else if (/^B\+W$/.test(sym)) { sum += 1; }
        else if (/^LB\+W$/.test(sym)) { sum += 1; }
        else if (/^WD\+W$/.test(sym)) { sum += 1; }
        else if (/^WD\+([0-9]+)$/.test(sym)) { sum += 1 + parseInt(sym.match(/^WD\+([0-9]+)$/)[1]); }
        else if (/^NB\+([0-9]+)$/.test(sym)) { sum += 1 + parseInt(sym.match(/^NB\+([0-9]+)$/)[1]); }
        else if (sym === 'WD') { sum += 1; }
        else if (sym === 'NB') { sum += 1; }
        else if (/^B$/.test(sym)) { sum += 1; }
        else if (/^LB$/.test(sym)) { sum += 1; }
      }
    });
    return sum;
  }
  if (inn.overs && Array.isArray(inn.overs)) {
    inn.overs.forEach(over => { extras += countOverSymbols(over); });
  }
  if (inn.curOver && Array.isArray(inn.curOver)) {
    extras += countOverSymbols(inn.curOver);
  }
  
  // Display consolidated Overs/RR/Extras
  document.getElementById("oversExtrasInfo").innerHTML = `Overs: <b>(${overs}.${ballsInOver}/${oversLimit})</b> | RR: <b>${rr}</b> | Extras: <b>${extras}</b>`;
  
  // Update live over display
  updateLiveOverDisplay(inn);
  
  // Update first innings info if in second innings
  if (inSecond) {
    const firstOvers = Math.floor(first.legalBalls/6);
    const firstBallsInOver = first.legalBalls % 6;
    const need = target - second.runs;
    const ballsLeft = (target > 0) ? (first.legalBalls - second.legalBalls) : 0;
    const reqRR = (ballsLeft > 0 && need > 0) ? ((need * 6) / ballsLeft).toFixed(2) : '0.00';
    
    const firstInfoDiv = document.getElementById("firstInningsInfo");
    if (target > 0) {
      firstInfoDiv.innerHTML = `${teamA}: <b>${first.runs}</b> (${firstOvers}.${firstBallsInOver}) | Need: <b>${need}</b> in <b>${ballsLeft}</b> balls | RRR: <b>${reqRR}</b>`;
      firstInfoDiv.style.display = 'block';
    }
  }
  
  // Update result
  const resultDiv = document.getElementById("result");
  if (resultText) {
    resultDiv.textContent = resultText;
    resultDiv.style.display = 'block';
  } else {
    resultDiv.style.display = 'none';
  }
  
  // Update localStorage session (important for removing completed matches from saved list)
  saveCurrentMatchSession();
}

function updateLiveOverDisplay(inn) {
  const liveOverDiv = document.getElementById("liveOverDisplay");
  
  // Show current over if it has balls, or last completed over if current is empty
  if (inn.curOver && inn.curOver.length > 0) {
    // Current over in progress
    const ballsChips = inn.curOver.map(sym => {
      const isWicket = /W$/.test(sym) || /\+W$/.test(sym);
      const bgColor = isWicket ? '#e31d1d' : '#3b82f6';
      const borderColor = isWicket ? '#b91c1c' : '#2563eb';
      return `<span style="display:inline-block;margin:1px 2px;padding:4px 8px;border-radius:999px;background:${bgColor};color:#fff;font-weight:600;border:1px solid ${borderColor};font-size:13px;">${sym}</span>`;
    }).join('');
    
    // Calculate runs/wickets for this over
    let runs = 0, wkts = 0;
    inn.curOver.forEach(sym => {
      if (typeof sym === 'string') {
        if (/^([0-9]+)\+W$/.test(sym)) { runs += parseInt(sym); wkts += 1; }
        else if (/^W$/.test(sym)) { wkts += 1; }
        else if (/^WD\+([0-9]+)\+W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^WD\+([0-9]+)\+W$/)[1]); wkts += 1; }
        else if (/^WD\+W$/.test(sym)) { runs += 1; wkts += 1; }
        else if (/^NB\+([0-9]+)\+W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^NB\+([0-9]+)\+W$/)[1]); wkts += 1; }
        else if (/^NB\+W$/.test(sym)) { runs += 1; wkts += 1; }
        else if (/^B\+([0-9]+)\+W$/.test(sym)) { runs += parseInt(sym.match(/^B\+([0-9]+)\+W$/)[1]); wkts += 1; }
        else if (/^B\+W$/.test(sym)) { runs += 0; wkts += 1; }
        else if (/^([0-9]+)W$/.test(sym)) { runs += parseInt(sym); wkts += 1; }
        else if (/^WD\+([0-9]+)W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^WD\+([0-9]+)W$/)[1]); wkts += 1; }
        else if (/^WDW$/.test(sym)) { runs += 1; wkts += 1; }
        else if (/^NB\+([0-9]+)W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^NB\+([0-9]+)W$/)[1]); wkts += 1; }
        else if (/^NBW$/.test(sym)) { runs += 1; wkts += 1; }
        else if (/^B\+([0-9]+)W$/.test(sym)) { runs += parseInt(sym.match(/^B\+([0-9]+)W$/)[1]); wkts += 1; }
        else if (/^BW$/.test(sym)) { runs += 0; wkts += 1; }
        else if (/^[0-9]$/.test(sym)) runs += parseInt(sym);
        else if (/^NB$/.test(sym) || /^WD$/.test(sym)) runs += 1;
        else if (/^NB\+([0-9]+)$/.test(sym)) runs += 1 + parseInt(sym.match(/^NB\+([0-9]+)$/)[1]);
        else if (/^WD\+([0-9]+)$/.test(sym)) runs += 1 + parseInt(sym.match(/^WD\+([0-9]+)$/)[1]);
        else if (/^B\+([0-9]+)$/.test(sym)) runs += parseInt(sym.match(/^B\+([0-9]+)$/)[1]);
        else if (/^LB\+([0-9]+)$/.test(sym)) runs += parseInt(sym.match(/^LB\+([0-9]+)$/)[1]);
      }
    });
    
    liveOverDiv.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="color:#1f2937;font-weight:700;font-size:14px;">${ballsChips}</div>
      <div style="color:#1f2937;font-weight:700;font-size:14px;">${runs}/${wkts}</div>
    </div>`;
    liveOverDiv.style.display = 'block';
  } else if (inn.overs && inn.overs.length > 0) {
    // Show last completed over
    const lastOver = inn.overs[inn.overs.length - 1];
    const ballsChips = lastOver.map(sym => {
      const isWicket = /W$/.test(sym) || /\+W$/.test(sym);
      const bgColor = isWicket ? '#e31d1d' : '#10b981';
      const borderColor = isWicket ? '#b91c1c' : '#059669';
      return `<span style="display:inline-block;margin:1px 2px;padding:4px 8px;border-radius:999px;background:${bgColor};color:#fff;font-weight:600;border:1px solid ${borderColor};font-size:13px;">${sym}</span>`;
    }).join('');
    
    // Calculate runs/wickets for last over
    let runs = 0, wkts = 0;
    lastOver.forEach(sym => {
      if (typeof sym === 'string') {
        if (/^([0-9]+)\+W$/.test(sym)) { runs += parseInt(sym); wkts += 1; }
        else if (/^W$/.test(sym)) { wkts += 1; }
        else if (/^WD\+([0-9]+)\+W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^WD\+([0-9]+)\+W$/)[1]); wkts += 1; }
        else if (/^WD\+W$/.test(sym)) { runs += 1; wkts += 1; }
        else if (/^NB\+([0-9]+)\+W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^NB\+([0-9]+)\+W$/)[1]); wkts += 1; }
        else if (/^NB\+W$/.test(sym)) { runs += 1; wkts += 1; }
        else if (/^B\+([0-9]+)\+W$/.test(sym)) { runs += parseInt(sym.match(/^B\+([0-9]+)\+W$/)[1]); wkts += 1; }
        else if (/^B\+W$/.test(sym)) { runs += 0; wkts += 1; }
        else if (/^([0-9]+)W$/.test(sym)) { runs += parseInt(sym); wkts += 1; }
        else if (/^WD\+([0-9]+)W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^WD\+([0-9]+)W$/)[1]); wkts += 1; }
        else if (/^WDW$/.test(sym)) { runs += 1; wkts += 1; }
        else if (/^NB\+([0-9]+)W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^NB\+([0-9]+)W$/)[1]); wkts += 1; }
        else if (/^NBW$/.test(sym)) { runs += 1; wkts += 1; }
        else if (/^B\+([0-9]+)W$/.test(sym)) { runs += parseInt(sym.match(/^B\+([0-9]+)W$/)[1]); wkts += 1; }
        else if (/^BW$/.test(sym)) { runs += 0; wkts += 1; }
        else if (/^[0-9]$/.test(sym)) runs += parseInt(sym);
        else if (/^NB$/.test(sym) || /^WD$/.test(sym)) runs += 1;
        else if (/^NB\+([0-9]+)$/.test(sym)) runs += 1 + parseInt(sym.match(/^NB\+([0-9]+)$/)[1]);
        else if (/^WD\+([0-9]+)$/.test(sym)) runs += 1 + parseInt(sym.match(/^WD\+([0-9]+)$/)[1]);
        else if (/^B\+([0-9]+)$/.test(sym)) runs += parseInt(sym.match(/^B\+([0-9]+)$/)[1]);
        else if (/^LB\+([0-9]+)$/.test(sym)) runs += parseInt(sym.match(/^LB\+([0-9]+)$/)[1]);
      }
    });
    
    liveOverDiv.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="color:#1f2937;font-weight:700;font-size:14px;">${ballsChips}</div>
      <div style="color:#1f2937;font-weight:700;font-size:14px;">${runs}/${wkts}</div>
    </div>`;
    liveOverDiv.style.display = 'block';
  } else {
    liveOverDiv.innerHTML = '<div style="color:#94a3b8;font-size:13px;">No balls bowled yet</div>';
    liveOverDiv.style.display = 'block';
  }
}

function getViewerLink() {
  const pathParts = window.location.pathname.split('/');
  pathParts.pop(); // Remove the current file (scorer.html)
  const basePath = pathParts.join('/');
  const baseUrl = window.location.origin + basePath + '/';
  return `${baseUrl}livescore.html?org=${organizationId}&match=${matchId}`;
}

function getScorerLink() {
  const pathParts = window.location.pathname.split('/');
  pathParts.pop(); // Remove the current file (scorer.html)
  const basePath = pathParts.join('/');
  const baseUrl = window.location.origin + basePath + '/';
  return `${baseUrl}scorer.html?org=${organizationId}&match=${matchId}&edit=${editToken}`;
}

function getTournamentLink() {
  const pathParts = window.location.pathname.split('/');
  pathParts.pop(); // Remove the current file (scorer.html)
  const basePath = pathParts.join('/');
  const baseUrl = window.location.origin + basePath + '/';
  return `${baseUrl}livescore.html?org=${organizationId}`;
}

function shareViewerLink() {
  if (!firebaseEnabled) {
    alert('⚠️ Firebase not configured!\n\nPlease add your Firebase configuration to enable live sync and viewer mode.');
    return;
  }
  
  const link = getViewerLink();
  const tournamentName = document.getElementById('tournamentName')?.value || 'Cricket Match';
  const matchType = document.getElementById('matchType')?.value || '';
  const badgeName = matchType ? `${tournamentName} - ${matchType}` : tournamentName;
  
  // WhatsApp-specific message
  const whatsappMessage = `🏏 *${teamA} vs ${teamB}* - LIVE MATCH! 🔥\n\n🏆 *${badgeName}*\n\n📊 Follow live score, ball-by-ball updates & real-time stats!\n\n👉 Tap here for LIVE scorecard:\n${link}\n\n⚡ Powered by CricketBook`;
  const whatsappLink = `https://wa.me/?text=${encodeURIComponent(whatsappMessage)}`;
  
  const shareTitle = `${teamA} vs ${teamB} - Live Score`;
  const shareMessage = `🏏 ${teamA} vs ${teamB} - LIVE\n\n📊 Real-time Scorecard\n${link}\n\n⚡ Powered by CricketBook`;
  
  // Check if Web Share API is available (mobile devices)
  if (navigator.share) {
    navigator.share({
      title: shareTitle,
      text: whatsappMessage
    }).then(() => {
      console.log('Share successful');
    }).catch((error) => {
      // If user cancels share, fallback to WhatsApp modal
      if (error.name !== 'AbortError') {
        showShareModalWithWhatsApp(link, shareMessage, whatsappLink);
      }
    });
  } else {
    // Fallback: Show a custom modal with WhatsApp option
    showShareModalWithWhatsApp(link, shareMessage, whatsappLink);
  }
}

function shareScorerLink() {
  if (!firebaseEnabled) {
    alert('⚠️ Firebase not configured!\n\nPlease add your Firebase configuration to enable live sync and viewer mode.');
    return;
  }
  
  if (!editToken) {
    alert('⚠️ No edit token available!\n\nPlease start a match first to generate a scorer link.');
    return;
  }
  
  const link = getScorerLink();
  const shareTitle = `${teamA} vs ${teamB} - Scorer Access`;
  const shareMessage = `⚡ ${teamA} vs ${teamB}\n✏️ Scorer Link (Keep Private!): ${link}`;
  
  // Always show a warning about keeping this link private
  const confirmation = confirm(`🔐 SCORER LINK - KEEP PRIVATE!\n\nThis link allows EDITING the match score.\nOnly share with trusted co-scorers.\n\nShare viewer link for spectators instead.\n\nContinue to copy scorer link?`);
  
  if (!confirmation) return;
  
  // Check if Web Share API is available (mobile devices)
  if (navigator.share) {
    navigator.share({
      title: shareTitle,
      text: `✏️ ${teamA} vs ${teamB} - Scorer access (private)`,
      url: link
    }).then(() => {
      console.log('Scorer link share successful');
    }).catch((error) => {
      // If user cancels share, fallback to copy
      if (error.name !== 'AbortError') {
        copyLinkFallback(shareMessage, link);
      }
    });
  } else {
    // Fallback: Copy to clipboard with warning
    if (navigator.clipboard) {
      navigator.clipboard.writeText(link).then(() => {
        alert('✏️ Scorer link copied!\n\n⚠️ Keep this private - only share with trusted scorers.\n\n' + link);
      }).catch(() => {
        showShareModal(link, shareMessage);
      });
    } else {
      showShareModal(link, shareMessage);
    }
  }
}

function shareTournamentLink() {
  if (!firebaseEnabled) {
    alert('⚠️ Firebase not configured!\n\nPlease add your Firebase configuration to enable live sync and viewer mode.');
    return;
  }
  
  const link = getTournamentLink();
  const tournamentName = document.getElementById('tournamentName')?.value || 'Tournament';
  const shareTitle = `${tournamentName} - All Matches`;
  const shareMessage = `🏆 *${tournamentName}* - Live Tournament\n\n📋 View all matches, schedules & live scores\n\n👉 Tournament Dashboard:\n${link}\n\n⚡ Powered by CricketBook`;
  
  // Check if Web Share API is available (mobile devices)
  if (navigator.share) {
    navigator.share({
      title: shareTitle,
      text: shareMessage
    }).then(() => {
      console.log('Tournament share successful');
    }).catch((error) => {
      // If user cancels share, fallback to copy
      if (error.name !== 'AbortError') {
        copyLinkFallback(shareMessage, link);
      }
    });
  } else {
    // Fallback: Show a custom modal with clickable link
    showShareModal(link, shareMessage);
  }
}

function copyLinkFallback(shareMessage, link) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(link).then(() => {
      alert('🔗 Link copied to clipboard!\n\n' + shareMessage);
    }).catch(() => {
      showShareModal(link, shareMessage);
    });
  } else {
    showShareModal(link, shareMessage);
  }
}

function showShareModal(link, shareMessage) {
  // Create modal overlay
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 20px;
  `;
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: white;
    border-radius: 20px;
    padding: 24px;
    max-width: 500px;
    width: 100%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  `;
  
  modalContent.innerHTML = `
    <div style="text-align: center; margin-bottom: 20px;">
      <div style="font-size: 24px; margin-bottom: 8px;">🔗</div>
      <div style="font-size: 18px; font-weight: 700; color: #1f2937; margin-bottom: 4px;">Viewer Link</div>
      <div style="font-size: 14px; color: #6b7280;">${teamA} vs ${teamB}</div>
    </div>
    
    <div style="background: #f3f4f6; padding: 16px; border-radius: 12px; margin-bottom: 16px; word-break: break-all;">
      <a href="${link}" target="_blank" style="color: #3b82f6; text-decoration: none; font-size: 14px; font-weight: 600;">
        ${link}
      </a>
    </div>
    
    <div style="display: grid; gap: 10px;">
      <button onclick="copyToClipboard('${link}')" style="width: 100%; padding: 14px; background: #8b5cf6; color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
        � Copy Link
      </button>
      <button onclick="window.open('${link}', '_blank')" style="width: 100%; padding: 14px; background: #3b82f6; color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
        👁️ Open Viewer
      </button>
      <button onclick="closeShareModal()" style="width: 100%; padding: 14px; background: #e5e7eb; color: #374151; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
        Close
      </button>
    </div>
  `;
  
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
  
  // Store modal reference
  window.currentShareModal = modal;
  
  // Close on overlay click
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeShareModal();
    }
  });
}

function closeShareModal() {
  if (window.currentShareModal) {
    window.currentShareModal.remove();
    window.currentShareModal = null;
  }
}

function showShareModalWithWhatsApp(link, shareMessage, whatsappLink) {
  // Create modal overlay
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 20px;
  `;
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: white;
    border-radius: 20px;
    padding: 24px;
    max-width: 500px;
    width: 100%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  `;
  
  modalContent.innerHTML = `
    <div style="text-align: center; margin-bottom: 20px;">
      <div style="font-size: 24px; margin-bottom: 8px;">🔗</div>
      <div style="font-size: 18px; font-weight: 700; color: #1f2937; margin-bottom: 4px;">Share Viewer Link</div>
      <div style="font-size: 14px; color: #6b7280;">${teamA} vs ${teamB}</div>
    </div>
    
    <div style="background: #f3f4f6; padding: 16px; border-radius: 12px; margin-bottom: 16px; word-break: break-all;">
      <a href="${link}" target="_blank" style="color: #3b82f6; text-decoration: none; font-size: 14px; font-weight: 600;">
        ${link}
      </a>
    </div>
    
    <div style="display: grid; gap: 10px;">
      <button onclick="window.open('${whatsappLink}', '_blank')" style="width: 100%; padding: 14px; background: #25D366; color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
        📱 Share on WhatsApp
      </button>
      <button onclick="copyToClipboard('${link}')" style="width: 100%; padding: 14px; background: #8b5cf6; color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
        📋 Copy Link
      </button>
      <button onclick="window.open('${link}', '_blank')" style="width: 100%; padding: 14px; background: #3b82f6; color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
        👁️ Open Viewer
      </button>
      <button onclick="closeShareModal()" style="width: 100%; padding: 14px; background: #e5e7eb; color: #374151; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
        Close
      </button>
    </div>
  `;
  
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
  
  // Store modal reference
  window.currentShareModal = modal;
  
  // Close on overlay click
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeShareModal();
    }
  });
}

function copyToClipboard(text) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => {
      // Show success feedback
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = '✅ Copied!';
      button.style.background = '#10b981';
      setTimeout(() => {
        button.innerHTML = originalText;
        button.style.background = '#8b5cf6';
      }, 2000);
    }).catch(() => {
      alert('❌ Could not copy. Please copy manually:\n\n' + text);
    });
  } else {
    // Fallback for older browsers
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    try {
      document.execCommand('copy');
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = '✅ Copied!';
      button.style.background = '#10b981';
      setTimeout(() => {
        button.innerHTML = originalText;
        button.style.background = '#8b5cf6';
      }, 2000);
    } catch (err) {
      alert('❌ Could not copy. Please copy manually:\n\n' + text);
    }
    document.body.removeChild(textarea);
  }
}

/* ---------------- Core Recording ---------------- */
function checkCanEdit(action = "make changes") {
  if (!canEditMatch) {
    alert(`🔒 You don't have permission to ${action}.\n\nTo edit this match, ask the scorer for the editor link.`);
    return false;
  }
  return true;
}

function pushUndo() {
  // Save a deep copy of all relevant state
  undoStack.push({
    first: JSON.parse(JSON.stringify(first)),
    second: JSON.parse(JSON.stringify(second)),
    inSecond,
    resultText,
    matchCompleted,
    pendingExtra: pendingExtra ? JSON.parse(JSON.stringify(pendingExtra)) : null
  });
  // Limit stack size if needed
  if (undoStack.length > 100) undoStack.shift();
}

function undoLastAction() {
  if (!checkCanEdit("undo")) return;
  if (undoStack.length === 0) return;
  const prev = undoStack.pop();
  first = JSON.parse(JSON.stringify(prev.first));
  second = JSON.parse(JSON.stringify(prev.second));
  inSecond = prev.inSecond;
  resultText = prev.resultText;
  matchCompleted = prev.matchCompleted;
  pendingExtra = prev.pendingExtra;
  updateUI();
}

function commitLegalBall(inn){
  inn.legalBalls++;
  inn.curOverLegal++;
  if (inn.curOverLegal === 6){
    // over finished: move current over to completed and reset
    inn.overs.push(inn.curOver.slice());
    inn.curOver = [];
    inn.curOverLegal = 0;
  }
  // End of innings by overs
  if (inn.legalBalls >= oversLimit*6) {
    inn.done = true;
    switchInnings();
  }
}

function addSymbol(inn, symbol){
  // Push symbol to current over only (completed overs stay intact)
  inn.curOver.push(symbol);
}

function addLegalRun(r){
  if (!checkCanEdit("add runs")) return;
  const inn = currentInnings();
  if (inn.done || pendingExtra || currentMatchOver()) return;
  pushUndo();
  inn.runs += r;
  addSymbol(inn, String(r));
  commitLegalBall(inn);
  if(inSecond) checkResult();
  updateUI();
}

function wicket(){
  if (!checkCanEdit("record wicket")) return;
  const inn = currentInnings();
  if (inn.done || pendingExtra || currentMatchOver()) return;
  // Reset wicket panel to default state every time it opens
  const deliverySel = document.getElementById('wicketDelivery');
  const runsInput = document.getElementById('wicketRuns');
  const dontCountChk = document.getElementById('wicketNoBallCount');
  deliverySel.value = 'legal';
  runsInput.value = 0;
  dontCountChk.checked = false;
  // Set checkbox if NB or WD is selected
  deliverySel.onchange = function() {
    if (deliverySel.value === 'NB' || deliverySel.value === 'WD') {
      dontCountChk.checked = true;
    } else {
      dontCountChk.checked = false;
    }
  };
  document.getElementById('wicketPanel').style.display = 'block';
  // Disable main buttons
  [...document.querySelectorAll(".btn-run, .btn-wkt, .btn-extra")].forEach(b=> b.disabled = true);
}

function confirmWicketExtra() {
  const inn = currentInnings();
  pushUndo();
  const delivery = document.getElementById('wicketDelivery').value;
  const runs = parseInt(document.getElementById('wicketRuns').value) || 0;
  const dontCount = document.getElementById('wicketNoBallCount').checked;
  let symbol = '';
  if (delivery === 'legal') {
    symbol = runs > 0 ? `${runs}+W` : 'W';
  } else if (delivery === 'WD') {
    symbol = runs > 0 ? `WD+${runs}+W` : 'WD+W';
    inn.runs += 1 + runs;
  } else if (delivery === 'NB') {
    symbol = runs > 0 ? `NB+${runs}+W` : 'NB+W';
    inn.runs += 1 + runs;
  } else if (delivery === 'BYE') {
    symbol = runs > 0 ? `B+${runs}+W` : 'B+W';
    inn.runs += runs;
  }
  if (delivery === 'legal') {
    inn.runs += runs;
  }
  inn.wkts++;
  addSymbol(inn, symbol);
  if (!dontCount) {
    commitLegalBall(inn);
  }
  if (inn.wkts >= wicketsLimit){
    inn.done = true;
    switchInnings();
  }
  if(inSecond) checkResult();
  document.getElementById('wicketPanel').style.display = 'none';
  // Re-enable all buttons
  [...document.querySelectorAll('.btn-run, .btn-wkt, .btn-extra, .btn-muted')].forEach(b=> b.disabled = false);
  updateUI();
}
function cancelWicketExtra() {
  document.getElementById('wicketPanel').style.display = 'none';
  // Re-enable all buttons
  [...document.querySelectorAll('.btn-run, .btn-wkt, .btn-extra, .btn-muted')].forEach(b=> b.disabled = false);
  updateUI();
}

/* ---------------- Extras ---------------- */

function startExtra(type){
  if (!checkCanEdit("add extras")) return;
  const inn = currentInnings();
  if (inn.done || currentMatchOver()) return;
  
  // If clicking same button again, cancel
  if (pendingExtra && pendingExtra.type === type) {
    cancelExtra();
    return;
  }
  
  // If different extra type already pending, cancel previous one first
  if (pendingExtra) {
    cancelExtra();
  }
  
  pushUndo();
  if (type === 'NB' || type === 'WD'){
    // Base 1 extra run, NOT a legal ball
    inn.runs += 1;
    addSymbol(inn, type);    // will replace with NB+X/WD+X after selection
    
    // Check if match is won with just this 1 run (second innings only)
    if (inSecond && inn.runs >= first.runs + 1) {
      pendingExtra = null;
      checkResult();
      updateUI();
      return;
    }
    
    pendingExtra = {type};
    const label = type === 'WD' ? 'WD: Select overthrow runs' : 'NB: Select runs off bat';
    showExtraPanel(true, label);
  } else {
    // Byes/Leg byes: choose runs; counts as legal ball
    // Check if only 1 run is needed to win (second innings only)
    if (inSecond && (first.runs + 1 - inn.runs) === 1) {
      // Add 1 run and end the match
      inn.runs += 1;
      addSymbol(inn, `${type}+1`);
      commitLegalBall(inn);
      checkResult();
      updateUI();
      return;
    }
    
    pendingExtra = {type};
    showExtraPanel(true, `${type}: Select runs`);
  }
  if(inSecond) checkResult();
  updateUI();
}


function applyExtra(runs){
  const inn = currentInnings();
  if (!pendingExtra || currentMatchOver()) return;
  pushUndo();
  if (pendingExtra.type === 'NB' || pendingExtra.type === 'WD'){
    // Add bat runs; still NOT a legal ball
    inn.runs += runs;
    // Replace last symbol (NB -> NB+X)
    inn.curOver[inn.curOver.length-1] = `${pendingExtra.type}+${runs}`;
    // stays same over; no legal ball added
  } else {
    // B / LB: add runs and count as LEGAL ball
    inn.runs += runs;
    addSymbol(inn, `${pendingExtra.type}+${runs}`);
    commitLegalBall(inn);
  }

  pendingExtra = null;
  showExtraPanel(false);
  if(inSecond) checkResult();
  updateUI();
}


function cancelExtra(){
  const inn = currentInnings();
  if (!pendingExtra) return;
  pushUndo();
  if (pendingExtra.type === 'NB' || pendingExtra.type === 'WD'){
    // We had already added base 1 and a symbol; roll both back
    inn.runs -= 1;
    inn.curOver.pop();
  }
  pendingExtra = null;
  showExtraPanel(false);
  updateUI();
}

/* ---------------- Tournament Password System ---------------- */
// Toggle password visibility
function togglePasswordVisibility() {
  const passwordInput = document.getElementById('tournamentPassword');
  const currentType = passwordInput.getAttribute('type');
  passwordInput.setAttribute('type', currentType === 'password' ? 'text' : 'password');
}

// Check password strength
function checkPasswordStrength() {
  const password = document.getElementById('tournamentPassword').value;
  const strengthDiv = document.getElementById('passwordStrength');
  
  if (!password) {
    strengthDiv.style.display = 'none';
    return;
  }
  
  let strength = 0;
  let message = '';
  let color = '';
  
  if (password.length >= 6) strength++;
  if (password.length >= 10) strength++;
  if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
  if (/[0-9]/.test(password)) strength++;
  if (/[^a-zA-Z0-9]/.test(password)) strength++;
  
  if (strength <= 1) {
    message = '⚠️ Weak password';
    color = '#ef4444';
  } else if (strength <= 3) {
    message = '✓ Medium password';
    color = '#f59e0b';
  } else {
    message = '✓ Strong password';
    color = '#10b981';
  }
  
  strengthDiv.innerHTML = `<span style="color:${color};font-weight:600;">${message}</span>`;
  strengthDiv.style.display = 'block';
}

// Check if tournament exists in Firebase
let checkTournamentTimeout = null;
async function checkTournamentExists() {
  const tournamentName = document.getElementById('tournamentName').value.trim();
  const statusDiv = document.getElementById('tournamentStatus');
  const passwordHelpText = document.getElementById('passwordHelpText');
  const passwordSection = document.getElementById('passwordSection');
  
  // Clear previous timeout
  if (checkTournamentTimeout) {
    clearTimeout(checkTournamentTimeout);
  }
  
  if (!tournamentName) {
    statusDiv.style.display = 'none';
    passwordHelpText.textContent = 'Required for named tournaments. Protects your tournament and allows team collaboration. Leave both name and password blank for quick matches.';
    passwordSection.style.borderColor = '#e2e8f0';
    passwordSection.style.background = '#f8fafc';
    return;
  }
  
  // Debounce the check
  checkTournamentTimeout = setTimeout(async () => {
    if (!firebaseEnabled || !db) {
      statusDiv.style.display = 'none';
      return;
    }
    
    const orgId = generateOrganizationId(tournamentName);
    
    try {
      const snapshot = await db.ref('organizations/' + orgId).once('value');
      const exists = snapshot.exists();
      
      if (exists) {
        statusDiv.innerHTML = '<div style="padding:8px 12px;background:#fef3c7;border:1px solid #fbbf24;border-radius:8px;color:#92400e;font-size:12px;font-weight:600;">⚠️ Tournament exists! Enter password to add matches or choose a different name.</div>';
        statusDiv.style.display = 'block';
        passwordHelpText.textContent = 'Enter the correct password to add matches to this existing tournament.';
        passwordSection.style.borderColor = '#fbbf24';
        passwordSection.style.background = '#fef3c7';
      } else {
        statusDiv.innerHTML = '<div style="padding:8px 12px;background:#d1fae5;border:1px solid #10b981;border-radius:8px;color:#065f46;font-size:12px;font-weight:600;">✓ New tournament - set a password to get started!</div>';
        statusDiv.style.display = 'block';
        passwordHelpText.textContent = 'Set a password to protect your tournament. Share it with your team to allow them to add matches.';
        passwordSection.style.borderColor = '#10b981';
        passwordSection.style.background = '#f0fdf4';
      }
    } catch (error) {
      console.error('Error checking tournament:', error);
      statusDiv.style.display = 'none';
    }
  }, 500); // Wait 500ms after user stops typing
}

/* Switch team names */
function switchTeamNames() {
  const teamAInput = document.getElementById("teamA");
  const teamBInput = document.getElementById("teamB");
  
  // Swap the values
  const tempValue = teamAInput.value;
  teamAInput.value = teamBInput.value;
  teamBInput.value = tempValue;
  
  // Visual feedback - briefly highlight the fields
  teamAInput.style.borderColor = '#8b5cf6';
  teamBInput.style.borderColor = '#8b5cf6';
  teamAInput.style.boxShadow = '0 0 0 3px rgba(139,92,246,0.15)';
  teamBInput.style.boxShadow = '0 0 0 3px rgba(139,92,246,0.15)';
  
  setTimeout(() => {
    teamAInput.style.borderColor = '#e2e8f0';
    teamBInput.style.borderColor = '#e2e8f0';
    teamAInput.style.boxShadow = 'none';
    teamBInput.style.boxShadow = 'none';
  }, 500);
}

/* Toggle Tournament Section */
function toggleTournamentSection() {
  const section = document.getElementById('tournamentSection');
  const icon = document.getElementById('tournamentToggleIcon');
  const btn = document.getElementById('tournamentToggleBtn');
  
  if (section.style.display === 'none') {
    section.style.display = 'block';
    icon.textContent = '▲';
    btn.style.background = '#e0e7ff';
    btn.style.borderColor = '#6366f1';
  } else {
    section.style.display = 'none';
    icon.textContent = '▼';
    btn.style.background = '#f8fafc';
    btn.style.borderColor = '#e2e8f0';
  }
}

/* Handle Match Type Change */
function handleMatchTypeChange() {
  const matchTypeSelect = document.getElementById('matchType');
  const customInput = document.getElementById('customMatchType');
  
  if (matchTypeSelect.value === 'Custom') {
    customInput.style.display = 'block';
    customInput.focus();
  } else {
    customInput.style.display = 'none';
    customInput.value = '';
  }
}

/* ---------------- Flow ---------------- */
async function startMatch(){
  const tournamentName = document.getElementById("tournamentName").value.trim();
  const tournamentPassword = document.getElementById("tournamentPassword").value;
  const matchTypeSelect = document.getElementById("matchType");
  const customMatchType = document.getElementById("customMatchType").value.trim();
  
  // Determine actual match type
  let matchType;
  if (matchTypeSelect.value === 'Custom') {
    if (!customMatchType) {
      alert('⚠️ Please enter a custom match type or select from the dropdown.');
      document.getElementById('customMatchType').focus();
      return;
    }
    matchType = customMatchType;
  } else {
    matchType = matchTypeSelect.value;
  }
  
  teamA = document.getElementById("teamA").value || "Team A";
  teamB = document.getElementById("teamB").value || "Team B";
  oversLimit = Math.max(1, parseInt(document.getElementById("overs").value || "4"));
  wicketsLimit = Math.max(1, Math.min(20, parseInt(document.getElementById("wicketsLimit").value || "10")));
  
  // Validate password only if tournament name is provided
  if (tournamentName && tournamentName !== '') {
    // Named tournament - password is REQUIRED
    if (!tournamentPassword) {
      alert('⚠️ Please enter a tournament password.\n\nPassword is required for named tournaments to:\n• Protect your tournament\n• Allow team members to add matches\n• Prevent unauthorized access\n\nTip: Leave tournament name blank for quick matches without password.');
      return;
    }
    
    if (tournamentPassword.length < 4) {
      alert('⚠️ Password must be at least 4 characters long.\n\nPlease choose a stronger password.');
      return;
    }
  } else {
    // Quick match without tournament name - password is OPTIONAL
    console.log('🏏 Quick match mode - tournament name blank, password optional');
  }
  
  // Generate organization ID based on tournament name
  if (tournamentName && tournamentName !== '') {
    organizationId = generateOrganizationId(tournamentName);
  } else {
    // Generate unique org ID for unnamed tournament (includes timestamp + random)
    organizationId = generateOrganizationId('');
    console.log('🆔 Generated unique org ID for quick match:', organizationId);
  }
  
  // Check if tournament exists and validate password (only for named tournaments)
  if (firebaseEnabled && db && tournamentName && tournamentName !== '' && tournamentPassword) {
    try {
      // First, check all existing tournaments to ensure name is unique
      const allTournamentsSnapshot = await db.ref('tournaments').once('value');
      const allTournaments = allTournamentsSnapshot.val() || {};
      
      // Check if any tournament has this exact name (case-insensitive)
      let existingTournament = null;
      let existingOrgId = null;
      
      for (const [orgId, tournamentData] of Object.entries(allTournaments)) {
        if (tournamentData.name && tournamentData.name.toLowerCase() === tournamentName.toLowerCase()) {
          existingTournament = tournamentData;
          existingOrgId = orgId;
          break;
        }
      }
      
      if (existingTournament && existingTournament.passwordHash) {
        // Tournament with this name already exists - verify password
        console.log('📋 Tournament "' + tournamentName + '" exists, verifying password...');
        const passwordValid = await verifyPassword(tournamentPassword, existingTournament.passwordHash);
        
        if (!passwordValid) {
          alert('❌ Incorrect password!\n\nA tournament named "' + tournamentName + '" already exists.\n\n• Enter the correct password to add matches\n• OR choose a different tournament name');
          document.getElementById('tournamentPassword').focus();
          return;
        }
        
        // Use the existing tournament's org ID
        organizationId = existingOrgId;
        console.log('✅ Password verified! Using existing tournament org ID:', organizationId);
        alert('✅ Password verified!\n\nAdding your match to existing tournament: "' + tournamentName + '"');
        
      } else {
        // New tournament - create with password
        console.log('🆕 Creating new tournament with password protection...');
        const passwordHash = await hashPassword(tournamentPassword);
        
        // Save tournament metadata to Firebase
        await db.ref('tournaments/' + organizationId).update({
          name: tournamentName,
          passwordHash: passwordHash,
          createdAt: Date.now(),
          createdBy: 'scorer_' + Math.random().toString(36).substr(2, 9)
        });
        
        console.log('✅ New tournament created with password protection');
        alert('✅ Tournament created!\n\n"' + tournamentName + '"\n\nPassword has been set. Share it with your team to allow them to add matches.');
      }
      
    } catch (error) {
      console.error('❌ Error checking tournament:', error);
      alert('⚠️ Error connecting to server.\n\nYour match will be saved locally but may not sync.\n\nError: ' + error.message);
      // Continue anyway for offline functionality
    }
  } else if (!tournamentName || tournamentName === '') {
    // Quick match - no password validation needed
    console.log('🚀 Quick match mode - skipping password/tournament checks');
  }
  
  // Save to localStorage
  localStorage.setItem('cricketbook_org_id', organizationId);
  if (tournamentName) {
    saveTournamentToHistory(tournamentName);
  }
  
  // Generate edit token for this new match
  editToken = generateEditToken();
  canEditMatch = true; // Creator always has edit permission
  console.log('🔐 Generated edit token for match protection');
  
  // Generate match ID based on team names (only if not already set from URL)
  if (!matchId) {
    matchId = generateMatchId(teamA, teamB);
  }
  
  // Save current match session to localStorage for recovery
  saveCurrentMatchSession();
  
  // Track this match in user's all-matches history immediately
  addMatchToUserHistory({
    matchId: matchId,
    organizationId: organizationId,
    teamA: teamA,
    teamB: teamB,
    tournamentName: tournamentName,
    matchType: matchType,
    timestamp: Date.now(),
    isQuickMatch: !tournamentName || tournamentName.trim() === ''
  });
  
  document.getElementById("setup").style.display="none";
  document.getElementById("game").style.display="block";
  matchStarted = true;
  updateUI();
  
  // Initialize Firebase sync for scorer
  console.log("🏏 Match started");
  console.log("📋 Match ID:", matchId);
  console.log("🏆 Organization ID:", organizationId);
  console.log("🔍 Firebase enabled:", firebaseEnabled);
  console.log("🔍 Viewer mode:", isViewerMode);
  console.log("📦 Database object:", db ? "✅ exists" : "❌ null");
  
  if (!isViewerMode && firebaseEnabled) {
    saveMatchState();
    // Viewer tracking removed - simplified for better performance
  }
}

// Viewer tracking functionality removed for simplicity and performance

function endInnings(){
  const inn = currentInnings();
  inn.done = true;
  switchInnings();
}

function switchInnings(){
  if (!inSecond){
    inSecond = true;
    target = first.runs + 1;  // Set global target for second innings
    alert(`End of ${teamA} innings. ${teamB} needs ${target} to win.`);
  } else {
    checkResult(true);
  }
  updateUI();
}

function checkResult(force=false){
  const target = first.runs + 1;
  if (second.runs >= target){
    resultText = `${teamB} won by ${wicketsLimit - second.wkts} wickets`;
    matchCompleted = true;
  } else if (force || second.done || second.legalBalls >= oversLimit*6){
    const runDiff = first.runs - second.runs;
    if (runDiff === 0) {
      resultText = `Match tied! No result.`;
    } else {
      resultText = `${teamA} won by ${runDiff} runs`;
    }
    matchCompleted = true;
  }
}

function resetAll(){
  if (!confirm('⚠️ Are you sure you want to reset the match? All data will be lost and cannot be recovered.')) {
    return;
  }
  
  // Clear localStorage session
  clearCurrentMatchSession();
  console.log('🗑️ Cleared match session from localStorage');
  
  // Clear URL parameters and reload to clean state
  matchStarted = false;
  window.history.replaceState({}, document.title, window.location.pathname);
  location.reload();
}

function startNewMatch(){
  if (!confirm('🆕 Start a new match?\n\nThis will clear the current match and take you back to the setup page.')) {
    return;
  }
  
  // Clear localStorage session
  clearCurrentMatchSession();
  console.log('🗑️ Cleared match session from localStorage');
  
  // Clear URL parameters and reload to clean state
  matchStarted = false;
  window.history.replaceState({}, document.title, window.location.pathname);
  location.reload();
}

// Warn user if they try to close/refresh after match has started
window.addEventListener('beforeunload', function(e) {
  if (matchStarted) {
    e.preventDefault();
    e.returnValue = '';
    return '';
  }
});

// ----------- Export/Share Feature -----------
function getScoreboardText() {
  let message = `📊 MATCH SUMMARY\n`;
  message += `${'='.repeat(15)}\n\n`;
  
  // Match Details
  message += `🏏 Match: ${teamA} vs ${teamB}\n`;
  message += `⚙️ Overs: ${oversLimit} | Wickets: ${wicketsLimit}\n`;
  message += `${'─'.repeat(15)}\n\n`;
  
  // Helper to calculate runs and wickets in an over
  function overRunsAndWkts(arr) {
    let runs = 0, wkts = 0;
    arr.forEach(sym => {
      if (typeof sym === 'string') {
        // Wicket patterns
        if (/^([0-9]+)\+W$/.test(sym)) { runs += parseInt(sym); wkts += 1; }
        else if (/^W$/.test(sym)) { wkts += 1; }
        else if (/^WD\+([0-9]+)\+W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^WD\+([0-9]+)\+W$/)[1]); wkts += 1; }
        else if (/^WD\+W$/.test(sym)) { runs += 1; wkts += 1; }
        else if (/^NB\+([0-9]+)\+W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^NB\+([0-9]+)\+W$/)[1]); wkts += 1; }
        else if (/^NB\+W$/.test(sym)) { runs += 1; wkts += 1; }
        else if (/^B\+([0-9]+)\+W$/.test(sym)) { runs += parseInt(sym.match(/^B\+([0-9]+)\+W$/)[1]); wkts += 1; }
        else if (/^B\+W$/.test(sym)) { wkts += 1; }
        // Old format
        else if (/^([0-9]+)W$/.test(sym)) { runs += parseInt(sym); wkts += 1; }
        else if (/^WD\+([0-9]+)W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^WD\+([0-9]+)W$/)[1]); wkts += 1; }
        else if (/^WDW$/.test(sym)) { runs += 1; wkts += 1; }
        else if (/^NB\+([0-9]+)W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^NB\+([0-9]+)W$/)[1]); wkts += 1; }
        else if (/^NBW$/.test(sym)) { runs += 1; wkts += 1; }
        else if (/^B\+([0-9]+)W$/.test(sym)) { runs += parseInt(sym.match(/^B\+([0-9]+)W$/)[1]); wkts += 1; }
        else if (/^BW$/.test(sym)) { wkts += 1; }
        // Normal balls
        else if (/^[0-9]$/.test(sym)) runs += parseInt(sym);
        else if (/^NB$/.test(sym) || /^WD$/.test(sym)) runs += 1;
        else if (/^NB\+([0-9]+)$/.test(sym)) runs += 1 + parseInt(sym.match(/^NB\+([0-9]+)$/)[1]);
        else if (/^WD\+([0-9]+)$/.test(sym)) runs += 1 + parseInt(sym.match(/^WD\+([0-9]+)$/)[1]);
        else if (/^B\+([0-9]+)$/.test(sym)) runs += parseInt(sym.match(/^B\+([0-9]+)$/)[1]);
        else if (/^LB\+([0-9]+)$/.test(sym)) runs += parseInt(sym.match(/^LB\+([0-9]+)$/)[1]);
      }
    });
    return {runs, wkts};
  }
  
  // Helper to calculate extras
  function calculateExtras(inn) {
    let extras = 0;
    function countExtras(arr) {
      arr.forEach(sym => {
        if (typeof sym === 'string') {
          if (/^WD\+([0-9]+)\+W$/.test(sym)) extras += 1 + parseInt(sym.match(/^WD\+([0-9]+)\+W$/)[1]);
          else if (/^WD\+W$/.test(sym)) extras += 1;
          else if (/^NB\+([0-9]+)\+W$/.test(sym)) extras += 1 + parseInt(sym.match(/^NB\+([0-9]+)\+W$/)[1]);
          else if (/^NB\+W$/.test(sym)) extras += 1;
          else if (/^B\+([0-9]+)\+W$/.test(sym)) extras += parseInt(sym.match(/^B\+([0-9]+)\+W$/)[1]);
          else if (/^NB\+([0-9]+)$/.test(sym)) extras += 1 + parseInt(sym.match(/^NB\+([0-9]+)$/)[1]);
          else if (/^WD\+([0-9]+)$/.test(sym)) extras += 1 + parseInt(sym.match(/^WD\+([0-9]+)$/)[1]);
          else if (sym === 'NB' || sym === 'WD') extras += 1;
          else if (/^B\+([0-9]+)$/.test(sym)) extras += parseInt(sym.match(/^B\+([0-9]+)$/)[1]);
          else if (/^LB\+([0-9]+)$/.test(sym)) extras += parseInt(sym.match(/^LB\+([0-9]+)$/)[1]);
        }
      });
    }
    inn.overs.forEach(countExtras);
    countExtras(inn.curOver);
    return extras;
  }
  
  // FIRST INNINGS
  message += `🟢 FIRST INNINGS - ${teamA}\n\n`;
  const firstOvers = Math.floor(first.legalBalls/6);
  const firstBallsInOver = first.legalBalls % 6;
  const firstRR = first.legalBalls > 0 ? (first.runs * 6 / first.legalBalls).toFixed(2) : '0.00';
  const firstExtras = calculateExtras(first);
  
  message += `Score: ${first.runs}/${first.wkts}\n`;
  message += `Overs: ${firstOvers}.${firstBallsInOver} / ${oversLimit}\n`;
  message += `Run Rate: ${firstRR}\n`;
  message += `Extras: ${firstExtras}\n\n`;
  
  if (first.overs.length > 0 || first.curOver.length > 0 || first.legalBalls > 0) {
    message += `Ball-by-Ball:\n`;
    first.overs.forEach((ov, i) => {
      const {runs, wkts} = overRunsAndWkts(ov);
      message += `Over ${i+1}: ${ov.join(' ')} = ${runs}/${wkts}\n`;
    });
    if (first.curOver.length > 0) {
      const {runs, wkts} = overRunsAndWkts(first.curOver);
      message += `Over ${first.overs.length+1}: ${first.curOver.join(' ')} = ${runs}/${wkts}\n`;
    }
  } else {
    message += `No balls bowled yet.\n`;
  }
  
  message += `\n${'─'.repeat(15)}\n\n`;
  
  // SECOND INNINGS
  if (inSecond || second.legalBalls > 0 || second.curOver.length > 0 || second.overs.length > 0) {
    message += `🔵 SECOND INNINGS - ${teamB}\n\n`;
    const secondOvers = Math.floor(second.legalBalls/6);
    const secondBallsInOver = second.legalBalls % 6;
    const secondRR = second.legalBalls > 0 ? (second.runs * 6 / second.legalBalls).toFixed(2) : '0.00';
    const secondExtras = calculateExtras(second);
    const target = first.runs + 1;
    const needed = Math.max(target - second.runs, 0);
    
    message += `Score: ${second.runs}/${second.wkts}\n`;
    message += `Target: ${target} | Need: ${needed}\n`;
    message += `Overs: ${secondOvers}.${secondBallsInOver} / ${oversLimit}\n`;
    message += `Run Rate: ${secondRR}\n`;
    message += `Extras: ${secondExtras}\n\n`;
    
    if (second.overs.length > 0 || second.curOver.length > 0 || second.legalBalls > 0) {
      message += `Ball-by-Ball:\n`;
      second.overs.forEach((ov, i) => {
        const {runs, wkts} = overRunsAndWkts(ov);
        message += `Over ${i+1}: ${ov.join(' ')} = ${runs}/${wkts}\n`;
      });
      if (second.curOver.length > 0) {
        const {runs, wkts} = overRunsAndWkts(second.curOver);
        message += `Over ${second.overs.length+1}: ${second.curOver.join(' ')} = ${runs}/${wkts}\n`;
      }
    } else {
      message += `No balls bowled yet.\n`;
    }
    
    message += `\n${'─'.repeat(15)}\n\n`;
  }
  
  // MATCH RESULT
  if (resultText) {
    message += `🏆 RESULT\n${resultText}\n\n`;
    message += `${'='.repeat(15)}`;
  } else if (inSecond) {
    message += `⏳ Match in progress...\n\n`;
    message += `${'='.repeat(15)}`;
  } else {
    message += `⏳ First innings in progress...\n\n`;
    message += `${'='.repeat(15)}`;
  }
  
  return message;
}

function exportScoreboard() {
  const text = getScoreboardText();
  // Try Web Share API (for WhatsApp, etc.)
  if (navigator.share) {
    navigator.share({
      title: 'Gully Cricket Scoreboard',
      text: text
    }).catch(()=>{
      // fallback to download
      downloadScoreboard(text);
    });
    return;
  }
  // Try WhatsApp Web
  const waUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
  window.open(waUrl, '_blank');
}

function downloadScoreboard(text) {
  const blob = new Blob([text], {type: 'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'scoreboard.txt';
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }, 100);
}
// --- Robust Wicket Dropdown Logic ---
let wicketDropdownEl = null;
let wicketDropdownOpen = false;

function quickWicket() {
  const inn = currentInnings();
  if (inn.done || pendingExtra || currentMatchOver()) return;
  // Check if wickets limit reached
  if (inn.wkts >= wicketsLimit) {
    alert(`Maximum wickets (${wicketsLimit}) already reached!`);
    return;
  }
  pushUndo();
  let symbol = 'W';
  inn.wkts++;
  addSymbol(inn, symbol);
  commitLegalBall(inn);
  if (inn.wkts >= wicketsLimit) {
    inn.done = true;
    switchInnings();
  }
  if (inSecond) checkResult();
  updateUI();
  closeWicketDropdown();
}

function toggleWicketDropdown(e, btn) {
  e.stopPropagation();
  if (wicketDropdownOpen) {
    closeWicketDropdown();
    return;
  }
  openWicketDropdown(btn);
}

function openWicketDropdown(btn) {
  closeWicketDropdown();
  // Create dropdown if not exists
  if (!wicketDropdownEl) {
    wicketDropdownEl = document.createElement('div');
    wicketDropdownEl.id = 'wicketDropdownGlobal';
    wicketDropdownEl.style.position = 'absolute';
    wicketDropdownEl.style.zIndex = '1000';
    wicketDropdownEl.style.background = '#fff';
    wicketDropdownEl.style.border = '1.5px solid #f59e0b';
    wicketDropdownEl.style.borderRadius = '8px';
    wicketDropdownEl.style.boxShadow = '0 4px 16px rgba(0,0,0,0.13)';
    wicketDropdownEl.style.minWidth = '160px';
    wicketDropdownEl.style.overflow = 'hidden';
    wicketDropdownEl.innerHTML = `<button class="btn btn-extra" style="width:100%;border-radius:0;color:#222;background:#fde047;font-weight:600;font-size:15px;" onclick="showWicketPanel(event);closeWicketDropdown();">Wkt Options...</button>`;
    document.body.appendChild(wicketDropdownEl);
  }
  // Position next to button
  const rect = btn.getBoundingClientRect();
  wicketDropdownEl.style.display = 'block';
  wicketDropdownEl.style.left = (window.scrollX + rect.right - wicketDropdownEl.offsetWidth) + 'px';
  wicketDropdownEl.style.top = (window.scrollY + rect.bottom + 2) + 'px';
  wicketDropdownOpen = true;
  // Listen for outside click/scroll/resize
  setTimeout(()=>{
    document.addEventListener('mousedown', handleWicketDropdownOutside, {once:true});
    window.addEventListener('scroll', closeWicketDropdown, {once:true});
    window.addEventListener('resize', closeWicketDropdown, {once:true});
  }, 0);
}

function closeWicketDropdown() {
  if (wicketDropdownEl) wicketDropdownEl.style.display = 'none';
  wicketDropdownOpen = false;
}
function handleWicketDropdownOutside(ev) {
  if (wicketDropdownEl && ev.target && wicketDropdownEl.contains(ev.target)) return;
  closeWicketDropdown();
}

// Show the wicket panel (from dropdown)
function showWicketPanel(e) {
  if (e) e.stopPropagation();
  closeWicketDropdown();
  const inn = currentInnings();
  if (inn.done || pendingExtra || currentMatchOver()) return;
  // Check if wickets limit reached
  if (inn.wkts >= wicketsLimit) {
    alert(`Maximum wickets (${wicketsLimit}) already reached!`);
    return;
  }
  const deliverySel = document.getElementById('wicketDelivery');
  const runsInput = document.getElementById('wicketRuns');
  const dontCountChk = document.getElementById('wicketNoBallCount');
  deliverySel.value = 'legal';
  runsInput.value = 0;
  dontCountChk.checked = false;
  deliverySel.onchange = function() {
    if (deliverySel.value === 'NB' || deliverySel.value === 'WD') {
      dontCountChk.checked = true;
    } else {
      dontCountChk.checked = false;
    }
  };
  document.getElementById('wicketPanel').style.display = 'block';
  // Disable scoring buttons
  [...document.querySelectorAll('.btn-run, .btn-wkt, .btn-extra, .btn-muted')].forEach(b=> {
    if (b.onclick && (b.onclick.toString().includes('addLegalRun') || 
        b.onclick.toString().includes('quickWicket') || 
        b.onclick.toString().includes('startExtra') ||
        b.onclick.toString().includes('showWicketPanel') ||
        b.onclick.toString().includes('showMoreOptions') ||
        b.onclick.toString().includes('showWicketExtraModal'))) {
      b.disabled = true;
    }
  });
}

// Show modal for run out with runs
function showRunOutModal() {
  const inn = currentInnings();
  if (inn.done || pendingExtra || currentMatchOver()) return;
  
  // Check if wickets limit reached
  if (inn.wkts >= wicketsLimit) {
    alert(`Maximum wickets (${wicketsLimit}) already reached!`);
    return;
  }
  
  // Create modal overlay
  const modalOverlay = document.createElement('div');
  modalOverlay.id = 'runOutModalOverlay';
  modalOverlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;';
  modalOverlay.onclick = function(e) {
    if (e.target.id === 'runOutModalOverlay') closeRunOutModal();
  };
  
  // Create modal content
  const modalContent = document.createElement('div');
  modalContent.style.cssText = 'background:white;border-radius:20px;padding:24px;max-width:400px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.4);';
  modalContent.onclick = function(e) { e.stopPropagation(); };
  
  let contentHTML = `
    <h3 style="margin:0 0 16px;font-size:20px;color:#1f2937;text-align:center;">🏃 Run Out</h3>
    
    <div style="margin-bottom:16px;">
      <label style="display:block;font-size:14px;font-weight:600;color:#4b5563;margin-bottom:8px;">Runs completed before run out:</label>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
  `;
  
  // Add run buttons (0, 1, 2, 3)
  [0, 1, 2, 3].forEach(r => {
    contentHTML += `<button onclick="document.getElementById('runOutRuns').value=${r}" style="padding:12px;background:#e5e7eb;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='#d1d5db'" onmouseout="this.style.background='#e5e7eb'">${r}</button>`;
  });
  
  contentHTML += `
      </div>
      <input type="number" id="runOutRuns" min="0" value="0" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:10px;font-size:16px;margin-top:8px;text-align:center;font-weight:600;" />
    </div>
    
    <div style="margin-bottom:16px;">
      <label style="display:block;font-size:14px;font-weight:600;color:#4b5563;margin-bottom:8px;">Run type:</label>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <label style="display:flex;align-items:center;gap:8px;padding:10px;background:#f8fafc;border-radius:10px;cursor:pointer;border:2px solid #e5e7eb;" onclick="document.getElementById('runTypeNormal').checked=true">
          <input type="radio" id="runTypeNormal" name="runType" value="normal" checked style="width:18px;height:18px;">
          <span style="font-size:14px;color:#1f2937;">Normal runs (off bat)</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;padding:10px;background:#f8fafc;border-radius:10px;cursor:pointer;border:2px solid #e5e7eb;" onclick="document.getElementById('runTypeBye').checked=true">
          <input type="radio" id="runTypeBye" name="runType" value="bye" style="width:18px;height:18px;">
          <span style="font-size:14px;color:#1f2937;">Byes (no contact with bat)</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;padding:10px;background:#f8fafc;border-radius:10px;cursor:pointer;border:2px solid #e5e7eb;" onclick="document.getElementById('runTypeLB').checked=true">
          <input type="radio" id="runTypeLB" name="runType" value="lb" style="width:18px;height:18px;">
          <span style="font-size:14px;color:#1f2937;">Leg Byes (off body)</span>
        </label>
      </div>
    </div>
    
    <div style="display:flex;gap:12px;margin-top:20px;">
      <button onclick="closeRunOutModal()" style="flex:1;padding:12px;background:#e5e7eb;color:#1f2937;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;">Cancel</button>
      <button onclick="confirmRunOut()" style="flex:1;padding:12px;background:#ef4444;color:white;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;">Record Run Out</button>
    </div>
  `;
  
  modalContent.innerHTML = contentHTML;
  modalOverlay.appendChild(modalContent);
  document.body.appendChild(modalOverlay);
}

function closeRunOutModal() {
  const modal = document.getElementById('runOutModalOverlay');
  if (modal) modal.remove();
}

function confirmRunOut() {
  const runs = parseInt(document.getElementById('runOutRuns').value) || 0;
  const inn = currentInnings();
  
  if (inn.done || currentMatchOver()) return;
  
  // Get run type
  let runType = 'normal';
  if (document.getElementById('runTypeBye').checked) runType = 'bye';
  else if (document.getElementById('runTypeLB').checked) runType = 'lb';
  
  pushUndo();
  
  // Build symbol based on run type
  let sym;
  if (runs === 0) {
    if (runType === 'bye') sym = 'B+W';
    else if (runType === 'lb') sym = 'LB+W';
    else sym = 'W';
  } else {
    if (runType === 'bye') sym = `B+${runs}+W`;
    else if (runType === 'lb') sym = `LB+${runs}+W`;
    else sym = `${runs}+W`;
  }
  
  // Add symbol to current over
  addSymbol(inn, sym);
  
  // Update runs
  inn.runs += runs;
  
  // Update extras if bye or leg bye
  if (runType === 'bye') {
    inn.extras.b += runs;
  } else if (runType === 'lb') {
    inn.extras.lb += runs;
  }
  
  // Update wickets
  inn.wkts += 1;
  
  // Run out always counts as legal ball
  commitLegalBall(inn);
  
  // Check if innings should end
  if (inn.wkts >= wicketsLimit) {
    inn.done = true;
    switchInnings();
  }
  
  if (inSecond) checkResult();
  
  closeRunOutModal();
  updateUI();
}

// Show modal for selecting LB or BYE
function showByeModal() {
  const inn = currentInnings();
  if (inn.done || currentMatchOver()) return;
  
  // Create modal overlay
  const modalOverlay = document.createElement('div');
  modalOverlay.id = 'byeModalOverlay';
  modalOverlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;';
  modalOverlay.onclick = function(e) {
    if (e.target.id === 'byeModalOverlay') closeByeModal();
  };
  
  // Create modal content
  const modalContent = document.createElement('div');
  modalContent.style.cssText = 'background:white;border-radius:20px;padding:28px;max-width:380px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.4);';
  modalContent.onclick = function(e) { e.stopPropagation(); };
  
  modalContent.innerHTML = `
    <h3 style="margin:0 0 20px;font-size:20px;color:#1f2937;text-align:center;font-weight:800;">Select Extra Type</h3>
    
    <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:20px;">
      <button onclick="selectByeType('LB')" style="padding:16px;background:linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);color:white;border:none;border-radius:12px;font-size:18px;font-weight:800;cursor:pointer;box-shadow:0 4px 12px rgba(99,102,241,0.3);transition:all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
        <div style="font-size:20px;margin-bottom:4px;">LEG BYE</div>
        <div style="font-size:12px;opacity:0.9;font-weight:600;">Ball hits batsman body</div>
      </button>
      
      <button onclick="selectByeType('B')" style="padding:16px;background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);color:white;border:none;border-radius:12px;font-size:18px;font-weight:800;cursor:pointer;box-shadow:0 4px 12px rgba(139,92,246,0.3);transition:all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
        <div style="font-size:20px;margin-bottom:4px;">BYE</div>
        <div style="font-size:12px;opacity:0.9;font-weight:600;">Ball misses everything</div>
      </button>
    </div>
    
    <button onclick="closeByeModal()" style="width:100%;padding:12px;background:#e5e7eb;color:#1f2937;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;">Cancel</button>
  `;
  
  modalOverlay.appendChild(modalContent);
  document.body.appendChild(modalOverlay);
}

function selectByeType(type) {
  closeByeModal();
  startExtra(type);
}

function closeByeModal() {
  const modal = document.getElementById('byeModalOverlay');
  if (modal) modal.remove();
}

// Show help modal with quick tips
function showHelpModal() {
  // Create modal overlay
  const modalOverlay = document.createElement('div');
  modalOverlay.id = 'helpModalOverlay';
  modalOverlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto;';
  modalOverlay.onclick = function(e) {
    if (e.target.id === 'helpModalOverlay') closeHelpModal();
  };
  
  // Create modal content
  const modalContent = document.createElement('div');
  modalContent.style.cssText = 'background:white;border-radius:20px;padding:28px;max-width:500px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.4);max-height:90vh;overflow-y:auto;';
  modalContent.onclick = function(e) { e.stopPropagation(); };
  
  modalContent.innerHTML = `
    <h3 style="margin:0 0 20px;font-size:22px;color:#1f2937;text-align:center;font-weight:800;">🏏 How to Score</h3>
    
    <div style="color:#374151;line-height:1.6;font-size:13px;">
      <div style="margin-bottom:12px;padding:12px;background:linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);border-left:4px solid #3b82f6;border-radius:8px;">
        <div style="font-weight:800;font-size:14px;margin-bottom:5px;color:#1e40af;">📱 Basic Scoring</div>
        <ul style="margin:4px 0;padding-left:18px;font-size:12px;">
          <li><strong>0-6</strong> - Runs scored by batsman</li>
          <li><strong>OUT</strong> - Bowled, caught, LBW, stumped, etc.</li>
          <li><strong>☰ More Options</strong> - Shows RUN OUT, WD+W, NB+W</li>
        </ul>
      </div>
      
      <div style="margin-bottom:12px;padding:12px;background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);border-left:4px solid #f59e0b;border-radius:8px;">
        <div style="font-weight:800;font-size:14px;margin-bottom:5px;color:#92400e;">⚡ Extras & Wickets</div>
        <ul style="margin:4px 0;padding-left:18px;font-size:12px;">
          <li><strong>WD</strong> / <strong>NB</strong> - Then select overthrow runs (+0 to +6)</li>
          <li><strong>LB</strong> (Leg Bye) / <strong>BYE</strong> - Ball didn't hit bat</li>
          <li><strong>WD+W</strong> / <strong>NB+W</strong> - Wide/No Ball with wicket</li>
          <li><strong>RUN OUT</strong> - Dedicated button for run-out scenarios</li>
        </ul>
      </div>
      
      <div style="margin-bottom:12px;padding:12px;background:linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);border-left:4px solid #ec4899;border-radius:8px;">
        <div style="font-weight:800;font-size:14px;margin-bottom:5px;color:#9f1239;">🔄 Match Controls</div>
        <ul style="margin:4px 0;padding-left:18px;font-size:12px;">
          <li><strong>↶ UNDO</strong> - Reverses last action (unlimited)</li>
          <li><strong>🏁 End Innings</strong> - Complete current innings</li>
          <li><strong>🗑️ Delete Match</strong> - Permanently remove match from server & local storage</li>
        </ul>
      </div>
      
      <div style="padding:12px;background:linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);border-left:4px solid #10b981;border-radius:8px;">
        <div style="font-weight:800;font-size:14px;margin-bottom:5px;color:#065f46;">🔗 Sharing</div>
        <ul style="margin:4px 0;padding-left:18px;font-size:12px;">
          <li><strong>Share on WhatsApp</strong> - Get view & edit links</li>
          <li><strong>View Link</strong> - Read-only live scorecard</li>
          <li><strong>Editor Link</strong> - Co-scorers can edit together</li>
          <li><strong>Export/Share</strong> - Download or share scorecard</li>
        </ul>
      </div>
    </div>
    
    <button onclick="closeHelpModal()" style="width:100%;margin-top:18px;padding:12px;background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);color:white;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(59,130,246,0.3);">Got it!</button>
  `;
  
  modalOverlay.appendChild(modalContent);
  document.body.appendChild(modalOverlay);
}

function closeHelpModal() {
  const modal = document.getElementById('helpModalOverlay');
  if (modal) modal.remove();
}

// Show modal for extras with wicket (WD+W, NB+W)
function showWicketExtraModal(extraType) {
  const inn = currentInnings();
  if (inn.done || pendingExtra || currentMatchOver()) return;
  
  // Check if wickets limit reached
  if (inn.wkts >= wicketsLimit) {
    alert(`Maximum wickets (${wicketsLimit}) already reached!`);
    return;
  }
  
  const extraNames = {
    'WD': 'Wide',
    'NB': 'No Ball'
  };
  
  // Create modal overlay
  const modalOverlay = document.createElement('div');
  modalOverlay.id = 'wicketExtraModalOverlay';
  modalOverlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;';
  modalOverlay.onclick = function(e) {
    if (e.target.id === 'wicketExtraModalOverlay') closeWicketExtraModal();
  };
  
  // Create modal content
  const modalContent = document.createElement('div');
  modalContent.style.cssText = 'background:white;border-radius:20px;padding:24px;max-width:400px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.4);';
  modalContent.onclick = function(e) { e.stopPropagation(); };
  
  let contentHTML = `
    <h3 style="margin:0 0 16px;font-size:20px;color:#1f2937;text-align:center;">${extraNames[extraType]} + Wicket</h3>
    
    <div style="margin-bottom:16px;">
      <label style="display:block;font-size:14px;font-weight:600;color:#4b5563;margin-bottom:8px;">Extra runs taken (excluding ${extraType} penalty):</label>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
  `;
  
  // Add run buttons (always 0, 1, 2, 3)
  [0, 1, 2, 3].forEach(r => {
    contentHTML += `<button onclick="document.getElementById('wicketExtraRuns').value=${r}" style="padding:12px;background:#e5e7eb;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='#d1d5db'" onmouseout="this.style.background='#e5e7eb'">${r}</button>`;
  });
  
  contentHTML += `
      </div>
      <input type="number" id="wicketExtraRuns" min="0" value="0" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:10px;font-size:16px;margin-top:8px;text-align:center;font-weight:600;" />
    </div>
  `;
  
  // Add NB ball counting option
  if (extraType === 'NB') {
    contentHTML += `
    <div style="margin-bottom:16px;">
      <label style="display:block;font-size:14px;font-weight:600;color:#4b5563;margin-bottom:8px;">⚙️ Ball counting:</label>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <label style="display:flex;align-items:center;gap:8px;padding:10px;background:#f8fafc;border-radius:10px;cursor:pointer;border:2px solid #e5e7eb;" onclick="document.getElementById('nbCountNo').checked=true">
          <input type="radio" id="nbCountNo" name="nbCount" value="no" checked style="width:18px;height:18px;">
          <span style="font-size:14px;color:#1f2937;">Don't count ball (standard rule)</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;padding:10px;background:#f8fafc;border-radius:10px;cursor:pointer;border:2px solid #e5e7eb;" onclick="document.getElementById('nbCountYes').checked=true">
          <input type="radio" id="nbCountYes" name="nbCount" value="yes" style="width:18px;height:18px;">
          <span style="font-size:14px;color:#1f2937;">Count as legal delivery</span>
        </label>
      </div>
    </div>
    `;
  }
  
  contentHTML += `
    <div style="display:flex;gap:12px;margin-top:20px;">
      <button onclick="closeWicketExtraModal()" style="flex:1;padding:12px;background:#e5e7eb;color:#1f2937;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;">Cancel</button>
      <button onclick="confirmWicketExtra('${extraType}')" style="flex:1;padding:12px;background:#ef4444;color:white;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;">Record Wicket</button>
    </div>
  `;
  
  modalContent.innerHTML = contentHTML;
  modalOverlay.appendChild(modalContent);
  document.body.appendChild(modalOverlay);
}

function closeWicketExtraModal() {
  const modal = document.getElementById('wicketExtraModalOverlay');
  if (modal) modal.remove();
}

function confirmWicketExtra(extraType) {
  const extraRuns = parseInt(document.getElementById('wicketExtraRuns').value) || 0;
  const inn = currentInnings();
  
  if (inn.done || currentMatchOver()) return;
  
  // Check ball counting for NB
  let countBall = true;
  if (extraType === 'NB') {
    const nbCountYes = document.getElementById('nbCountYes');
    countBall = nbCountYes && nbCountYes.checked;
  } else if (extraType === 'WD') {
    countBall = false; // Wide never counts
  } else {
    countBall = true; // Bye/LB always count
  }
  
  pushUndo();
  
  // Build symbol
  let sym;
  if (extraRuns === 0) {
    sym = extraType + '+W';
  } else {
    sym = `${extraType}+${extraRuns}+W`;
  }
  
  // Add symbol to current over
  addSymbol(inn, sym);
  
  // Calculate total runs (add penalty for WD/NB)
  let totalRuns = extraRuns;
  if (extraType === 'WD' || extraType === 'NB') {
    totalRuns += 1; // Add the penalty run
  }
  
  // Update runs
  inn.runs += totalRuns;
  
  // Update extras (track total including penalty for WD/NB)
  if (extraType === 'WD') {
    inn.extras.wd += totalRuns;
  } else if (extraType === 'NB') {
    inn.extras.nb += totalRuns;
  } else if (extraType === 'B') {
    inn.extras.b += extraRuns;
  } else if (extraType === 'LB') {
    inn.extras.lb += extraRuns;
  }
  
  // Update wickets
  inn.wkts += 1;
  
  // Update legal balls if needed
  if (countBall) {
    commitLegalBall(inn);
  }
  
  // Check if innings should end
  if (inn.wkts >= wicketsLimit) {
    inn.done = true;
    switchInnings();
  }
  
  if (inSecond) checkResult();
  
  closeWicketExtraModal();
  updateUI();
}

// Toggle more options menu
function showMoreOptions() {
  const moreRow = document.getElementById('moreRunsRow');
  if (moreRow.style.display === 'none' || !moreRow.style.display) {
    moreRow.style.display = 'block';
  } else {
    moreRow.style.display = 'none';
  }
}

// Show Chart View - Current Innings Summary
function showChartView() {
  const inn = currentInnings();
  const battingTeam = inSecond ? teamB : teamA;
  
  let message = `📊 INNINGS SUMMARY\n`;
  message += `${'='.repeat(15)}\n\n`;
  
  // Match Info
  message += `🏏 ${battingTeam} ${inSecond ? '(2nd Innings)' : '(1st Innings)'}\n`;
  message += `${'─'.repeat(15)}\n\n`;
  
  // Helper to calculate runs and wickets in an over
  function overRunsAndWkts(arr) {
    let runs = 0, wkts = 0;
    arr.forEach(sym => {
      if (typeof sym === 'string') {
        // Wicket patterns
        if (/^([0-9]+)\+W$/.test(sym)) { runs += parseInt(sym); wkts += 1; }
        else if (/^W$/.test(sym)) { wkts += 1; }
        else if (/^WD\+([0-9]+)\+W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^WD\+([0-9]+)\+W$/)[1]); wkts += 1; }
        else if (/^WD\+W$/.test(sym)) { runs += 1; wkts += 1; }
        else if (/^NB\+([0-9]+)\+W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^NB\+([0-9]+)\+W$/)[1]); wkts += 1; }
        else if (/^NB\+W$/.test(sym)) { runs += 1; wkts += 1; }
        else if (/^B\+([0-9]+)\+W$/.test(sym)) { runs += parseInt(sym.match(/^B\+([0-9]+)\+W$/)[1]); wkts += 1; }
        else if (/^B\+W$/.test(sym)) { wkts += 1; }
        // Old format
        else if (/^([0-9]+)W$/.test(sym)) { runs += parseInt(sym); wkts += 1; }
        else if (/^WD\+([0-9]+)W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^WD\+([0-9]+)W$/)[1]); wkts += 1; }
        else if (/^WDW$/.test(sym)) { runs += 1; wkts += 1; }
        else if (/^NB\+([0-9]+)W$/.test(sym)) { runs += 1 + parseInt(sym.match(/^NB\+([0-9]+)W$/)[1]); wkts += 1; }
        else if (/^NBW$/.test(sym)) { runs += 1; wkts += 1; }
        else if (/^B\+([0-9]+)W$/.test(sym)) { runs += parseInt(sym.match(/^B\+([0-9]+)W$/)[1]); wkts += 1; }
        else if (/^BW$/.test(sym)) { wkts += 1; }
        // Normal balls
        else if (/^[0-9]$/.test(sym)) runs += parseInt(sym);
        else if (/^NB$/.test(sym) || /^WD$/.test(sym)) runs += 1;
        else if (/^NB\+([0-9]+)$/.test(sym)) runs += 1 + parseInt(sym.match(/^NB\+([0-9]+)$/)[1]);
        else if (/^WD\+([0-9]+)$/.test(sym)) runs += 1 + parseInt(sym.match(/^WD\+([0-9]+)$/)[1]);
        else if (/^B\+([0-9]+)$/.test(sym)) runs += parseInt(sym.match(/^B\+([0-9]+)$/)[1]);
        else if (/^LB\+([0-9]+)$/.test(sym)) runs += parseInt(sym.match(/^LB\+([0-9]+)$/)[1]);
      }
    });
    return {runs, wkts};
  }
  
  // Helper to calculate extras
  function calculateExtras(inn) {
    let extras = 0;
    function countExtras(arr) {
      arr.forEach(sym => {
        if (typeof sym === 'string') {
          if (/^WD\+([0-9]+)\+W$/.test(sym)) extras += 1 + parseInt(sym.match(/^WD\+([0-9]+)\+W$/)[1]);
          else if (/^WD\+W$/.test(sym)) extras += 1;
          else if (/^NB\+([0-9]+)\+W$/.test(sym)) extras += 1 + parseInt(sym.match(/^NB\+([0-9]+)\+W$/)[1]);
          else if (/^NB\+W$/.test(sym)) extras += 1;
          else if (/^B\+([0-9]+)\+W$/.test(sym)) extras += parseInt(sym.match(/^B\+([0-9]+)\+W$/)[1]);
          else if (/^NB\+([0-9]+)$/.test(sym)) extras += 1 + parseInt(sym.match(/^NB\+([0-9]+)$/)[1]);
          else if (/^WD\+([0-9]+)$/.test(sym)) extras += 1 + parseInt(sym.match(/^WD\+([0-9]+)$/)[1]);
          else if (sym === 'NB' || sym === 'WD') extras += 1;
          else if (/^B\+([0-9]+)$/.test(sym)) extras += parseInt(sym.match(/^B\+([0-9]+)$/)[1]);
          else if (/^LB\+([0-9]+)$/.test(sym)) extras += parseInt(sym.match(/^LB\+([0-9]+)$/)[1]);
        }
      });
    }
    inn.overs.forEach(countExtras);
    countExtras(inn.curOver);
    return extras;
  }
  
  // Current Score
  const overs = Math.floor(inn.legalBalls/6);
  const ballsInOver = inn.legalBalls % 6;
  const rr = inn.legalBalls > 0 ? (inn.runs * 6 / inn.legalBalls).toFixed(2) : '0.00';
  const extras = calculateExtras(inn);
  
  message += `📈 Score: ${inn.runs}/${inn.wkts}\n`;
  message += `⏱️ Overs: ${overs}.${ballsInOver} / ${oversLimit}\n`;
  message += `📊 Run Rate: ${rr}\n`;
  message += `➕ Extras: ${extras}\n`;
  
  // Target info for second innings
  if (inSecond) {
    const target = first.runs + 1;
    const needed = Math.max(target - inn.runs, 0);
    const ballsLeft = (oversLimit * 6) - inn.legalBalls;
    const reqRR = ballsLeft > 0 ? (needed * 6 / ballsLeft).toFixed(2) : '0.00';
    message += `🎯 Target: ${target} | Need: ${needed}\n`;
    message += `📉 Required RR: ${reqRR}\n`;
  }
  
  message += `\n${'─'.repeat(10)}\n`;
  message += `🏏 BALL-BY-BALL\n`;
  message += `${'─'.repeat(10)}\n\n`;
  
  // Ball-by-Ball Details
  if (inn.overs.length > 0 || inn.curOver.length > 0 || inn.legalBalls > 0) {
    inn.overs.forEach((ov, i) => {
      const {runs, wkts} = overRunsAndWkts(ov);
      message += `Over ${i+1}: ${ov.join(' ')} = ${runs}/${wkts}\n`;
    });
    if (inn.curOver.length > 0) {
      const {runs, wkts} = overRunsAndWkts(inn.curOver);
      message += `Over ${inn.overs.length+1}: ${inn.curOver.join(' ')} = ${runs}/${wkts}\n`;
    }
  } else {
    message += `No balls bowled yet.\n`;
  }
  
  message += `\n${'='.repeat(10)}`;
  
  // Match result if available
  if (resultText) {
    message += `\n\n🏆 ${resultText}`;
  }
  
  alert(message);
}

// ========== Saved Matches Management ==========

async function refreshSavedMatches() {
  const allMatches = loadAllMatchSessions();
  const section = document.getElementById('savedMatchesSection');
  const listDiv = document.getElementById('savedMatchesList');
  
  if (!allMatches || allMatches.length === 0) {
    section.style.display = 'none';
    return;
  }
  
  // Filter out completed matches (those with results declared) AND matches with missing data
  const incompleteMatches = allMatches.filter(match => {
    // Hide if match is marked as completed
    if (match.matchCompleted) {
      return false;
    }
    
    // Hide if there's a result text (match finished)
    if (match.resultText && match.resultText.trim() !== '') {
      return false;
    }
    
    // Hide if missing critical data (organizationId, matchId, or editToken)
    if (!match.organizationId || !match.matchId || !match.editToken) {
      console.warn('⚠️ Skipping match with missing data:', match);
      return false;
    }
    
    // Hide if missing team names
    if (!match.teamA || !match.teamB) {
      console.warn('⚠️ Skipping match with missing team names:', match);
      return false;
    }
    
    // Show match if it's still in progress and has all required data
    return true;
  });
  
  // If no incomplete matches, hide section
  if (incompleteMatches.length === 0) {
    section.style.display = 'none';
    return;
  }
  
  // Show section
  section.style.display = 'block';
  
  // Fetch live data from Firebase for each match
  const liveMatchesPromises = incompleteMatches.map(async (match) => {
    if (!db || !match.organizationId || !match.matchId) {
      return match; // Return original if Firebase not available
    }
    
    try {
      // Try tournament path first
      let snapshot = await db.ref(`tournaments/${match.organizationId}/matches/${match.matchId}`).once('value');
      let liveData = snapshot.val();
      
      // If not found, try quick matches path
      if (!liveData) {
        snapshot = await db.ref(`quickMatches/${match.organizationId}/matches/${match.matchId}`).once('value');
        liveData = snapshot.val();
      }
      
      // Merge live data with stored match data
      if (liveData) {
        const updatedMatch = {
          ...match,
          first: liveData.first || match.first,
          second: liveData.second || match.second,
          inSecond: liveData.inSecond !== undefined ? liveData.inSecond : match.inSecond,
          lastUpdated: liveData.lastUpdated || match.lastUpdated,
          matchCompleted: liveData.matchCompleted || false,
          resultText: liveData.resultText || ''
        };
        
        // Update localStorage with latest completion status
        if (liveData.matchCompleted || (liveData.resultText && liveData.resultText.trim() !== '')) {
          // Match is now completed - remove from localStorage
          console.log('🏁 Match completed, removing from saved matches:', match.matchId);
          removeMatchFromHistory(match.matchId);
          return null; // Return null to filter out later
        }
        
        return updatedMatch;
      }
    } catch (error) {
      console.warn('⚠️ Could not fetch live data for match:', match.matchId, error);
    }
    
    return match; // Return original if fetch failed
  });
  
  // Wait for all live data to be fetched
  const liveMatches = (await Promise.all(liveMatchesPromises)).filter(m => m !== null); // Filter out completed matches
  
  // If all matches are now completed, hide section
  if (liveMatches.length === 0) {
    section.style.display = 'none';
    return;
  }
  
  // Helper function to calculate time ago
  function getTimeAgo(timestamp) {
    const hoursSince = Math.floor((Date.now() - timestamp) / (1000 * 60 * 60));
    const minutesSince = Math.floor((Date.now() - timestamp) / (1000 * 60));
    const daysSince = Math.floor(hoursSince / 24);
    
    if (daysSince > 0) {
      return `${daysSince} day${daysSince > 1 ? 's' : ''} ago`;
    } else if (hoursSince > 0) {
      return `${hoursSince} hour${hoursSince > 1 ? 's' : ''} ago`;
    } else {
      return `${minutesSince} minute${minutesSince > 1 ? 's' : ''} ago`;
    }
  }
  
  // Build match rows with live data (2-column compact layout)
  const matchesHtml = liveMatches.map((match, index) => {
    const timeAgo = getTimeAgo(match.timestamp);
    
    // Calculate current scores
    const firstScore = `${match.first?.runs || 0}/${match.first?.wkts || 0}`;
    const secondScore = `${match.second?.runs || 0}/${match.second?.wkts || 0}`;
    const firstOvers = match.first?.legalBalls ? `${Math.floor(match.first.legalBalls / 6)}.${match.first.legalBalls % 6}` : '0.0';
    const secondOvers = match.second?.legalBalls ? `${Math.floor(match.second.legalBalls / 6)}.${match.second.legalBalls % 6}` : '0.0';
    
    return `
      <div style="border:2px solid #e2e8f0;border-radius:12px;padding:12px;background:linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);margin-bottom:10px;">
        <div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin-bottom:10px;">
          <div>
            <div style="font-size:15px;font-weight:700;color:#1f2937;margin-bottom:6px;">
              ${match.teamA} <span style="color:#3b82f6;font-size:13px;">vs</span> ${match.teamB}
            </div>
            <div style="font-size:12px;color:#1f2937;margin-bottom:2px;">
              <span style="font-weight:600;">${match.teamA}:</span> ${firstScore} <span style="color:#64748b;font-size:11px;">(${firstOvers})</span>
            </div>
            <div style="font-size:12px;color:#1f2937;margin-bottom:4px;">
              <span style="font-weight:600;">${match.teamB}:</span> ${secondScore} <span style="color:#64748b;font-size:11px;">(${secondOvers})</span>
            </div>
            <div style="font-size:11px;color:#64748b;">
              📅 ${timeAgo}
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;">
            <button class="btn" onclick="resumeSavedMatchById('${match.matchId}')" style="padding:6px 12px;background:#10b981;font-size:12px;white-space:nowrap;min-width:90px;">
              ✏️ Resume
            </button>
            <button class="btn" onclick="terminateSavedMatchById('${match.matchId}')" style="padding:6px 12px;background:#e31d1d;font-size:12px;white-space:nowrap;min-width:90px;">
              🗑️ Delete
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  listDiv.innerHTML = matchesHtml || '<div style="color:#94a3b8;padding:20px;text-align:center;">No saved matches found</div>';
}

function resumeSavedMatchById(matchId) {
  const allMatches = loadAllMatchSessions();
  const match = allMatches.find(m => m.matchId === matchId);
  
  if (!match) {
    alert('❌ Match not found');
    return;
  }
  
  // Log the match details for debugging
  console.log('🔄 Resuming match with details:', {
    organizationId: match.organizationId,
    matchId: match.matchId,
    editToken: match.editToken,
    teamA: match.teamA,
    teamB: match.teamB
  });
  
  // Build URL with edit token and reload
  const resumeUrl = `scorer.html?org=${match.organizationId}&match=${match.matchId}&edit=${match.editToken}`;
  console.log('🔄 Resuming match URL:', resumeUrl);
  window.location.href = resumeUrl;
}

function resumeSavedMatch() {
  const savedSession = loadCurrentMatchSession();
  if (!savedSession) {
    alert('❌ No saved match found');
    return;
  }
  
  // Build URL with edit token and reload
  const resumeUrl = `scorer.html?org=${savedSession.organizationId}&match=${savedSession.matchId}&edit=${savedSession.editToken}`;
  console.log('🔄 Resuming match:', resumeUrl);
  window.location.href = resumeUrl;
}

function deleteCurrentMatch() {
  if (!matchId) {
    alert('❌ No match is currently loaded');
    return;
  }
  
  if (!confirm('⚠️ Delete this match permanently?\n\n' + teamA + ' vs ' + teamB + '\n\nThis will:\n✗ Remove from Firebase server\n✗ Delete all match data\n✗ Clear from local storage\n\n⚠️ This action cannot be undone!')) {
    return;
  }
  
  console.log('🗑️ Starting deletion for match:', matchId, 'org:', organizationId);
  
  // Show deleting message
  const deletingMsg = document.createElement('div');
  deletingMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(220,38,38,0.95);color:white;padding:20px 30px;border-radius:12px;font-size:16px;font-weight:700;z-index:10000;box-shadow:0 10px 40px rgba(0,0,0,0.3);';
  deletingMsg.textContent = '🗑️ Deleting match...';
  document.body.appendChild(deletingMsg);
  
  // Check if Firebase is enabled
  if (!firebaseEnabled || !db) {
    console.log('⚠️ Firebase not enabled, deleting from localStorage only');
    removeMatchFromHistory(matchId);
    deletingMsg.remove();
    alert('✅ Match deleted from local storage');
    window.location.href = 'scorer.html';
    return;
  }
  
  // Ensure organizationId is available
  if (!organizationId) {
    console.error('❌ No organizationId available');
    deletingMsg.remove();
    alert('❌ Error: Cannot delete match - missing organization ID');
    return;
  }
  
  // Delete from Firebase - check both tournament and quick match paths
  const tournamentPath = 'tournaments/' + organizationId + '/matches/' + matchId;
  const quickMatchPath = 'quickMatches/' + organizationId + '/matches/' + matchId;
  
  console.log('🔍 Checking paths:', tournamentPath, 'and', quickMatchPath);
  
  // Check both paths and delete from wherever it exists
  Promise.all([
    db.ref(tournamentPath).once('value'),
    db.ref(quickMatchPath).once('value')
  ]).then(([tournamentSnapshot, quickMatchSnapshot]) => {
    const deletePromises = [];
    let foundIn = [];
    
    // Delete from tournament path if exists
    if (tournamentSnapshot.exists()) {
      console.log('✅ Found match in tournament path:', tournamentPath);
      foundIn.push('tournament');
      deletePromises.push(
        db.ref(tournamentPath).remove()
          .then(() => console.log('✅ Successfully deleted from tournament path'))
          .catch(err => console.error('❌ Failed to delete from tournament path:', err))
      );
    } else {
      console.log('⚠️ Match not found in tournament path');
    }
    
    // Delete from quick match path if exists
    if (quickMatchSnapshot.exists()) {
      console.log('✅ Found match in quick match path:', quickMatchPath);
      foundIn.push('quickMatch');
      deletePromises.push(
        db.ref(quickMatchPath).remove()
          .then(() => console.log('✅ Successfully deleted from quick match path'))
          .catch(err => console.error('❌ Failed to delete from quick match path:', err))
      );
    } else {
      console.log('⚠️ Match not found in quick match path');
    }
    
    // If match doesn't exist in Firebase at all
    if (deletePromises.length === 0) {
      console.log('⚠️ Match not found in Firebase, removing from localStorage only');
      removeMatchFromHistory(matchId);
      clearCurrentMatchSession();
      deletingMsg.remove();
      alert('✅ Match deleted from local storage (not found on server)');
      window.location.href = 'scorer.html';
      return;
    }
    
    console.log('🔥 Executing deletions from:', foundIn.join(', '));
    
    // Execute all delete operations
    return Promise.all(deletePromises)
      .then(() => {
        console.log('✅ All Firebase deletions completed successfully');
        removeMatchFromHistory(matchId);
        clearCurrentMatchSession();
        deletingMsg.remove();
        alert('✅ Match deleted successfully!\n\nRemoved from: ' + foundIn.join(' & ') + '\nMatch ID: ' + matchId);
        window.location.href = 'scorer.html';
      });
  }).catch((error) => {
    console.error('❌ Failed to delete match from Firebase:', error);
    deletingMsg.remove();
    // Still remove from localStorage even if Firebase deletion fails
    removeMatchFromHistory(matchId);
    alert('⚠️ Match deleted from local storage, but server deletion failed.\n\nError: ' + error.message);
    window.location.href = 'scorer.html';
  });
}

function terminateSavedMatchById(matchId) {
  if (!confirm('⚠️ Are you sure you want to delete this saved match?\n\nThis will:\n✓ Remove the match from Firebase server\n✓ Clear from local storage\n\nThis action cannot be undone.')) {
    return;
  }
  
  const allMatches = loadAllMatchSessions();
  const matchToDelete = allMatches.find(m => m.matchId === matchId);
  
  if (!matchToDelete) {
    alert('❌ Match not found');
    return;
  }
  
  // Check if Firebase is enabled
  if (!firebaseEnabled || !db) {
    // Just remove from localStorage if Firebase is not enabled
    removeMatchFromHistory(matchId);
    alert('✅ Match deleted from local storage');
    refreshSavedMatches();
    return;
  }
  
  // Delete from Firebase - check both tournament and quick match paths
  const tournamentPath = 'tournaments/' + matchToDelete.organizationId + '/matches/' + matchToDelete.matchId;
  const quickMatchPath = 'quickMatches/' + matchToDelete.organizationId + '/matches/' + matchToDelete.matchId;
  
  // Check both paths and delete from wherever it exists
  Promise.all([
    db.ref(tournamentPath).once('value'),
    db.ref(quickMatchPath).once('value')
  ]).then(([tournamentSnapshot, quickMatchSnapshot]) => {
    const deletePromises = [];
    
    // Delete from tournament path if exists
    if (tournamentSnapshot.exists()) {
      console.log('🗑️ Deleting match from tournament path');
      deletePromises.push(db.ref(tournamentPath).remove());
    }
    
    // Delete from quick match path if exists
    if (quickMatchSnapshot.exists()) {
      console.log('🗑️ Deleting match from quick match path');
      deletePromises.push(db.ref(quickMatchPath).remove());
    }
    
    // If match doesn't exist in Firebase at all
    if (deletePromises.length === 0) {
      console.log('⚠️ Match not found in Firebase, removing from localStorage only');
      removeMatchFromHistory(matchId);
      alert('✅ Match deleted from local storage (not found on server)');
      refreshSavedMatches();
      return;
    }
    
    // Execute all delete operations
    return Promise.all(deletePromises)
      .then(() => {
        console.log('✅ Match deleted from Firebase:', matchToDelete.matchId);
        removeMatchFromHistory(matchId);
        alert('✅ Match deleted successfully from server and local storage');
        refreshSavedMatches();
      });
  }).catch((error) => {
    console.error('❌ Failed to delete match from Firebase:', error);
    // Still remove from localStorage even if Firebase deletion fails
    removeMatchFromHistory(matchId);
    alert('⚠️ Match deleted from local storage, but server deletion failed.\n\nError: ' + error.message);
    refreshSavedMatches();
  });
}

// Helper function to remove a match from history
function removeMatchFromHistory(matchId) {
  try {
    let matchHistory = loadAllMatchSessions();
    matchHistory = matchHistory.filter(m => m.matchId !== matchId);
    localStorage.setItem('cricketbook_match_history', JSON.stringify(matchHistory));
    
    // Also clear current session if it matches
    const currentSession = loadCurrentMatchSession();
    if (currentSession && currentSession.matchId === matchId) {
      localStorage.removeItem('cricketbook_current_session');
    }
    
    console.log('🗑️ Removed match from history:', matchId);
  } catch (error) {
    console.error('❌ Failed to remove match from history:', error);
  }
}

function terminateSavedMatch() {
  if (!confirm('⚠️ Are you sure you want to delete this saved match?\n\nThis will:\n✓ Remove the match from Firebase server\n✓ Clear from local storage\n\nThis action cannot be undone.')) {
    return;
  }
  
  const savedSession = loadCurrentMatchSession();
  if (!savedSession) {
    alert('❌ No saved match found');
    return;
  }
  
  // Use the new function with matchId
  terminateSavedMatchById(savedSession.matchId);
}

// ========== Viewer Mode Initialization ==========

window.addEventListener('DOMContentLoaded', () => {
  // Check for saved session if no URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const hasUrlParams = urlParams.has('org') || urlParams.has('match');
  
  if (!hasUrlParams && !isViewerMode) {
    // Display saved matches section instead of popup
    refreshSavedMatches();
  }
  
  if (isViewerMode) {
    console.log("📺 Viewer mode activated");
    console.log("📋 Watching match ID:", matchId);
    
    // Hide setup screen and show game view
    document.getElementById('setup').style.display = 'none';
    document.getElementById('game').style.display = 'block';
    
    // Hide all scoring buttons
    document.querySelectorAll('.btn-run, .btn-wkt, .btn-extra, .btn-muted, .btn-more').forEach(btn => {
      btn.style.display = 'none';
    });
    
    // Hide action rows
    const actionRows = document.querySelectorAll('#game .row');
    actionRows.forEach(row => {
      const hasButtons = row.querySelector('.btn-run, .btn-wkt, .btn-extra, .btn-muted, .btn-more');
      if (hasButtons) {
        row.style.display = 'none';
      }
    });
    
    // Hide share button if it exists
    const shareBtn = document.getElementById('shareBtn');
    if (shareBtn) shareBtn.style.display = 'none';
    
    // Add viewer badge at the top of scoreboard
    const scoreboard = document.querySelector('.scoreboard');
    if (scoreboard) {
      scoreboard.insertAdjacentHTML('afterbegin', 
        '<div style="text-align:center;padding:10px;background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:white;font-weight:700;font-size:15px;border-radius:10px;margin-bottom:14px;box-shadow:0 4px 12px rgba(16,185,129,0.3);">📺 LIVE VIEWER MODE</div>'
      );
    }
    
    // Start listening for Firebase updates
    if (firebaseEnabled) {
      listenForUpdates();
      console.log("✅ Listening for live match updates");
    } else {
      // Show error message if Firebase not configured
      const scoreboard = document.querySelector('.scoreboard');
      if (scoreboard) {
        scoreboard.insertAdjacentHTML('beforeend', 
          '<div style="text-align:center;padding:12px;background:#fee2e2;color:#991b1b;font-size:14px;border-radius:10px;margin-top:12px;border:1px solid #fecaca;">⚠️ Firebase not configured. Live updates disabled.</div>'
        );
      }
      console.error("❌ Cannot listen for updates - Firebase not configured");
    }
  } else {
    // Scorer mode - check if loading existing match from URL
    const urlOrgId = urlParams.get('org');
    const urlMatchId = urlParams.get('match');
    
    if (urlOrgId && urlMatchId) {
      // Loading existing match from URL
      organizationId = urlOrgId;
      matchId = urlMatchId;
      
      console.log("🔄 Loading existing match from URL");
      console.log("📋 Organization ID:", organizationId);
      console.log("📋 Match ID:", matchId);
      
      if (!firebaseEnabled) {
        console.error("❌ Cannot load match - Firebase is not configured");
        alert("❌ Cannot load match: Firebase is not configured.\n\nPlease configure Firebase to use live scoring features.");
        return;
      }
      
      // Check edit permission and load match
      checkEditPermission().then(() => {
        if (!canEditMatch) {
          console.log("📺 Read-only mode - match is view-only");
        } else {
          console.log("✏️ Edit mode - you can score this match");
        }
        
        // Load match data and start listening
        listenForUpdates();
      });
    } else if (firebaseEnabled) {
      // New match - scorer has full edit rights
      console.log("🏏 Scorer mode - Ready to start new match");
    } else {
      // Firebase not configured and no match to load
      console.warn("⚠️ Firebase not configured - new matches will not be saved to cloud");
    }
  }
});
</script>

<!-- Footer -->
<footer style="text-align:center;padding:24px 0;color:#ffffff;font-size:14px;margin-top:24px;">
  <p style="margin:0 0 8px;">Made with ❤️ for local cricket matches.</p>
  <p style="margin:0 0 8px;opacity:0.9;">© 2026 CricketBook — Realtime Cricket Scoring Tool</p>
  <p style="margin:0;"><a href="https://www.instagram.com/cricketbook.digital/" target="_blank" rel="noopener noreferrer" style="color:white;text-decoration:none;font-weight:600;opacity:0.95;transition:opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.95'">📷 Follow us on Instagram</a></p>
</footer>
<script>
  // Register Service Worker for PWA
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg => console.log('✅ Service Worker registered:', reg.scope))
        .catch(err => console.log('❌ Service Worker registration failed:', err));
    });
  }
</script>

</body>
</html>